{"title":"เจอ Bug ของระบบที่เป็นแบบระเบิดเวลา …","link":"https://www.somkiat.cc/bug-system-failure/","date":1636626050000,"content":"<div id=\"readability-page-1\" class=\"page\"><div id=\"page\"><article><div id=\"content_box\"><header><div><p><time>November 11, 2021</time> <span><a href=\"https://www.somkiat.cc/category/general/\" rel=\"category tag\">เรื่องทั่วไป</a></span></p></div></header><div><figure><img src=\"https://www.somkiat.cc/wp-content/uploads/2021/11/Screen-Shot-2564-11-11-at-17.19.16-1024x562.png\" alt=\"\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2021/11/Screen-Shot-2564-11-11-at-17.19.16-1024x562.png 1024w, https://www.somkiat.cc/wp-content/uploads/2021/11/Screen-Shot-2564-11-11-at-17.19.16-300x165.png 300w, https://www.somkiat.cc/wp-content/uploads/2021/11/Screen-Shot-2564-11-11-at-17.19.16-768x422.png 768w, https://www.somkiat.cc/wp-content/uploads/2021/11/Screen-Shot-2564-11-11-at-17.19.16.png 1051w\" sizes=\"(max-width: 1024px) 100vw, 1024px\"></figure><p>ในช่วง 1-2 วันที่ผ่านมา เจอปัญหาของระบบงานที่อยู่บน production<br>แน่นอนว่า ระบบล่ม เมื่อมีการใช้งานเยอะขึ้น<br>CPU วิ่งไป 100% แบบพุ่งปรี๊ดดด<br>จึงลองดูกันหน่อยว่าจะแก้ไข หรือ ทุเลาลงไปได้อย่างไร ?</p><p><strong>การแก้ไขปัญหาเฉพาะหน้า และ หาต้นเหตุของปัญหา</strong></p><p>การ restart เพื่อหนีปัญหา เป็นทางที่น่าสนใจ และก็ทำ<br>แต่ปัญหาไม่หายไป แค่ทุเลา เพื่อรอการเกิดใหม่<br>การ scale ด้วยการขยายเครื่อง เช่น การเพิ่ม CPU และ Memory ก็ใช้ได้ดี<br>แต่คือการหนีปัญหา<br>การ scale ด้วยการเพิ่มเครื่อง เป็นอีกทาง แต่ทำไม่ได้เลย<br>เนื่องจากระบบไม่ได้ออกแบบมาเพื่อสิ่งนี้ !!</p><p><strong>เมื่อแก้ไขปัญหาเฉพาะหน้าแล้ว ก็มาหาปัญหาและแก้ไขกันหน่อย</strong></p><ul><li>มีการเชื่อมต่อ database ทุก ๆ ครั้งที่เข้าระบบ ไม่ว่าจะต้องดึงข้อมูลจาก database หรือไม่ ตรงนี้โหดมากต้องแก้ไข แต่ยังทำไม่ได้ เพราะว่าต้องแก้ไข code ทั้งระบบ ความเสี่ยงสูง</li><li>ไม่มีการใช้ caching ใด ๆ ต่อ database ตรงอย่างเดียว เช่นเดียวกันต้องแก้ทั้งระบบ ง่ายในการทำแต่เยอะเท่านั้นเอง</li><li>ดูจาก log การใช้งานผ่าน Load balance พบว่ามีส่วนงานจำนวนมาก ที่ทำงานช้ามาก ๆ ตรงนี้คือต้นเหตุแรก !!</li><li>ปัญหาคือใช้งาน database เป็นหลัก ดังนั้น เน้นไปตรงนี้ก่อน</li></ul><p><strong>เมื่อลองไปดู log ก็เจอทันทีว่ามีส่วนงานอะไรที่ช้าบ้าง</strong></p><p>สิ่งที่เจอคือ เมื่อถึงเวลาอันเป็นมงคล CPU ใช้งานทะลุจุดเดือด<br>พุ่งขึ้นไม่มีอาการหรือคำเตือนใด ๆ<br>ระบบล่มแน่นอน !!<br>ก็ต้องกู้คืนให้เร็วที่สุดก่อน</p><p><strong>เมื่อลงไปดูต้นเหตุของปัญหา พบว่า</strong></p><ul><li>ไม่ทำ index ใน table ซึ่งตรงนี้จะยังไม่มีปัญหา ถ้าจำนวนข้อมูลไม่มากพอ และ traffic ไม่มากพอ</li><li>มี operation ที่ทำงาน update ข้อมูลใน database จำนวนมาก ทั้ง ๆ ที่ใน business logic จริง ๆ ไม่ได้ต้องการแบบนั้น เมื่อข้อมูลมากขึ้นเรื่อย ๆ การ update ข้อมูลตามเงื่อนไขของนักพัฒนาก็มากขึ้น และเมื่อถึงวันโชคดีก็โดนกันไป</li></ul><p><strong>นี่คือ ปัญหาที่พบเจอแบบง่าย ๆ</strong><br><strong><em>จะเห็นได้ว่า มันคือ ระเบิดเวลาดี ๆ นี่เอง</em></strong><br>ที่ทีมพัฒนาสร้างมันมากับมือ<br>เมื่อแรกเริ่มเป็นวิธีการที่ถูกต้องมั้ง เพราะว่า ทำงานได้ดี ไม่มีปัญหา<br>แต่เมื่อเงื่อนไขต่าง ๆ ที่จำเป็นมันมาพร้อม<br>ก็ทำให้ระบบล่มเฉย ๆ ได้เลย</p><p><strong>การแก้ไขปัญหาทั้งสองข้อไม่ยาก</strong></p><p>เพียงทำ index ไปซะ และไปเปลี่ยน condition ให้การ update น้อยลงไป<br>จาก update ข้อมูลครั้งละ 10,000-50,000 record ต่อ request<br>แน่นอนว่า ช่วง peak traffic พุ่งสูงมาก !!!<br>หลังจากแก้ไข เหลือ update ข้อมูลครั้งละไม่เกิน 10-20 record เท่านั้น</p><p><strong>แน่นอนว่ายังมีปัญหาอื่น ๆ และที่ยังไม่รู้ รอระเบิดออกมา</strong></p><p>ต้องแก้ไขกันต่อไป<br>ทั้งการ monitor การทำงานของทุก ๆ request ว่าช้าหรือเร็วอย่างไร<br>ทั้งการปรับเปลี่ยนโครงสร้างของ database server<br>ทั้งการปรับเปลี่ยน flow การทำงานของ code<br>ทั้งการนำ caching data เข้ามาช่วย เพื่อลดภาระและค่าใช้จ่ายของ database ลงไป<br>เพื่อช่วยให้ business ยังคงเดินหน้าต่อไปอย่างราบรื่น</p><p><strong>จะเห็นได้ว่า การตัดสินใจใด ๆ ใน architecture ของระบบ</strong></p><p>มันจะส่งผลต่อ business และ customer เสมอ<br>ถ้ามีเป้าหมายเรื่องของการ scale แล้ว<br>ต้องต้องออกแบบ สร้างมันขึ้นมาอย่างเหมาะสมด้วย<br>ที่สำคัญกว่าคือ พร้อมที่จะเปลี่ยนแปลงหรือปรับปรุงให้ดีขึ้นด้วย<br>อีกทั้งถ้าเรามีข้อมูลต่าง ๆ ของระบบในมือ<br>ก็ยิ่งช่วยให้เราง่ายต่อการตัดสินใจอีกด้วย</p></div><div><p><img alt=\"\" src=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=90&amp;d=mm&amp;r=g\" srcset=\"https://secure.gravatar.com/avatar/e5cb9aad7bf4f0e43462bd51d6ff7021?s=180&amp;d=mm&amp;r=g 2x\" height=\"90\" width=\"90\"></p><h4>Article by <a href=\"https://www.facebook.com/somkiatspns\">Somkiat Puisungnoen</a></h4><p>To be Craftmanship</p></div></div></article></div></div>","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"9c5eccde10f900ea2c9c3aa1f77ea7c0a52dafb5455dd6ec53e9529b8207bbcd","category":"Thai"}