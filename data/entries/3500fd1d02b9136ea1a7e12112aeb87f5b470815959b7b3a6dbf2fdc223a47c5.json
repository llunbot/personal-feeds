{"title":"Nomad 1.5 adds single sign-on and dynamic node metadata","link":"https://www.hashicorp.com/blog/nomad-1-5-adds-single-sign-on-and-dynamic-node-metadata","date":1677783600000,"content":"<p>We are excited to announce that the GA release of HashiCorp Nomad 1.5 is now available. <a href=\"https://www.nomadproject.io/\">Nomad</a> is a simple and flexible orchestrator used to deploy and manage containers and non-containerized applications. Nomad works across multiple cloud, on-premises, and edge environments.</p>\n\n<p>Here’s what’s new in Nomad and the Nomad ecosystem:</p>\n\n<ul>\n<li>Single sign-on (SSO) and OIDC support</li>\n<li>Dynamic node metadata</li>\n<li>Task API access</li>\n<li>Job templates</li>\n<li>Access control list (ACL) policies and tokens UI</li>\n</ul>\n\n<h2>Single sign-on and OIDC support</h2>\n<p>Nomad uses an <a href=\"https://developer.hashicorp.com/nomad/tutorials/access-control/access-control?in=nomad%2Faccess-control\">ACL system</a> to control permissions within the cluster. Traditionally, users have accessed Nomad using an <a href=\"https://developer.hashicorp.com/nomad/tutorials/access-control/access-control-tokens?in=nomad%2Faccess-control\">ACL token</a> linked to an <a href=\"https://developer.hashicorp.com/nomad/docs/other-specifications/acl-policy\">ACL policy</a> or <a href=\"https://developer.hashicorp.com/nomad/docs/commands/acl/role/create\">ACL role</a>. Distribution and renewal of these tokens was, until now, something that Nomad administrators had to manage themselves. This could result in users having to create home-grown tooling as well as poor ergonomics for requesting, invalidating, and renewing tokens.</p>\n\n<p>Single sign-on in Nomad 1.5 allows users to sign into Nomad using their identity provider (IDP) of choice. Any OIDC-compliant identity provider will integrate with Nomad 1.5. This includes common IDPs such as <a href=\"https://www.okta.com/\">Okta</a> or <a href=\"https://auth0.com/\">Auth0</a>, major cloud provider identity services such as <a href=\"https://aws.amazon.com/cognito/\">Amazon Cognito</a>, <a href=\"https://cloud.google.com/identity-platform\">Google Identity Platform</a>, and <a href=\"https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/auth-oidc\">Azure Active Directory</a>, and, of course, <a href=\"https://www.vaultproject.io/\">HashiCorp Vault</a>.</p>\n\n<p>Nomad administrators can now spend less time worrying about credential management, and Nomad end users can have a seamless login flow that matches other tools in their organization. Users can log in via the UI or via the CLI using the new <code>nomad login</code> command:</p>\n<p>For details on how to set up SSO in Nomad, see the <a href=\"https://developer.hashicorp.com/nomad/tutorials/single-sign-on\">SSO setup tutorials</a>, view the <a href=\"https://developer.hashicorp.com/nomad/docs/commands/acl/auth-method/create\">documentation on Auth Methods</a>, or see the <a href=\"https://developer.hashicorp.com/nomad/docs/commands/login\"><code>nomad login</code></a> command details.</p>\n\n<h2>Dynamic node metadata</h2>\n\n<p>Nomad client nodes can be configured with arbitrary <a href=\"https://developer.hashicorp.com/nomad/docs/configuration/client#meta\">metadata</a> to help inform scheduling decisions such as adding <a href=\"https://developer.hashicorp.com/nomad/docs/job-specification/constraint\">constraints</a>, <a href=\"https://developer.hashicorp.com/nomad/docs/job-specification/affinity\">affinities</a>, or <a href=\"https://developer.hashicorp.com/nomad/docs/job-specification/spread\">spread</a> blocks to Nomad jobs. Until Nomad 1.5, this metadata had to be static, meaning that it was defined once in the Nomad client config, and any changes to node metadata had to be accompanied by a Nomad client restart.</p>\n\n<p>Now, in Nomad 1.5, metadata can be dynamically modified via the API, CLI, or UI:</p>\n\n<pre><code>nomad node meta apply -node-id aws-t2-622 inodes=127126 custom-key=val\n</code></pre>\n\n<p>This feature gives users more control over scheduling decisions. Dynamic metadata updates can be helpful in a wide variety of situations, such as conditional scheduling based on changes to node-level dependencies, customized node health or resource checks, and scheduling in response to batch jobs that change the configuration of their client node.</p>\n<p>In Nomad 1.5, metadata that has already been specified can be overridden on client nodes, or new metadata keys and values can be added from scratch.</p>\n\n<h2>Task API access</h2>\n\n<p>Some Nomad tasks communicate with the Nomad API. Examples of such jobs include autoscaling controllers, custom <em>operator</em> tasks, and any job that needs to modify dynamic node metadata. Task API access makes it simpler to interact with Nomad from any Nomad Task.</p>\n\n<p>To make it easier for Nomad tasks to communicate with Nomad itself, version 1.5 includes a Unix domain socket (UDS) in tasks. This socket is mounted at <code>${NOMAD_SECRETS_DIR}/api.sock</code>. Requests made over this socket require authentication, which can take the form of a standard Nomad token or a <a href=\"https://developer.hashicorp.com/nomad/docs/concepts/workload-identity\">workload identity token</a>. For example, if you wanted to check an agent’s health from inside an allocation’s environment, you could run the following command:</p>\n\n<pre><code>curl -H \"Authorization: Bearer ${NOMAD_TOKEN}\" --unix-socket \"${NOMAD_SECRETS_DIR}/api.sock\" -v \"localhost/v1/agent/health\"\n</code></pre>\n\n<h2>Job templates</h2>\n\n<p>The Nomad UI and CLI now include job templates to help new Nomad users more quickly learn how to write Nomad jobs. To use a job template, first go to “Run a Job” in the Nomad UI, then click “Choose from a Template” and select your template:</p>\n<p>Nomad automatically includes a template for a simple service job, batch jobs, <a href=\"https://developer.hashicorp.com/nomad/docs/networking/service-discovery\">service discovery</a>, and <a href=\"https://developer.hashicorp.com/nomad/docs/concepts/variables\">Nomad variables</a>. These are meant to help new users learn the basics of writing Nomad job specs. In addition to using these default templates, Nomad administrators can add their own templates and override the provided templates.</p>\n\n<p>These templates are also available from the CLI using the <code>nomad job init</code> command with the new <code>-template</code> and <code>-list-templates flags</code>.</p>\n\n<p><strong>Note:</strong> While job templates are a great tool to get new Nomad users up to speed, for more advanced templating needs we recommend using <a href=\"https://developer.hashicorp.com/nomad/tutorials/nomad-pack/nomad-pack-intro\">Nomad Pack</a> and version-controlled files.</p>\n\n<h2>UI improvements</h2>\n\n<p>The Nomad UI has been updated with new features that make it easier to manage permissions and policies, faster to view task events, and simpler to learn the basics of Nomad jobs.</p>\n\n<h3>ACL policies and tokens UI</h3>\n\n<p>First, the Nomad UI now includes a new <em>Policies</em> section where Nomad administrators can view, create, and update <a href=\"https://developer.hashicorp.com/nomad/docs/other-specifications/acl-policy\">Nomad ACL policies</a>.</p>\n<p>Each policy page also shows the policy’s tokens, allows for the deletion of tokens, shows CLI commands for creating long-lived tokens, and allows for the creation of short-lived test tokens:</p>\n<p>This makes it easier for Nomad administrators to learn how to use the ACL system, know who has which permissions, and keep their Nomad clusters secure.</p>\n\n<h3>Task events in sidebar</h3>\n<p>Additionally, the Nomad UI now includes task events in the logs sidebar for allocations. When examining or debugging an allocation, task events help you understand why an allocation is in its current state. For instance, if authorization failed when downloading a container image, this information would not be surfaced in <code>stderr</code> or <code>stdout</code>, but could be found only in a task event. The sidebar now contains this information, making it even faster to understand the state of each allocation:</p>\n\n<h3>Customizable header</h3>\n<img src=\"https://www.datocms-assets.com/2885/1675809059-dale.jpg\" alt=\"Customizable\" /><h2>More Nomad updates</h2>\n\n<p>Outside of these core improvements, new additions to in Nomad 1.5 and in minor releases since <a href=\"https://www.hashicorp.com/blog/nomad-1-4-adds-nomad-variables-and-updates-service-discovery\">Nomad 1.4 was released</a> include:</p>\n\n<ul>\n<li>The  <a href=\"https://developer.hashicorp.com/nomad/docs/job-specification/job#datacenters\"><code>datacenters</code></a> field in jobspecs is now optional and supports <code>*</code> as a wildcard character.</li>\n<li>New <a href=\"https://developer.hashicorp.com/nomad/docs/commands/tls/ca-create\"><code>nomad tls ca</code></a> and <a href=\"https://developer.hashicorp.com/nomad/docs/commands/tls/cert-create\"><code>nomad tls cert</code></a> commands for more easily creating certificates and self signed certificate authorities.</li>\n<li>A new <a href=\"https://developer.hashicorp.com/nomad/docs/commands/fmt\"><code>fmt</code> command</a> to format configuration, job, and volume files into canonical HCL.</li>\n<li>The ability to <a href=\"https://developer.hashicorp.com/nomad/docs/drivers/exec#command\">run commands from mounted volumes</a> with the <a href=\"https://developer.hashicorp.com/nomad/docs/drivers/exec\">exec driver</a>.</li>\n<li>The ability to specify job IDs in parameterized jobs with a new <a href=\"https://developer.hashicorp.com/nomad/docs/commands/job/dispatch#id-prefix-template\">-id-prefix-template flag</a>.</li>\n<li>The <a href=\"https://developer.hashicorp.com/nomad/docs/commands/job/stop\"><code>nomad job stop</code></a> command can now stop multiple jobs simultaneously.</li>\n<li><a href=\"https://github.com/Masterminds/sprig\">Sprig</a> support added to the <a href=\"https://developer.hashicorp.com/nomad/tutorials/templates/format-output-with-templates\">-t flag</a> to allow for more complex template-based formatting of CLI output.</li>\n<li>New support for <a href=\"https://developer.hashicorp.com/nomad/docs/job-specification/upstreams#config\">Consul Connect upstream configs</a>.</li>\n<li>Maximum size for Nomad Variables increased to 64 KiB.</li>\n<li>A new <a href=\"https://developer.hashicorp.com/nomad/docs/drivers/docker#isolation\"><code>isolation</code></a> flag in the Docker driver, which allows for hyper-v isolation on Windows workloads.</li>\n<li>Improvements to evaluations: a <a href=\"https://developer.hashicorp.com/nomad/api-docs/evaluations#count-evaluations\">new API</a> endpoint for counting evaluations by type, <a href=\"https://github.com/hashicorp/nomad/pull/15117\">faster deletion of evaluations</a>, and <a href=\"https://github.com/hashicorp/nomad/pull/14621\">significantly improved performance when handling large spikes in evaluations</a>, which help protect overall cluster health.</li>\n<li>The new <a href=\"https://developer.hashicorp.com/nomad/docs/commands/operator/client-state\"><code>nomad operator client-state</code></a> command can be used to more quickly get information about a client node.</li>\n<li>Additional UI improvements, including: <a href=\"https://github.com/hashicorp/nomad/pull/14913\">filtering nodes on the topology page</a>, exposing <a href=\"https://github.com/hashicorp/nomad/pull/14833\">if a job is a Pack</a> or <a href=\"https://github.com/hashicorp/nomad/pull/15324\">Connect-enabled</a>, the ability to <a href=\"https://github.com/hashicorp/nomad/pull/14747\">upload jobspec files</a>, and an <a href=\"https://github.com/hashicorp/nomad/pull/15735\">expandable logs sidebar</a>, </li>\n</ul>\n\n<h2>Community updates</h2>\n\n<p>Nomad is committed to being an open source-first project, and we’re always looking for open source contributors. If you’re familiar with Go or interested in learning/honing your Golang skills, we invite you to join the group of Nomad contributors helping to improve the product. </p>\n\n<p>Looking for a place to start? Head to the <a href=\"https://github.com/hashicorp/nomad/contribute\">Nomad contribute page</a> for a curated list of good first issues. If you’re a returning Nomad contributor looking for an interesting problem to solve, take a glance at issues labeled “<a href=\"https://github.com/hashicorp/nomad/issues?q=is%3Aopen+is%3Aissue+label%3Ahelp-wanted\">help-wanted</a>” or “<a href=\"https://github.com/hashicorp/nomad/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22\">good first issue</a>”. For help getting started, check out the <a href=\"https://github.com/hashicorp/nomad/tree/main/contributing\">Nomad contributing documentation</a> or comment directly on the issue with any questions you have. </p>\n\n<p>We also encourage our users to go to the official <a href=\"https://discuss.hashicorp.com/c/nomad/28\">Nomad Community Forums</a> or join us for <a href=\"https://www.hashicorp.com/community/office-hours\">community office hours</a> if they have Nomad questions or feedback. We also would like to thank some of our community members for creating unofficial spaces for Nomad users to connect. Thank you to the communities on <a href=\"https://gitter.im/hashicorp-nomad/Lobby\">Gitter</a> and the <a href=\"https://discord.gg/dF28D6nvEh\">HashiCorp Community Discord</a>.</p>\n\n<h2>Get started with Nomad 1.5</h2>\n\n<p>We encourage you to try out the new features in Nomad 1.5:</p>\n\n<ul>\n<li><a href=\"https://www.nomadproject.io/downloads\">Download Nomad 1.5</a> from the project website.</li>\n<li>Learn more about Nomad with<a href=\"https://learn.hashicorp.com/nomad\"> tutorials on the HashiCorp Learn</a> site.</li>\n<li>Contribute to Nomad by submitting a pull request for a GitHub issue with the “<a href=\"https://github.com/hashicorp/nomad/issues?q=is%3Aopen+is%3Aissue+label%3Ahelp-wanted\">help wanted</a>” or “<a href=\"https://github.com/hashicorp/nomad/issues?q=is%3Aopen+is%3Aissue+label%3A%22good+first+issue%22\">good first issue</a>” label.</li>\n<li><a href=\"https://www.nomadproject.io/community\">Participate in our community</a> forums, office hours, and other events.</li>\n</ul>\n","author":"Mike Nomitch","siteTitle":"HashiCorp Blog","siteHash":"219aa6310b3388f2335eba49871f4df9581f2c58eaeb5e498363b54e835b7001","entryHash":"3500fd1d02b9136ea1a7e12112aeb87f5b470815959b7b3a6dbf2fdc223a47c5","category":"Tech"}