{"title":"Terraform 1.8 provider functions for AWS, Google Cloud, and Kubernetes","link":"https://www.hashicorp.com/blog/terraform-1-8-adds-provider-functions-for-aws-google-cloud-and-kubernetes","date":1712764800000,"content":"<p>Today, we are announcing the general availability of <a href=\"https://developer.hashicorp.com/terraform/plugin/framework/functions/concepts\">provider-defined functions</a> in the AWS, Google Cloud, and Kubernetes providers in conjunction with the <a href=\"https://www.hashicorp.com/blog/terraform-1-8-improves-extensibility-with-provider-defined-functions\">HashiCorp Terraform 1.8</a> launch. This release represents yet another step forward in our unique approach to ecosystem extensibility. Provider-defined functions will allow anyone in the Terraform community to build custom functions within providers and extend the capabilities of Terraform.</p>\n\n<h2>Introducing provider-defined functions</h2>\n\n<p>Previously, users relied on a handful of <a href=\"https://developer.hashicorp.com/terraform/language/functions\">built-in functions</a> in the Terraform configuration language to perform a variety of tasks, including numeric calculations, string manipulations, collection transformations, validations, and other operations. However, the Terraform community needed more capabilities than the built-in functions could offer.  With the release of Terraform 1.8, providers can implement custom functions that you can call from the Terraform configuration. The schema for a function is defined within the provider's schema using the Terraform provider plugin framework.</p>\n\n<p>To use a function, declare the provider as a required_provider in the <code>terraform{}</code> block:</p>\n<pre><code>terraform {\n  required_version = \"&gt;= 1.8.0\"\n  required_providers {\n    time = {\n      source  = \"hashicorp/local\"\n      version = \"2.5.1\"\n    }\n  }\n}</code></pre><p>Provider-defined functions can perform multiple tasks, including:</p>\n\n<ul>\n<li>Transforming existing data</li>\n<li>Parsing combined data into individual, referenceable components</li>\n<li>Building combined data from individual components</li>\n<li>Simplifying validations and assertions</li>\n</ul>\n\n<p>To access a provider-defined function, reference the <code>provider::</code> namespace with the local name of the Terraform Provider. For example, you can use the <code>direxists</code> function by including <code>provider::local::direxists()</code> in your Terraform configuration.</p>\n\n<p>Below you’ll find several examples of new provider-defined functions in the officially supported AWS, Google Cloud, and Kubernetes providers.</p>\n\n<h2>Terraform AWS provider</h2>\n\n<p>The <a href=\"https://github.com/hashicorp/terraform-provider-aws/releases/tag/v5.40.0\">5.40</a> release of the <a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest\">Terraform AWS provider</a> includes its first provider-defined functions to parse and build Amazon Resource Names (ARNs), simplifying Terraform configurations where ARN manipulation is required. The <a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/functions/arn_parse\"><code>arn_parse</code></a> provider-defined function is used to parse an ARN and return an object of individual referenceable components, such as a region or account identifier. For example, to get the AWS account ID from an <a href=\"https://aws.amazon.com/ecr/\">Amazon Elastic Container Registry (ECR)</a> repository, use the <code>arn_parse</code> function to retrieve the account ID and set it as an output:</p>\n<pre><code># create an ECR repository\nresource \"aws_ecr_repository\" \"hashicups\" {\n  name = \"hashicups\"\n  \n  image_scanning_configuration {\n    scan_on_push = true\n  }\n}\n\n# output the account ID of the ECR repository\noutput \"hashicups_ecr_repository_account_id\" {\n  value = provider::aws::arn_parse(aws_ecr_repository.hashicups.arn).account_id\n}\n</code></pre><p>Running <code>terraform apply</code> against the above configuration outputs the AWS Account ID:</p>\n\n<pre><code>Apply complete! Resources: 2 added, 0 changed, 0 destroyed.\n\nOutputs:\n\nhashicups_ecr_repository_account_id = \"751192555662\"\n</code></pre>\n\n<p>Without the <code>arn_parse</code> function, you would need to define and test a combination of built-in Terraform functions to split the ARN and reference the proper index or define a regular expression to match on a substring. The function handles the parsing for you in a concise manner so that you do not have to worry about doing this yourself.</p>\n\n<p>The AWS provider also includes a new <a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/functions/arn_build\"><code>arn_build</code></a> function that builds an ARN from individual attributes and returns it as a string. This provider-defined function can create an ARN that you cannot reference from another resource. For example, you may want to allow another account to pull images from your ECR repository. The <code>arn_build</code> function below constructs an ARN for an IAM policy using an account ID: </p>\n<pre><code># allow another account to pull from the ECR repository\ndata \"aws_iam_policy_document\" \"cross_account_pull_ecr\" {\n  statement {\n    sid    = \"AllowCrossAccountPull\"\n    effect = \"Allow\"\n\n    principals {\n      type = \"AWS\"\n\n      identifiers = [\n        provider::aws::arn_build(\"aws\", \"iam\", \"\", var.cross_account_id, \"root\"),\n      ]\n    }\n\n    actions = [\n      \"ecr:BatchGetImage\",\n      \"ecr:GetDownloadUrlForLayer\",\n    ]\n  }\n}</code></pre><p>The <code>arn_build</code> function helps to guide and simplify the process of combining substrings to form an ARN, and it improves readability compared to using string interpolation. Without it, you'd have to look up the exact ARN structure in the AWS documentation and manually test it.</p>\n\n<h2>Terraform Google Cloud provider</h2>\n\n<p>The <a href=\"https://github.com/hashicorp/terraform-provider-google/blob/main/CHANGELOG.md#5230-apr-1-2024\">5.23</a> release of the <a href=\"https://registry.terraform.io/providers/hashicorp/google/latest/docs\">Terraform Google Cloud provider</a> adds a simplified way to get regions, zones, names, and projects from the IDs of resources that aren’t managed by your Terraform configuration. Provider-defined functions can now help parse Google IDs when adding an IAM binding to a resource that’s managed outside of Terraform:</p>\n<pre><code>resource \"google_cloud_run_service_iam_member\" \"example_run_invoker_jane\" {\n  member   = \"user:jane@example.com\"\n  role     = \"run.invoker\"\n  service  = provider::google::name_from_id(var.example_cloud_run_service_id)\n  location = provider::google::location_from_id(var.example_cloud_run_service_id)\n  project  = provider::google::project_from_id(var.example_cloud_run_service_id)\n}</code></pre><p>The Google Cloud provider also includes a new <code>region_from_zone</code> provider-defined function that helps obtain region names from a given zone (e.g. “us-west1” from “us-west1-a”). This simple string processing could be achieved in multiple ways using Terraform’s built-in functions previously, but the new function simplifies the process:</p>\n<pre><code>locals {\n  zone = “us-central1-a”\n  \n  # ways to derive the region “us-central1” using built-in functions\n  region_1 = join(\"-\", slice(split(\"-\", local.zone), 0, 2))\n  region_2 = substr(local.zone, 0, length(local.zone)-2)\n\n  # our new region_from_zone function makes this easier!\n  region_3 = provider::google::region_from_zone(local.zone)\n}</code></pre><h2>Terraform Kubernetes provider</h2>\n\n<p>The 2.28 release of the <a href=\"https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs\">Terraform Kubernetes provider</a> includes provider-defined functions for encoding and decoding Kubernetes manifests into Terraform, making it easier for practitioners to work with the <a href=\"https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/manifest\"><code>kubernetes_manifest</code></a> resource.</p>\n\n<p>Users that have a Kubernetes manifest in YAML format can use the <code>manifest_decode</code> function to convert it into a Terraform object. The example below shows how to use the <code>manifest_decode</code> function by referring to a Kubernetes manifest in YAML format embedded in the Terraform configuration:</p>\n<pre><code>locals {\n  manifest = &lt;</code></pre><p>If you prefer to decode a YAML file instead of using an embedded YAML format, you can do so by combining the built-in <code>file</code> function with the <code>manifest_decode</code> function.</p>\n<pre><code>$ cat manifest.yaml\n---\nkind: Namespace\napiVersion: v1\nmetadata:\n  name: test\n  labels:\n    name: test</code></pre><pre><code>resource \"kubernetes_manifest\" \"example\" {\n  manifest = provider::kubernetes::manifest_decode(file(\"${path.module}/manifest.yaml\"))\n}</code></pre><p>If your manifest YAML contains multiple Kubernetes resources, you may use the manifest<em>decode</em>multi function to decode them into a list which can then be used with the <code>for_each</code> attribute on the <code>kubernetes_manifest</code> resource:</p>\n<pre><code>$ cat manifest.yaml\n---\nkind: Namespace\napiVersion: v1\nmetadata:\n  name: test-1\n  labels:\n    name: test-1\n---\nkind: Namespace\napiVersion: v1\nmetadata:\n  name: test-2\n  labels:\n    name: test-2\n</code></pre><pre><code>resource \"kubernetes_manifest\" \"example\" {\n  for_each = {\n    for m in provider::kubernetes::manifest_decode_multi(file(\"${path.module}/manifest.yaml\"))):\n    m.metadata.name =&gt; m\n  }\n  manifest = each.value\n}</code></pre><h2>Getting started with provider-defined functions</h2>\n\n<p>Provider-defined functions allow Terraform configurations to become more expressive and readable by declaring practitioner intent and reducing complex, repetitive expressions. To learn about all of the new launch-day provider-defined functions, please review the documentation and changelogs of the aforementioned providers:</p>\n\n<ul>\n<li><a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs\">Terraform AWS provider</a></li>\n<li><a href=\"https://registry.terraform.io/providers/hashicorp/google/latest\">Terraform Google provider</a></li>\n<li><a href=\"https://registry.terraform.io/providers/hashicorp/kubernetes/latest\">Terraform Kubernetes provider</a></li>\n</ul>\n\n<p>Review our <a href=\"https://developer.hashicorp.com/terraform/plugin/framework/functions\">Terraform Plugin Framework documentation</a> to learn more about how provider-defined functions work and how you can make your own. We are thankful to our partners and community members for their valuable contributions to the HashiCorp Terraform ecosystem.</p>\n","author":"Bruno Schaatsbergen","siteTitle":"HashiCorp Blog","siteHash":"219aa6310b3388f2335eba49871f4df9581f2c58eaeb5e498363b54e835b7001","entryHash":"90f3135ef113a9ec03dc021e4f00e963f78a192610be9db6cd3dfa555bd09bb0","category":"Tech"}