{"title":"Terraform 1.9 enhances input variable validations","link":"https://www.hashicorp.com/blog/terraform-1-9-enhances-input-variable-validations","date":1719432000000,"content":"<p>HashiCorp Terraform 1.9 is now generally available, <a href=\"https://developer.hashicorp.com/terraform/downloads\">ready for download</a>, and immediately available for use in <a href=\"https://www.hashicorp.com/products/terraform\">HCP Terraform</a>. Terraform 1.9 includes several new features that have been highly requested by the Terraform community, along with a number of improvements to existing capabilities to enhance developer productivity.</p>\n\n<h2>Cross-object referencing for input variable validations</h2>\n\n<p><a href=\"https://developer.hashicorp.com/terraform/language/expressions/custom-conditions#input-variable-validation\">Input variable validations</a>, first introduced in Terraform 0.13, ensure that input variable values meet specific requirements before execution. This reduces the likelihood of provisioning errors and misconfigurations caused by invalid or unexpected user input and lets Terraform authors create more reliable code while providing clear feedback to users through custom error messages.</p>\n\n<p>Previously, the condition block of an input validation could refer only to the variable itself. With Terraform 1.9, conditions can now refer to other input variables and even to other objects, such as data sources and local values, greatly expanding the kinds of scenarios that authors can validate.</p>\n\n<p>The following example demonstrates a variable validation condition referencing the value of a different variable. Previously, this scenario would require a precondition block on a data source or resource later in the configuration, potentially leading to a partially completed deployment:</p>\n<pre><code>variable \"create_cluster\" {\n  description = \"Whether to create a new cluster.\"\n  type        = bool\n  default     = false\n}\n\nvariable \"cluster_endpoint\" {\n  description = \"Endpoint of the existing cluster to use.\"\n  type        = string\n  default     = \"\"\n\n  validation {\n    condition     = var.create_cluster == false ? length(var.cluster_endpoint) &gt; 0 : true\n    error_message = \"You must specify a value for cluster_endpoint if create_cluster is false.\"\n  }\n}</code></pre><p>If a user attempts to execute this Terraform configuration with <code>create_cluster = false</code> and without providing a value for <code>cluster_endpoint</code>, they will encounter a validation error:</p>\n<pre><code># terraform plan\n\nPlanning failed. Terraform encountered an error while generating this plan.\n\n╷\n│ Error: Invalid value for variable\n│ \n│   on variables.tf line 7:\n│    7: variable \"cluster_endpoint\" {\n│     ├────────────────\n│     │ var.cluster_endpoint is \"\"\n│     │ var.create_cluster is false\n│ \n│ You must specify a value for cluster_endpoint if create_cluster is false.\n│ \n│ This was checked by the validation rule at variables.tf:12,3-13.</code></pre><p>In the next example, a data source is used to dynamically validate the instance type supplied by a user:</p>\n<pre><code>data \"aws_ec2_instance_types\" \"valid\" {\n  filter {\n    name   = \"current-generation\"\n    values = [\"true\"]\n  }\n\n  filter {\n    name   = \"processor-info.supported-architecture\"\n    values = [\"arm64\"]\n  }\n}\n\nvariable \"instance_type\" {\n  description = \"The EC2 instance type to provision.\"\n  type        = string\n\n  validation {\n    condition     = contains(data.aws_ec2_instance_types.valid.instance_types, var.instance_type)\n    error_message = \"You must select a current-generation ARM64 instance type.\"\n  }\n}</code></pre><p>This powerful new feature unlocks many new and dynamic input validation possibilities for Terraform authors to make provisioning workflows more reliable.</p>\n\n<h2>New templatestring function</h2>\n\n<p>Terraform 1.9 also brings a new built-in <a href=\"https://developer.hashicorp.com/terraform/language/functions/templatestring\"><code>templatestring</code></a> function. Similar to the existing <a href=\"https://developer.hashicorp.com/terraform/language/functions/templatefile\"><code>templatefile</code></a> function, <code>templatestring</code> is designed to render templates obtained dynamically, like from a data source result, without having to save it to a file on the local disk. The function takes two parameters: a direct reference to a named string object in the current module, and an object representing the templated variables to interpolate.</p>\n\n<p>The most common use case for this function is to retrieve a template from an external location using a data source, transform it, and pass it to another resource. This example retrieves a Kubernetes resource manifest template from an HTTP location, injects some input variables and resource references, and references it in a <code>kubernetes_manifest</code> resource:</p>\n<pre><code>data \"http\" \"manifest\" {\n  url = \"https://git.democorp.example/repocontent/k8s-templates/ingress-template.yaml\"\n}\n\nlocals {\n  manifest_final = templatestring(data.http.manifest.response_body, {\n    APP_NAME       = var.app_name\n    NAMESPACE      = kubernetes_namespace_v1.example.metadata.0.name\n    SERVICE_NAME   = kubernetes_service_v1.example.metadata.0.name\n    CONTAINER_PORT = var.container_port\n  })\n}\n\nresource \"kubernetes_manifest\" \"example\" {\n  manifest = local.manifest_final\n}</code></pre><h2>Other improvements and next steps</h2>\n\n<p>Terraform 1.9 also brings improvements to existing features:</p>\n\n<ul>\n<li><p>Building on the cross-type refactoring feature <a href=\"https://www.hashicorp.com/blog/terraform-1-8-improves-extensibility-with-provider-defined-functions#refactor-across-resource-types\">introduced in Terraform 1.8</a>, the deprecated <code>null_resource</code> type in the <a href=\"https://registry.terraform.io/providers/hashicorp/null/latest\">hashicorp/null provider</a> can now be refactored directly to the new <a href=\"https://developer.hashicorp.com/terraform/language/resources/terraform-data\"><code>terraform_data</code> resource type</a> using <a href=\"https://developer.hashicorp.com/terraform/language/moved\"><code>moved</code> blocks</a>, allowing authors to seamlessly modernize their code.</p></li>\n<li><p> <code>removed</code> blocks can now declare provisioners that will be executed when the associated resource instances are destroyed. This is useful in cases where you want to remove the resource declaration from your configuration, but still execute the destroy-time provisioner. For example uses, see the <a href=\"https://developer.hashicorp.com/terraform/language/resources/syntax#removing-resources\">Removing Resources documentation</a>.</p></li>\n</ul>\n\n<p>To learn more about all of the enhancements in Terraform 1.9, review the full <a href=\"https://github.com/hashicorp/terraform/releases/tag/v1.9.0\">Terraform 1.9 changelog</a>. To get started with HashiCorp Terraform:</p>\n\n<ul>\n<li><a href=\"https://developer.hashicorp.com/terraform/downloads\">Download Terraform 1.9</a></li>\n<li><a href=\"https://app.terraform.io/public/signup/account\">Sign up for a free HCP Terraform account</a></li>\n<li>Read the <a href=\"https://developer.hashicorp.com/terraform/language/v1.9.x/upgrade-guides\">Terraform 1.9 upgrade guide</a></li>\n<li>Get hands-on with tutorials at <a href=\"https://developer.hashicorp.com/terraform/tutorials\">HashiCorp Developer</a></li>\n</ul>\n\n<p>As always, this release wouldn't have been possible without the great community feedback we've received via GitHub issues, HashiCorp Discuss forums, and from our customers. Thank you!</p>\n","author":"Dan Barr","siteTitle":"HashiCorp Blog","siteHash":"219aa6310b3388f2335eba49871f4df9581f2c58eaeb5e498363b54e835b7001","entryHash":"4249815518fddc57d1fdd96549989ed3537579a0b32174146d46a1895749c090","category":"Tech"}