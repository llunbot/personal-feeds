{"title":"Configure System Integrity Protection (SIP) on Amazon EC2 Mac instances","link":"https://aws.amazon.com/blogs/aws/configure-system-integrity-protection-sip-on-amazon-ec2-mac-instances/","date":1747848991000,"content":"<p>I’m pleased to announce developers can now programmatically disable Apple <a href=\"https://support.apple.com/en-us/102149\">System Integrity Protection (SIP)</a> on their <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-mac-instances.html?trk=4b29643c-e00f-4ab6-ab9c-b1fb47aa1708&amp;sc_channel=blog\">Amazon EC2 Mac</a> instances. System Integrity Protection (SIP), also known as rootless, is a security feature introduced by Apple in <a href=\"https://wikipedia.org/wiki/OS_X_El_Capitan\">OS X El Capitan</a> (2015, version 10.11). It’s designed to protect the system from potentially harmful software by restricting the power of the root user account. SIP is enabled by default on macOS.</p> \n<p>SIP safeguards the system by preventing modification of protected files and folders, restricting access to system-owned files and directories, and blocking unauthorized software from selecting a startup disk. The primary goal of SIP is to address the security risk linked to unrestricted root access, which could potentially allow malware to gain full control of a device with just one password or vulnerability. By implementing this protection, Apple aims to ensure a higher level of security for macOS users, especially considering that many users operate on administrative accounts with weak or no passwords.</p> \n<p>While SIP provides excellent protection against malware for everyday use, developers might occasionally need to temporarily disable it for development and testing purposes. For instance, when creating a new device driver or system extension, disabling SIP is necessary to install and test the code. Additionally, SIP might block access to certain system settings required for your software to function properly. Temporarily disabling SIP grants you the necessary permissions to fine-tune programs for macOS. However, it’s crucial to remember that this is akin to briefly disabling the vault door for authorized maintenance, not leaving it permanently open.</p> \n<p><a href=\"https://developer.apple.com/documentation/security/disabling_and_enabling_system_integrity_protection\">Disabling SIP</a> on a Mac requires physical access to the machine. You have to <a href=\"https://support.apple.com/en-gb/guide/mac-help/mchl82829c17/mac\">restart the machine in recovery mode</a>, then disable SIP with the <code>csrutil</code> command line tool, then restart the machine again.</p> \n<p>Until today, you had to operate with the standard SIP settings on EC2 Mac instances. The physical access requirement and the need to boot in recovery mode made integrating SIP with the Amazon EC2 control plane and EC2 API challenging. But that’s no longer the case! You can now disable and re-enable SIP at will on your Amazon EC2 Mac instances. Let me show you how.</p> \n<p><span><strong>Let’s see how it works<br /> </strong></span>Imagine I have an Amazon EC2 Mac instance started. It’s a <code>mac2-m2.metal</code> instance, running on an Apple silicon M2 processor. Disabling or enabling SIP is as straightforward as calling a new EC2 API: <code>CreateMacSystemIntegrityProtectionModificationTask</code>. This API is asynchronous; it starts the process of changing the SIP status on your instance. You can monitor progress using another new EC2 API: <code>DescribeMacModificationTasks</code>. All I need to know is the instance ID of the machine I want to work with.</p> \n<p><span><strong>Prerequisites<br /> </strong></span>On Apple silicon based EC2 Mac instances and more recent type of machines, before calling the new EC2 API, I must set the <code>ec2-user</code> user password and enable <a href=\"https://support.apple.com/en-gb/guide/deployment/dep24dbdcf9e/web\">secure token</a> for that user on macOS. This requires connecting to the machine and typing two commands in the terminal.</p> \n<pre><code># on the target EC2 Mac instance\n# Set a password for the ec2-user user\n~ % sudo /usr/bin/dscl . -passwd /Users/ec2-user\nNew Password: (MyNewPassw0rd)\n\n# Enable secure token, with the same password, for the ec2-user\n# old password is the one you just set with dscl\n~ % sysadminctl -newPassword MyNewPassw0rd -oldPassword MyNewPassw0rd\n2025-03-05 13:16:57.261 sysadminctl[3993:3033024] Attempting to change password for ec2-user…\n2025-03-05 13:16:58.690 sysadminctl[3993:3033024] SecKeychainCopyLogin returned -25294\n2025-03-05 13:16:58.690 sysadminctl[3993:3033024] Failed to update keychain password (-25294)\n2025-03-05 13:16:58.690 sysadminctl[3993:3033024] - Done\n\n# The error about the KeyChain is expected. I never connected with the GUI on this machine, so the Login keychain does not exist\n# you can ignore this error.  The command below shows the list of keychains active in this session\n~ % security list\n    \"/Library/Keychains/System.keychain\"\n\n# Verify that the secure token is ENABLED\n~ % sysadminctl -secureTokenStatus ec2-user\n2025-03-05 13:18:12.456 sysadminctl[4017:3033614] Secure token is ENABLED for user ec2-user\n</code></pre> \n<p><span><strong>Change the SIP status<br /> </strong></span>I don’t need to connect to the machine to toggle the SIP status. I only need to know its instance ID. I open a terminal on my laptop and use the <a href=\"https://aws.amazon.com/cli/\">AWS Command Line Interface (AWS CLI)</a> to retrieve the Amazon EC2 Mac instance ID.</p> \n<pre><code> aws ec2 describe-instances \\\n         --query \"Reservations[].Instances[?InstanceType == 'mac2-m2.metal' ].InstanceId\" \\\n         --output text\n\ni-012a5de8da47bdff7</code></pre> \n<p>Now, still from the terminal on my laptop, I disable SIP with the <code>create-mac-system-integrity-protection-modification-task</code> command:</p> \n<pre><code>echo '{\"rootVolumeUsername\":\"ec2-user\",\"rootVolumePassword\":\"MyNewPassw0rd\"}' &gt; tmpCredentials\naws ec2 create-mac-system-integrity-protection-modification-task \\\n--instance-id \"i-012a5de8da47bdff7\" \\\n--mac-credentials fileb://./tmpCredentials \\\n--mac-system-integrity-protection-status \"disabled\" &amp;&amp; rm tmpCredentials\n\n{\n    \"macModificationTask\": {\n        \"instanceId\": \"i-012a5de8da47bdff7\",\n        \"macModificationTaskId\": \"macmodification-06a4bb89b394ac6d6\",\n        \"macSystemIntegrityProtectionConfig\": {},\n        \"startTime\": \"2025-03-14T14:15:06Z\",\n        \"taskState\": \"pending\",\n        \"taskType\": \"sip-modification\"\n    }\n}</code></pre> \n<p>After the task is started, I can check its status with the <code>aws ec2 describe-mac-modification-tasks</code> command.</p> \n<pre><code>{\n    \"macModificationTasks\": [\n        {\n            \"instanceId\": \"i-012a5de8da47bdff7\",\n            \"macModificationTaskId\": \"macmodification-06a4bb89b394ac6d6\",\n            \"macSystemIntegrityProtectionConfig\": {\n                \"debuggingRestrictions\": \"\",\n                \"dTraceRestrictions\": \"\",\n                \"filesystemProtections\": \"\",\n                \"kextSigning\": \"\",\n                \"nvramProtections\": \"\",\n                \"status\": \"disabled\"\n            },\n            \"startTime\": \"2025-03-14T14:15:06Z\",\n            \"tags\": [],\n            \"taskState\": \"in-progress\",\n            \"taskType\": \"sip-modification\"\n        },\n...</code></pre> \n<p>The instance initiates the process and a series of reboots, during which it becomes unreachable. This process can take 60–90 minutes to complete. After that, when I see the status in the console becoming available again, I <a href=\"https://community.aws/content/2duUtYq4ENzOLGLdEg0A3aeyCuj/ec2-mac-02-connect-to-an-ec2-mac-instance?lang=en?trk=4b29643c-e00f-4ab6-ab9c-b1fb47aa1708&amp;sc_channel=el\">connect to the machine through SSH or EC2 Instance Connect</a>, as usual.</p> \n<pre><code>➜  ~ ssh ec2-user@54.99.9.99\nWarning: Permanently added '54.99.9.99' (ED25519) to the list of known hosts.\nLast login: Mon Feb 26 08:52:42 2024 from 1.1.1.1\n\n    ┌───┬──┐   __|  __|_  )\n    │ ╷╭╯╷ │   _|  (     /\n    │  └╮  │  ___|\\___|___|\n    │ ╰─┼╯ │  Amazon EC2\n    └───┴──┘  macOS Sonoma 14.3.1\n\n➜  ~ uname -a\nDarwin Mac-mini.local 23.3.0 Darwin Kernel Version 23.3.0: Wed Dec 20 21:30:27 PST 2023; root:xnu-10002.81.5~7/RELEASE_ARM64_T8103 arm64\n\n➜ ~ csrutil --status \nSystem Integrity Protection status: disabled.\n</code></pre> \n<p><span><strong>When to disable SIP<br /> </strong></span>Disabling SIP should be approached with caution because it opens up the system to potential security risks. However, as I mentioned in the introduction of this post, you might need to disable SIP when developing device drivers or kernel extensions for macOS. Some older applications might also not function correctly when SIP is enabled.</p> \n<p>Disabling SIP is also required to turn off Spotlight indexing. Spotlight can help you quickly find apps, documents, emails and other items on your Mac. It’s very convenient on desktop machines, but not so much on a server. When there is no need to index your documents as they change, turning off Spotlight <a href=\"https://eclecticlight.co/2022/12/08/spotlight-problems-mds_stores-and-mdworker-in-trouble/\">will release some CPU cycles and disk I/O</a>.</p> \n<p><span><strong>Things to know<br /> </strong></span>There are a couple of additional things to know about disabling SIP on Amazon EC2 Mac:</p> \n<ul> \n <li>Disabling SIP is available through the API and <a href=\"https://aws.amazon.com/tools/\">AWS SDKs</a>, the <a href=\"https://aws.amazon.com/cli/?trk=4b29643c-e00f-4ab6-ab9c-b1fb47aa1708&amp;sc_channel=blog\">AWS CLI</a>, and the <a href=\"https://console.aws.amazon.com\">AWS Management Console</a>.</li> \n <li>On Apple silicon, the setting is volume based. So if you <a href=\"https://aws.amazon.com/blogs/compute/new-reset-amazon-ec2-mac-instances-to-a-known-state-using-replace-root-volume-capability/?trk=4b29643c-e00f-4ab6-ab9c-b1fb47aa1708&amp;sc_channel=blog\">replace the root volume</a>, you need to disable SIP again. On Intel, the setting is Mac host based, so if you replace the root volume, SIP will still be disabled.</li> \n <li>After disabling SIP, it will be enabled again if you stop and start the instance. Rebooting an instance doesn’t change its SIP status.</li> \n <li>SIP status isn’t transferable between EBS volumes. This means SIP will be disabled again after you restore an instance from an EBS snapshot or if you create an AMI from an instance where SIP is enabled.</li> \n</ul> \n<p>These new APIs are available in <a href=\"https://github.com/aws-samples/amazon-ec2-mac-getting-started/blob/main/ec2-macos.md\">all Regions where Amazon EC2 Mac is available</a>, at no additional cost. Try them today.</p> \n<a href=\"https://linktr.ee/sebsto\">— seb</a> \n<hr /> \n<p>How is the News Blog doing? Take this <a href=\"https://amazonmr.au1.qualtrics.com/jfe/form/SV_eyD5tC5xNGCdCmi\">1 minute survey</a>!</p> \n<p><em>(This <a href=\"https://amazonmr.au1.qualtrics.com/jfe/form/SV_eyD5tC5xNGCdCmi\">survey</a> is hosted by an external company. AWS handles your information as described in the <a href=\"https://aws.amazon.com/privacy/?trk=4b29643c-e00f-4ab6-ab9c-b1fb47aa1708&amp;sc_channel=blog\">AWS Privacy Notice</a>. AWS will own the data gathered via this survey and will not share the information collected with survey respondents.)</em></p>","author":"Sébastien Stormacq","siteTitle":"AWS News Blog","siteHash":"6093e072e4117ec22616e844cb857d03ca62c57a411a8affc77cb5e8b6b15bf6","entryHash":"2ff51ebc20435a1cd5a9560cfe81162eb0ea678d63338940c84bd2fc9c8915e0","category":"Tech"}