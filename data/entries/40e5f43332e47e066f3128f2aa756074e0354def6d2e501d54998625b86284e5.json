{"title":"บันทึกการอ่านเรื่อง How Discord Reduced Websocket Traffic by 40% ?","link":"https://www.somkiat.cc/note-how-discord-reduced-websocket-traffic/","date":1736919746000,"content":"<p><img width=\"150\" height=\"150\" src=\"https://www.somkiat.cc/wp-content/uploads/2025/01/message-pack-150x150.jpg\" alt=\"\" loading=\"lazy\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2025/01/message-pack-150x150.jpg 150w, https://www.somkiat.cc/wp-content/uploads/2025/01/message-pack-75x75.jpg 75w\" /></p>\n<p>บันทึกการอ่านบทความเรื่อง <a href=\"https://discord.com/blog/how-discord-reduced-websocket-traffic-by-40-percent\" target=\"_blank\">How Discord Reduced Websocket Traffic by 40%</a><br />โดยทำการอธิบายแนวทางการลด traffic ของ websocket ลง<br />ซึ่ง websocket นั้นเป็นการติดต่อสื่อสารแบบ realtime ของระบบงานนั่นเอง<br />มาดูกันว่ามีอะไรที่้น่าสนใจบ้าง ?</p>\n\n\n\n<span></span>\n\n\n\n<p><strong>เริ่มด้วยปัญหาที่เกิดขึ้นก่อน</strong></p>\n\n\n\n<p>หลัก ๆ  คือ bandwidth ในระบบ websocket ใช้งานนั้น เยอะมาก ๆ<br />ส่งผลให้การเชื่อมต่อระบบกับ mobile app นั้นช้ามาก ๆ<br />สรุปต้นเหตุของปัญหานี้มาได้ดังนี้</p>\n\n\n\n<ul>\n<li>ข้อมูลที่ส่งไปมา เป็น plain text ในรูปแบบ JSON และมีข้อมูลที่ไม่ได้ใช้จำนวนมาก</li>\n\n\n\n<li>ในการส่งข้อมูลพบว่ามีการส่งข้อมูลซ้ำซ้อนกันเยอะมาก ๆ </li>\n\n\n\n<li>เรื่อง network ของ mobile device ที่มีข้อจำกัด</li>\n</ul>\n\n\n\n<p>จากปัญหาเหล่านี้ จึงเริ่มการแก้ไข เพื่อปรับปรุงระบบให้ดีขึ้น</p>\n\n\n\n<p><strong>วิธีการแก้ไขมีดังนี้</strong></p>\n\n\n\n<p><strong>เปลี่ยนจาก plain text มาเป็น binary format ซึ่งใช้ <a href=\"https://msgpack.org/index.html\" target=\"_blank\">MessagePack</a></strong></p>\n\n\n\n<figure><a href=\"https://www.somkiat.cc/wp-content/uploads/2025/01/message-pack.jpg\"><img src=\"https://www.somkiat.cc/wp-content/uploads/2025/01/message-pack.jpg\" alt=\"\" width=\"491\" height=\"368\" /></a></figure>\n\n\n\n<p>จะเห็นได้ว่าลดขนาดของข้อมูลที่ส่งไปมาได้ประมาณ 35%<br />ในการแก้ไขจะเขียนตัว encode ข้อมูลก่อนส่งและรับจาก websocket<br />แถมส่งผลต่อ latency เพียงเล็กน้อยเท่านั้น</p>\n\n\n\n<p><strong>แต่ยังไม่พอเพียงเท่านี้ ยังทำการบีบอัดข้อมูลให้เล็กลงไปอีก</strong><br />แต่ผลที่ตามมาคือ การใช้งาน CPU สูงขึ้น<br />แต่เมื่อเทียบกับขนาดของข้อมูล และ performance ที่ดีขึ้น<br />ก็ถือว่ายอมรับได้</p>\n\n\n\n<p><strong>ต่อมาก็มาดูที่ข้อมูลที่ส่งไปมา ว่ามีข้อมูลอะไรที่ไม่จำเป็นต่อการใช้งาน</strong><br />ก็ทำการลบทิ้งไป<br />รวมทั้งการส่งข้อมูลเดิมซ้ำ ๆ แล้วมีการจัดเก็บในฝั่ง client อยู่แล้ว<br />ก็จะไม่ส่งซ้ำอีก<br />เช่นในครั้งแรกของการดังข้อมูลและสถานะของผู้ใช้งานว่าเป็นอย่างไร<br />เช่น offline เป็นต้น<br />แต่เมื่อเปลี่ยนสถานะเป็น online ก็ไม่ต้องส่งข้อมูลผู้ใช้งานมาก็ได้<br />ส่งมาเพียง id ก็เพียงพอแล้ว<br />นั่นคือ การส่งข้อมูลของ state ที่เปลี่ยนไปเท่านั้น<br />ช่วยให้ลดขนาดของข้อมูลลงไปได้อีกเยอะแล้ว</p>\n\n\n\n<p><strong>แต่การแก้ไขด้วยวิธีการต่าง ๆ  เหล่านี้ ก็ทำให้เกิดปัญหาตามมาเช่นกัน</strong></p>\n\n\n\n<p>เช่น</p>\n\n\n\n<ul>\n<li>ความซับซ้อนที่สูงขึ้น</li>\n\n\n\n<li>ความเข้ากันได้กับ client ใน version เดิม ซึ่งตรงนี้ก็ต้องค่อย ๆ migrate และ update กันไปด้วย</li>\n\n\n\n<li>การ debug binary data จะยากและซับซ้อนมากยิ่งขึ้น ซึ่งต้องสร้างเครื่องมือมา debug กัน แต่ในการพัฒนาจะให้งานข้อมูล JSON format เพื่อให้เข้าใจได้ง่ายขึ้น ดังนั้นระบบงานจึงต้องมีเรื่องของการ config ให้เปลี่ยนไปมาได้ เป็นอีกเรื่องที่น่าสนใจ</li>\n</ul>\n\n\n\n<p>เป็นอีกเรื่องการแก้ไขปัญหาที่น่าสนใจ<br />ลองศึกษาเพิ่มเติมกันดู</p>\n\n\n\n<p><strong>สรุปแล้วเรื่องของ real time application นั้น จะต้องสนใจในเรื่อง</strong></p>\n\n\n\n<ul>\n<li>รูปแบบของข้อมูลที่ส่งไปมา</li>\n\n\n\n<li>ข้อมูลที่ส่งไปมาเหมาะสมหรือไม่</li>\n\n\n\n<li>เรื่องของการบีบอัดข้อมูลก็ต้องพิจารณา เพราะว่ามีทั้งข้อดีและข้อเสีย</li>\n\n\n\n<li>เรื่องของ compatability สำคัญมาก ๆ ต้องวางแผนให้ดี</li>\n\n\n\n<li>ระบบที่ดีต้องมีระบบ monitoring ที่ดี หรือ การทดสอบที่ดี เพื่อให้เรา detect ปัญหา หรือ จุดคอขวดได้อย่างรวดเร็ว เพื่อแก้ไขปัญหาต่อไป</li>\n</ul>\n","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"40e5f43332e47e066f3128f2aa756074e0354def6d2e501d54998625b86284e5","category":"Thai"}