{"title":"Wide Gamut 2D Graphics using HTML Canvas","link":"https://webkit.org/blog/12058/wide-gamut-2d-graphics-using-html-canvas/","date":1639501235000,"content":"\n<p>Most colors used on the Web today are sRGB colors. These are the colors that you specify with the familiar <code>#rrggbb</code> and <code>rgb(r, g, b)</code> CSS syntax, and whose individual color components are given as values in the range [0, 255]. For example, <code>rgb(255, 0, 0)</code> is the most saturated, pure red in the sRGB color space. But the range of colors in sRGB — its <em>color gamut</em> — does not encompass all colors that can be perceived by the human visual system, and there are displays that can produce a broader range of colors.</p>\n<p>sRGB is based on the color capabilities of computer monitors that existed at the time of its standardization, in the late 1990s. Since then, other, wider gamut color spaces have been defined for use in digital content, and which cover more of the colors that humans can perceive. One such color space is Display P3, which contains colors with significantly higher saturation than sRGB.</p>\n<div>\nThis browser reports that the display does not support Display P3 colors; figures in this post may not appear as intended.\n</div>\n<figure>\n<div>\n    <img src=\"https://webkit.org/wp-content/uploads/pinwheel-sRGB.png\" /> <img src=\"https://webkit.org/wp-content/uploads/pinwheel-Display-P3.png\" />\n  </div><figcaption>Conic gradients showing fully saturated sRGB (left) and Display P3 (right) colors.  Viewed in a browser and on a display supporting Display P3, the colors in the circle on the right will show as more intense than those on the left.  (<a href=\"https://webkit.org/blog-files/wide-gamut-canvas/pinwheels.html\">View as standalone page.</a>)</figcaption></figure>\n<div>For a more in depth introduction to color spaces, see Dean Jackson’s earlier post, <a href=\"https://webkit.org/blog/6682/improving-color-on-the-web/\">Improving Color on the Web</a>.</div>\n<p>Today, there are many computer and mobile devices on the market with displays that can reproduce all the colors of the Display P3 gamut, and the Web platform has been evolving over the last few years to allow authors to make best use of these displays. WebKit has supported wide color images and video since 2016, and last year became <a href=\"https://webkit.org/blog/10042/wide-gamut-color-in-css-with-display-p3/\">the first browser engine to implement the new color syntax</a> defined in <a href=\"https://drafts.csswg.org/css-color-4/\">CSS Color Module Level 4</a> where colors can be specified in a given color space (like <code>color(display-p3 1 0 0)</code>, a fully saturated Display P3 red).</p>\n<p>One notable omission in wide gamut color support, until now, has been in the HTML <code>canvas</code> element. The 2D canvas API was introduced before wide gamut displays were common, and until now has only handled drawing and manipulating sRGB pixel values. Earlier this year, a proposal for creating canvas contexts using other color spaces was added to the HTML standard, and we’ve recently added support for this to WebKit.</p>\n<h2>Drawing on a wide gamut canvas rendering context</h2>\n<p>The <code>getContext</code> method on a <code>canvas</code> element, which is used to create a rendering context object with 2D drawing APIs, accepts a new option to set the canvas backing store’s color space.</p>\n<pre><code><span>&lt;<span>canvas</span> <span>id</span>=<span>\"canvas\"</span> <span>width</span>=<span>\"400\"</span> <span>height</span>=<span>\"300\"</span>&gt;</span><span>&lt;/<span>canvas</span>&gt;</span>\n<span>&lt;<span>script</span>&gt;</span>\nlet canvas = document.getElementById(\"canvas\");\nlet context = canvas.getContext(\"2d\", { colorSpace: \"display-p3\" });\n// ... draw on context ...\n<span>&lt;/<span>script</span>&gt;</span>\n</code></pre>\n<p>The default color space remains sRGB, rather than having the browser automatically use the wider color space, to avoid the performance overhead of color space conversions with existing content. The two explicit color spaces that can be requested are <code>\"srgb\"</code> and <code>\"display-p3\"</code>.</p>\n<p>Fill and stroke styles can be specified using any supported CSS color syntax.</p>\n<pre><code><span>let</span> <span>position</span> <span>=</span> <span>0</span>;\n<span>for</span> (<span>let</span> <span>green</span> <span>of</span> [<span>1</span>, <span>0</span>]) {\n    <span>for</span> (<span>let</span> <span>blue</span> <span>of</span> [<span>1</span>, <span>0</span>]) {\n        <span>for</span> (<span>let</span> <span>red</span> <span>of</span> [<span>1</span>, <span>0</span>]) {\n            <span>context</span>.<span>fillStyle</span> <span>=</span> `<span>color</span>(<span>display</span><span>-</span><span>p3</span> ${<span>red</span>} ${<span>green</span>} ${<span>blue</span>})`;\n            <span>context</span>.<span>fillRect</span>(<span>position</span>, <span>position</span>, <span>40</span>, <span>40</span>);\n            <span>position</span> <span>+</span><span>=</span> <span>20</span>;\n        }\n    }\n}\n</code></pre>\n<figure>\n<div>\n    <img src=\"https://webkit.org/wp-content/uploads/squares-sRGB.png\" /> <img src=\"https://webkit.org/wp-content/uploads/squares-Display-P3.png\" />\n  </div><figcaption>Display P3 colors used as fill styles on an sRGB (left) and Display P3 (right) canvas.  Colors on the left are clamped to remain within the sRGB gamut. (<a href=\"https://webkit.org/blog-files/wide-gamut-canvas/squares.html\">View as standalone page.</a>)</figcaption></figure>\n<p>Any drawing that uses a color outside the color space of the canvas will be clamped so that it is in gamut. For example, filling a rectangle with <code>color(display-p3 1 0 0)</code> on an sRGB canvas will end up using a fully saturated sRGB red. Similarly, drawing on a Display P3 canvas with <code>color(rec2020 0.9 0 0.9)</code>, an almost full magenta in the <a href=\"https://drafts.csswg.org/css-color-4/#predefined-rec2020\">Rec.2020 color space</a>, will result in pixels of approximately <code>color(display-p3 1.0 0 0.923)</code> being used, since that is the closest in the Display P3 color gamut.</p>\n<pre><code><span>const</span> <span>COLORS</span> <span>=</span> [<span>\"#0f0\"</span>, <span>\"color(display-p3 0 1 0)\"</span>];\n<span>for</span> (<span>let</span> <span>y</span> <span>=</span> <span>20</span>; <span>y</span> <span>&lt;</span> <span>180</span>; <span>y</span> <span>+</span><span>=</span> <span>20</span>) {\n    <span>context</span>.<span>fillStyle</span> <span>=</span> <span>COLORS</span>[(<span>y</span> <span>/</span> <span>20</span>) <span>%</span> <span>2</span>];\n    <span>context</span>.<span>fillRect</span>(<span>20</span>, <span>y</span>, <span>160</span>, <span>20</span>);\n}\n</code></pre>\n<figure>\n<div>\n    <img src=\"https://webkit.org/wp-content/uploads/stripes-sRGB.png\" /> <img src=\"https://webkit.org/wp-content/uploads/stripes-Display-P3.png\" />\n  </div><figcaption>Stripes of interleaved Display P3 and sRGB colors on an sRGB (left) and Display P3 (right) canvas.  Because colors are clamped to remain within the gamut of the canvas, the two shades of green are indistinguishable on the sRGB canvas.  (<a href=\"https://webkit.org/blog-files/wide-gamut-canvas/stripes.html\">View as standalone page.</a>)</figcaption></figure>\n<div>\nOn macOS, you can use the <a href=\"https://support.apple.com/guide/colorsync-utility/welcome/mac\">ColorSync Utility</a> to convert color values between sRGB, Display P3, Rec.2020, and some other predefined color spaces.\n</div>\n<p>Wide gamut colors are usable in all canvas drawing primitives:</p>\n<ul>\n<li>as the fill and stroke of rectangles, paths, and text</li>\n<li>in gradient stops</li>\n<li>as a shadow color</li>\n</ul>\n<h2>Pixel manipulation in sRGB and Display P3</h2>\n<p><code>getImageData</code> and <code>putImageData</code> can be used to get and set pixel values on a wide gamut canvas. By default, <code>getImageData</code> will return an <code>ImageData</code> object with pixel values in the color space of the canvas, but it is possible to specify an explicit color space that does not match the canvas, and a conversion will be performed.</p>\n<pre><code><span>let</span> <span>context</span> <span>=</span> <span>canvas</span>.<span>getContext</span>(<span>\"2d\"</span>, { <span>colorSpace</span><span>:</span> <span>\"display-p3\"</span> });\n<span>context</span>.<span>fillStyle</span> <span>=</span> <span>\"color(display-p3 0.5 0 0)\"</span>;\n<span>context</span>.<span>fillRect</span>(<span>0</span>, <span>0</span>, <span>100</span>, <span>100</span>);\n\n<span>let</span> <span>imageData</span>;\n\n<span>// Get ImageData in the canvas color space (Display P3).\n</span><span>imageData</span> <span>=</span> <span>context</span>.<span>getImageData</span>(<span>0</span>, <span>0</span>, <span>1</span>, <span>1</span>);\n<span>console</span>.<span>log</span>(<span>imageData</span>.<span>colorSpace</span>);  <span>// \"display-p3\"\n</span><span>console</span>.<span>log</span>([...<span>imageData</span>.<span>data</span>]);   <span>// [128, 0, 0, 255]\n</span>\n<span>// Get ImageData in Display P3 explicitly.\n</span><span>imageData</span> <span>=</span> <span>context</span>.<span>getImageData</span>(<span>0</span>, <span>0</span>, <span>1</span>, <span>1</span>, { <span>colorSpace</span><span>:</span> <span>\"display-p3\"</span> });\n<span>console</span>.<span>log</span>(<span>imageData</span>.<span>colorSpace</span>);  <span>// \"display-p3\"\n</span><span>console</span>.<span>log</span>([...<span>imageData</span>.<span>data</span>]);   <span>// [128, 0, 0, 255]\n</span>\n<span>// Get ImageData converted to sRGB.\n</span><span>imageData</span> <span>=</span> <span>context</span>.<span>getImageData</span>(<span>0</span>, <span>0</span>, <span>1</span>, <span>1</span>, { <span>colorSpace</span><span>:</span> <span>\"srgb\"</span> });\n<span>console</span>.<span>log</span>(<span>imageData</span>.<span>colorSpace</span>);  <span>// \"srgb\"\n</span><span>console</span>.<span>log</span>([...<span>imageData</span>.<span>data</span>]);   <span>// [141, 0, 0, 255]\n</span></code></pre>\n<p>The <code>ImageData</code> constructor similarly takes an optional options object with a <code>colorSpace</code> key.</p>\n<pre><code><span>let</span> <span>context</span> <span>=</span> <span>canvas</span>.<span>getContext</span>(<span>\"2d\"</span>, { <span>colorSpace</span><span>:</span> <span>\"display-p3\"</span> });\n\n<span>// Create and fill an ImageData with full Display P3 yellow.\n</span><span>let</span> <span>imageData</span> <span>=</span> <span>new</span> <span>ImageData</span>(<span>10</span>, <span>10</span>, { <span>colorSpace</span><span>:</span> <span>\"display-p3\"</span> });\n<span>for</span> (<span>let</span> <span>i</span> <span>=</span> <span>0</span>; <span>i</span> <span>&lt;</span> <span>10</span> <span>*</span> <span>10</span> <span>*</span> <span>4</span>; <span>+</span><span>+</span><span>i</span>)\n    <span>imageData</span>.<span>data</span>[<span>i</span>] <span>=</span> [<span>255</span>, <span>255</span>, <span>0</span>, <span>255</span>][<span>i</span> <span>%</span> <span>4</span>];\n\n<span>context</span>.<span>putImageData</span>(<span>imageData</span>, <span>0</span>, <span>0</span>);\n</code></pre>\n<p>As when drawing shapes using colors of a different color space, any mismatch between the <code>ImageData</code> and the target canvas color space will cause <code>putImageData</code> to perform a conversion and potentially clamp the resulting pixels.</p>\n<h2>Serializing canvas content</h2>\n<p>The <code>toDataURL</code> and <code>toBlob</code> methods on a <code>canvas</code> DOM element produce a raster image with the canvas contents. In WebKit, these methods now embed an appropriate color profile in the generated PNG or JPEG when called on a Display P3 canvas, ensuring that the full range of color is preserved.</p>\n<h2>Drawing wide gamut images</h2>\n<p>Like <code>putImageData</code>, the <code>drawImage</code> method will perform any color space conversion needed when drawing an image whose color space differs from that of the canvas. Any color profile used by a raster image referenced by an <code>img</code>, and any color space information in a video referenced by a <code>video</code> (be it a video file or a WebRTC stream), will be honored when drawn to a canvas. This ensures that when drawing into a canvas whose color space matches the display’s (be that Display P3 or sRGB), the source image/video and the canvas pixels will look the same.</p>\n<p>Here is an interactive demonstration of using canvas to make a sliding tile puzzle. The tiles are drawn by applying a clip path and calling <code>drawImage</code> pointing to the <code>img</code> element on the left, which references a wide gamut JPEG. Toggling the checkbox shows how the colors are muted when an sRGB canvas is used.</p>\n<figure>\n<p></p><figcaption>Sliding tile puzzle. Toggling the checkbox will change whether an sRGB or a Display P3 canvas is used. (<a href=\"https://webkit.org/blog-files/wide-gamut-canvas/puzzle.html\">View as standalone page.</a>)</figcaption></figure>\n<h2>Web Inspector support</h2>\n<p>Web Inspector also now shows color space information for canvases to help ensure your canvases’ backing stores are in the expected color space.</p>\n<figure><img /></figure>\n<p>In the Graphics tab, the Canvases Overview will display the color space for each canvas next to the context type (e.g. 2D) on each canvas overview tile.</p>\n<figure><img /></figure>\n<p>After clicking on a Canvas overview tile to inspect it, the color space is shown in the Details Sidebar in the Attributes section.</p>\n<h2>Browser support</h2>\n<p>Wide gamut canvas is supported in the macOS and iOS ports of WebKit as of <a href=\"https://trac.webkit.org/changeset/283541/webkit\">r283541</a>, and is available in Safari on:</p>\n<ul>\n<li>macOS Monterey 12.1 and above</li>\n<li>iOS 15.1 and above</li>\n</ul>\n<p>Safari is the first browser to support drawing shapes, text, gradients, and shadows with wide gamut CSS colors on Display P3 canvases. All other features, including <code>getImageData</code>, <code>putImageData</code>, and <code>drawImage</code> on Display P3 canvases, are supported in Safari and in Chrome 94 and above.</p>\n<h2>Feature detection</h2>\n<p>There are a few techniques you can use to detect whether wide gamut display and canvas support is available.</p>\n<p><strong>Display support:</strong> To check whether the display supports Display P3 colors, use the <code>color-gamut</code> media query.</p>\n<pre><code><span>function</span> <span>displaySupportsP3Color</span>() {\n    <span>return</span> <span>matchMedia</span>(<span>\"(color-gamut: p3)\"</span>).<span>matches</span>;\n}\n</code></pre>\n<p><strong>Canvas color space support:</strong> To check whether the browser supports wide gamut canvases, try creating one and checking the resulting color space.</p>\n<pre><code><span>function</span> <span>canvasSupportsDisplayP3</span>() {\n    <span>let</span> <span>canvas</span> <span>=</span> <span>document</span>.<span>createElement</span>(<span>\"canvas\"</span>);\n    <span>try</span> {\n        <span>// Safari throws a TypeError if the colorSpace option is supported, but\n</span>        <span>// the system requirements (minimum macOS or iOS version) for Display P3\n</span>        <span>// support are not met.\n</span>        <span>let</span> <span>context</span> <span>=</span> <span>canvas</span>.<span>getContext</span>(<span>\"2d\"</span>, { <span>colorSpace</span><span>:</span> <span>\"display-p3\"</span> });\n        <span>return</span> <span>context</span>.<span>getContextAttributes</span>().<span>colorSpace</span> <span>=</span><span>=</span> <span>\"display-p3\"</span>;\n    } <span>catch</span> {\n    }\n    <span>return</span> <span>false</span>;\n}\n</code></pre>\n<p><strong>CSS Color Module Level 4 syntax support:</strong> To check whether the browser supports specifying wide gamut colors on canvas, try setting one and checking it wasn’t ignored.</p>\n<pre><code><span>function</span> <span>canvasSupportsWideGamutCSSColors</span>() {\n    <span>let</span> <span>context</span> <span>=</span> <span>document</span>.<span>createElement</span>(<span>\"canvas\"</span>).<span>getContext</span>(<span>\"2d\"</span>);\n    <span>let</span> <span>initialFillStyle</span> <span>=</span> <span>context</span>.<span>fillStyle</span>;\n    <span>context</span>.<span>fillStyle</span> <span>=</span> <span>\"color(display-p3 0 1 0)\"</span>;\n    <span>return</span> <span>context</span>.<span>fillStyle</span> <span>!</span><span>=</span> <span>initialFillStyle</span>;\n}\n</code></pre>\n<h2>Future work</h2>\n<p>There are a few areas where wide gamut canvas support could be improved.</p>\n<ul>\n<li>2D canvas still exposes image data as 8 bit RGBA values through <code>ImageData</code> objects. It may be useful to support other pixel formats for a greater color depth, such as 16 bit integers, or single precision or half precision floating point values, especially when wider color gamuts are used, since increased precision can help avoid banding artifacts. This has been proposed in an <a href=\"https://github.com/whatwg/html/issues/4167\">HTML Standard issue</a>.</li>\n<li>The two predefined color spaces that are supported are sRGB and Display P3, but as High Dynamic Range videos and displays that support HDR become more common, it’s worth consdering allowing 2D canvas to use these and other color spaces too. See <a href=\"https://www.w3.org/Graphics/Color/Workshop/slides/talk/cameron\">this presentation at the W3C Workshop on Wide Color Gamut and High Dynamic Range for the Web</a> from earlier this year, which talks about proposed new color space and HDR support.</li>\n<li>Canvas can be used with context types other than 2D, such as WebGL and WebGPU. A proposal for <a href=\"https://www.w3.org/Graphics/Color/Workshop/slides/talk/russell\">wide gamut and HDR support in these contexts</a> was presented at that same workshop.</li>\n</ul>\n<h2>In summary</h2>\n<p>WebKit now has support for creating 2D canvas contexts using the Display P3 color space, allowing authors to make best use of the displays that are becoming increasingly common. This feature is enabled in Safari on macOS Monterey 12.1 and iOS 15.1.</p>\n<p>If you have any comments or questions about the feature, please feel free to send me a message at <a href=\"https://twitter.com/heycam\">@heycam</a>, and more general comments can be sent to the <a href=\"https://twitter.com/webkit\">@webkit</a> Twitter account.</p>\n<h2>Further reading</h2>\n<ul>\n<li><a href=\"https://webkit.org/blog/6682/improving-color-on-the-web/\">Improving Color on the Web</a> (Dean Jackson, WebKit blog)</li>\n<li><a href=\"https://webkit.org/blog/10042/wide-gamut-color-in-css-with-display-p3/\">Wide Gamut Color in CSS with Display-P3</a> (Nikita Vasilyev, WebKit blog)</li>\n<li><a href=\"https://drafts.csswg.org/css-color-4/\">CSS Color Module Level 4</a> (W3C)</li>\n<li><a href=\"https://html.spec.whatwg.org/multipage/canvas.html#2dcontext\">HTML Standard — The 2D rendering context</a> (WHATWG)</li>\n<li><a href=\"https://www.w3.org/Graphics/Color/Workshop/\">W3C Workshop on Wide Color Gamut and High Dynamic Range for the Web</a> (W3C)</li>\n</ul>","author":"","siteTitle":"Blog – WebKit","siteHash":"7f8dbea0b8f53db2e11a2faa08c6dca9954c01638d09a2ce585b77a60d10f7a1","entryHash":"834e7655720f5d0a42cbf1881a967203113e4b4ca0ffe09957ad8239dc1ad28c","category":"Tech"}