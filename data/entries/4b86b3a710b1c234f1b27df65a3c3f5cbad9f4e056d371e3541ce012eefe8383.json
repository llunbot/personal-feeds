{"title":"คำถาม :: Code ทำงานเร็วมาก แต่เมื่อเชื่อมต่อ Database กลับช้า ?","link":"https://www.somkiat.cc/why-database-slow/","date":1739348705000,"content":"<p><img width=\"150\" height=\"150\" src=\"https://www.somkiat.cc/wp-content/uploads/2025/02/slow-01-150x150.jpg\" alt=\"\" loading=\"lazy\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2025/02/slow-01-150x150.jpg 150w, https://www.somkiat.cc/wp-content/uploads/2025/02/slow-01-75x75.jpg 75w\" /></p>\n<figure><a href=\"https://www.somkiat.cc/wp-content/uploads/2025/02/slow-01.jpg\"><img src=\"https://www.somkiat.cc/wp-content/uploads/2025/02/slow-01.jpg\" alt=\"\" width=\"590\" height=\"351\" /></a></figure>\n\n\n\n<p>คำถามที่น่าสนใจในการ review code ของระบบงาน<br />เราทำการเปลี่ยน code มาใช้ภาษาโปรแกรมที่เร็วมาก ๆ แล้ว<br />แต่ทำไมยังช้าอยู่ เมื่อทำการเชื่อมต่อ database !!<br />Database มีทั้ง SQL และ NoSQL<br />โดยที่ code ทำงานเร็วมาก ๆ ในระดับ nano หรือ milisecond กันเลย<br />ส่วน database กลับใช้เวลาการทำงานหลายวินาที !!</p>\n\n\n\n<span></span>\n\n\n\n<p><strong>นั่นหมายความว่าระบบงานของเราจะตันที่ Database (bottleneck)</strong></p>\n\n\n\n<p>แล้วมันเกิดจากอะไรบ้าง ?<br />เพื่อที่จะแก้ไขได้อย่างถูกต้อง</p>\n\n\n\n<ul>\n<li>Database นั้นมักจะทำการอ่านและเขียนข้อมูลจาก disk และผ่านระบบ network ดังนั้น disk ต้องเร็ว network ต้องเยอะ</li>\n\n\n\n<li>Business logic ที่ซับซ้อน</li>\n\n\n\n<li>มีการใช้งาน CPU เยอะ</li>\n\n\n\n<li>ในการ query ข้อมูล มี lock CPU เยอะ</li>\n\n\n\n<li>ในการ query ข้อมูล ใช้ memory เยอะ เนื่องจากข้อมูลเยอะ ยิ่งนานไปยิ่งช้า ไม่ทำ index ที่เหมาะสม</li>\n\n\n\n<li>ในการ query ข้อมูล มีข้อมูลเยอะเกินไป มีการ join มากเกินไปไหม หรือ บางข้อมูลไม่ได้ใช้ก็ดึงออกมา มันเปลือง</li>\n\n\n\n<li>ในการ query ต่าง ๆ จำเป็นต้องทำการ explain หรือ ตรวจสอบ cost หรือ resource ที่ต้องใช้งาน รวมทั้งระบบ monitoring ที่ดี เพื่อดู query ต่าง ๆ ว่าใช้งานอย่างไร ทำงานอย่างไร และมี slow query ตรงไหนบ้าง</li>\n\n\n\n<li>ถ้าข้อมูลเยอะขึ้น แล้วส่งผลต่อการทำงาน น่าจะต้องทำ sahrding และ partioning เสมอไหม</li>\n\n\n\n<li>ในการ update เยอะ ๆ เกิดการ lock หรือ deadlock ขึ้นมาได้ แนะนำให้ใช้ update/delete in batch จะลดปัญหาลงได้เยอะ</li>\n\n\n\n<li>มีผู้ใช้งานจำนวนสูงขึ้น ทำให้ระบบช้าลง</li>\n\n\n\n<li>Architecture ของ database ไม่เหมาะสมต่อการใช้งาน เช่น single node ไม่รอด น่าจะต้องมี replica มารองรับการ read หรือไม่ หรือต้องทำแบบ multi-master เพื่อรองรับการ write ที่มากขึ้น หรือยังแยกการ read และ write ออกจากกันด้วยการใช้ database model ที่เหมาะสม (polyglot database)</li>\n\n\n\n<li>เราคนจริง ไม่มีการใช้งาน caching หรือ pre-aggregate ใด ๆ สำหรับ query ข้อมูลบ่อย ๆ หรือ หนัก ๆ ดังนั้นควรจัดการให้ดี แต่ก็ต้องดูเรื่อง cached invalidate ด้วย เพื่อให้ข้อมูลถูกต้องอยู่อย่างเสมอ</li>\n\n\n\n<li>ออกแบบ data model ไม่เหมาะสมกับงาน ทั้ง Normalization และ De-nomalization</li>\n\n\n\n<li>ถ้าลึกกว่านั้นคือ เรื่องของ data type ที่ใช้จัดเก็บไม่เหมาะสมกับงาน</li>\n\n\n\n<li>การจัดการ database connection ที่ไม่ดี ซึ่งต้องใช้งาน connection pool หรือ proxy เข้ามาช่วย เพื่อ reuse connection ให้ดีขึ้น</li>\n\n\n\n<li>ถ้ามี load เข้ามาหนัก ๆ  จำเป็นต้องออกแบบเพื่อรองรับเพื่อให้ระบบไม่พังไปด้วย เช่น rate limit, circuit breaker หรือ แทนที่จะทำงานแบบ synchronous ก็ปรับมาเป็น asynchronous ด้วย</li>\n</ul>\n\n\n\n<p>ลองดูระบบของเราสิว่า มีปัญหากันตรงไหนบ้าง ?<br />ขอให้สนุกกับการ coding ครับ</p>\n\n\n\n<p><br /></p>\n","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"4b86b3a710b1c234f1b27df65a3c3f5cbad9f4e056d371e3541ce012eefe8383","category":"Thai"}