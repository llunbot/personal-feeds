{"title":"Version 2 of the Packer Azure plugin is now available","link":"https://www.hashicorp.com/blog/version-2-packer-azure-plugin-now-available","date":1694070000000,"content":"<p>We're excited to announce the version 2.0.0 release of the <a href=\"https://github.com/hashicorp/packer-plugin-azure\">Packer Azure plugin</a>, which enables users to build Azure virtual hard disks, managed images, and Compute Gallery (shared image gallery) images. The plugin is one of the most popular ways to build Azure Virtual Machine images and is used by Microsoft Azure via the <a href=\"https://learn.microsoft.com/en-us/azure/virtual-machines/image-builder-overview?tabs=azure-powershell\">Azure Image Builder</a></p>\n\n<p>For the past year, we have been tracking the changes to the Azure SDKs and keeping our eyes on the upcoming deprecations, which were sure to disrupt how Packer interacts with Azure. When we found that the version of the Azure SDK the Packer plugin was using would soon be <a href=\"https://azure.github.io/azure-sdk/releases/deprecated/index.html\">deprecated</a> we began work to migrate to the Terraform tested <a href=\"https://github.com/hashicorp/go-azure-sdk\">HashiCorp Go Azure SDK</a>. The HashiCorp Go Azure SDK is generated from and based on the Azure API definitions to provide parity with the official Azure SDK â€” making it a near drop-in replacement for the Azure SDK, with the ability to resolve issues around auto-rest, polling, and API versioning. Version 2.0.0 of the Packer Azure plugin addresses the known deprecations with minimal disruption to the user, introduces new highly requested features, and combines the stability of the Packer Azure plugin with the Terraform Azure provider</p>\n\n<h3>OIDC support</h3>\n\n<p>Many users want to bring their own authentication provider when connecting to Azure, and some organizations have policies requiring this. Version 2 of the Packer Azure plugin supports using an OIDC provider to authenticate to Azure using the <code>client_jwt</code> field in the builder configuration. You can follow <a href=\"https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-azure\">this guide</a> to setting up GitHub as your OIDC Provider and adding its federated credentials to Azure. For example, configuring a GitHub action like this:</p>\n<pre><code>```\nname: OIDC Example\non:\n  push:\n\npermissions:\n  contents: read\n  id-token: write\n\njobs:\n  secrets-check:\n\truns-on: ubuntu-latest\n\toutputs:\n  \tavailable: \"${{ steps.check-secrets.outputs.available }}\"\n\tsteps:\n  \t# we check for the ACTIONS_ID_TOKEN_REQUEST_URL variable as a proxy for other secrets\n  \t# it will be unset when running for a PR from a fork\n  \t- id: check-secrets\n    \trun: |\n      \tif [[ \"${ACTIONS_ID_TOKEN_REQUEST_URL}\" == \"\" ]]; then\n        \techo \"available=false\" | tee ${GITHUB_OUTPUT}\n      \telse\n        \techo \"available=true\" | tee ${GITHUB_OUTPUT}\n      \tfi\n\n  test-oidc:\n\truns-on: ubuntu-latest\n\tneeds: [secrets-check]\n\tif: needs.secrets-check.outputs.available == 'true'\n\tsteps:\n  \t- name: Set OIDC Token\n    \trun: |\n      \techo \"ARM_OIDC_TOKEN=$(curl -H \"Accept: application/json; api-version=2.0\" -H \"Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}\" -H \"Content-Type: application/json\" -G --data-urlencode \"audience=api://AzureADTokenExchange\" \"${ACTIONS_ID_TOKEN_REQUEST_URL}\" | jq -r '.value')\"  &gt;&gt;${GITHUB_ENV}\n\n  \t- name: Install Go\n    \tuses: actions/setup-go@4d34df0c2316fe8122ab82dc22947d607c0c91f9 # v4.0.0\n    \twith:\n      \tgo-version: '1.19.5'\n\n  \t- name: Checkout\n    \tuses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3.5.2\n \t \n  \t- name: Setup `packer`\n    \tuses: hashicorp/setup-packer@main\n    \tid: setup\n\n  \t- name: Build the plugin\n    \trun:  make\n \t \n  \t- name: Try to run an AzureARM build with our OIDC token\n    \trun:  packer build -force ./example/oidc-example.pkr.hcl\n    \tenv:\n      \tARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID}}\n      \tARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID}}\n```\n</code></pre><p>And using this example Packer template with the client_jwt set as our GitHub provided OIDC token:</p>\n<pre><code>variable \"arm_client_id\" {\n  type    = string\n  default = \"${env(\"ARM_CLIENT_ID\")}\"\n}\n\nvariable \"arm_oidc_token\" {\n  type    = string\n  default = \"${env(\"ARM_OIDC_TOKEN\")}\"\n}\n\nvariable \"subscription_id\" {\n  type    = string\n  default = \"${env(\"ARM_SUBSCRIPTION_ID\")}\"\n}\n\nvariable \"group_name\" {\n  type    = string\n  default = \"${env(\"ARM_GROUP_NAME\")}\"\n}\n\nsource \"azure-arm\" \"oidc\" {\n  client_id                         = \"${var.arm_client_id}\"\n  client_jwt                        = \"${var.arm_oidc_token}\"\n  communicator                      = \"winrm\"\n  image_offer                       = \"WindowsServer\"\n  image_publisher                   = \"MicrosoftWindowsServer\"\n  image_sku                         = \"2012-R2-Datacenter\"\n  location                          = \"westus\"\n  managed_image_name                = \"oidc-example\"\n  managed_image_resource_group_name = \"${var.group_name}\"\n  os_type                           = \"Windows\"\n  subscription_id                   = \"${var.subscription_id}\"\n  vm_size                           = \"Standard_DS2_v2\"\n  winrm_insecure                    = \"true\"\n  winrm_timeout                     = \"3m\"\n  winrm_use_ssl                     = \"true\"\n  winrm_username                    = \"packer\"\n}\n\nbuild {\n  sources = [\"source.azure-arm.oidc\"]\n}</code></pre><h3>Client certificate authentication</h3>\n\n<p>Beginning with version 2, the Packer Azure plugin now supports only PKCS#12 bundle (.pfx file) for client certificate authentication. For more information on generating a pfx cert and adding it to Azure, check out the <a href=\"https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/service_principal_client_certificate#generating-a-client-certificate\">Terraform Azure provider documentation</a>. Certificates encoded in the .pem format, which previously worked in the Azure plugin, will no longer be recognized by the plugin.</p>\n\n<h3>Clarification on VHD deprecation</h3>\n\n<p>Historically, the Packer Azure plugin notified users that Azure VHD (virtual hard disk) builds were deprecated and would be removed at a later date. This has led to confusion on whether users can rely on VHD functionality remaining in the plugin, and when or if they will be forced to migrate. We found that many users continue to build VHD images using the Packer Azure plugin, so we decided to remove the deprecation warning. VHD builds will continue to work on v2.0.0 of Azure, and we have no plans to deprecate it again in the immediate future.</p>\n\n<h3>Other updates in the Packer Azure plugin</h3>\n\n<p>We also made changes to let the plugin fail faster when users are creating an image build that won't succeed based on invalid shared image gallery version values. We also added support for setting a WinRM expiration time for Azure tenants/subscriptions that have that policy requirement. You can find a full list of changes in the <a href=\"https://github.com/hashicorp/packer-plugin-azure/releases/tag/v2.0.0\">Packer Azure plugin release notes</a>.</p>\n\n<p>Please report any issues with and share your feedback on Version 2.0.0 in the <a href=\"https://github.com/hashicorp/packer-plugin-azure/issues\">Packer Azure plugin GitHub issue tracker</a>. </p>\n","author":"Jenna Goldstrich","siteTitle":"HashiCorp Blog","siteHash":"219aa6310b3388f2335eba49871f4df9581f2c58eaeb5e498363b54e835b7001","entryHash":"9c61fa8191f8953ec402354a9409454eca415e392c54f5acde98ca0ba2b3ece2","category":"Tech"}