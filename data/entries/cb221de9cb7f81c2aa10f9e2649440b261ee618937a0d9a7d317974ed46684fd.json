{"title":"New RAG evaluation and LLM-as-a-judge capabilities in Amazon Bedrock","link":"https://aws.amazon.com/blogs/aws/new-rag-evaluation-and-llm-as-a-judge-capabilities-in-amazon-bedrock/","date":1733109691000,"content":"<p>Today, we’re announcing two new evaluation capabilities in <a href=\"https://aws.amazon.com/bedrock/\">Amazon Bedrock</a> that can help you streamline testing and improve <a href=\"https://aws.amazon.com/ai/generative-ai/\">generative AI</a> applications:</p> \n<p><strong>Amazon Bedrock Knowledge Bases now supports RAG evaluation (preview)</strong> – You can now run an automatic knowledge base evaluation to assess and optimize <a href=\"https://aws.amazon.com/what-is/retrieval-augmented-generation/\">Retrieval Augmented Generation (RAG)</a> applications using <a href=\"https://aws.amazon.com/bedrock/knowledge-bases/\">Amazon Bedrock Knowledge Bases</a>. The evaluation process uses a <a href=\"https://aws.amazon.com/what-is/large-language-model/\">large language model (LLM)</a> to compute the metrics for the evaluation. With RAG evaluations, you can compare different configurations and tune your settings to get the results you need for your use case.</p> \n<p><strong>Amazon Bedrock Model Evaluation now includes LLM-as-a-judge (preview)</strong> – You can now perform tests and evaluate other models with humanlike quality at a fraction of the cost and time of running human evaluations.</p> \n<p>These new capabilities make it easier to go into production by providing fast, automated evaluation of AI-powered applications, shortening feedback loops and speeding up improvements. These evaluations assess multiple quality dimensions including correctness, helpfulness, and responsible AI criteria such as answer refusal and harmfulness.</p> \n<p>To make it easy and intuitive, the evaluation results provide natural language explanations for each score in the output and on console, and the scores are normalized from 0 to 1 for ease of interpretability. Rubrics are published in full with the judge prompts in the documentation so non-scientists can understand how scores are derived.</p> \n<p>Let’s see how they work in practice.</p> \n<p><span><strong>Using RAG evaluations in Amazon Bedrock Knowledge Bases<br /> </strong></span>In the Amazon Bedrock console, I choose <strong>Evaluations</strong> in the <strong>Inference and Assessment</strong> section. There, I see the new <strong>Knowledge Bases</strong> tab.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-section.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-section.png\" alt=\"Console screenshot.\" width=\"1299\" height=\"764\" /></a></p> \n<p>I choose <strong>Create</strong>, enter a name and a description for the evaluation, and select the <strong>Evaluator model</strong> that will compute the metrics. In this case, I use Anthropic’s <strong>Claude 3.5 Sonnet</strong>.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-create.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-create.png\" alt=\"Console screenshot.\" width=\"837\" height=\"571\" /></a></p> \n<p>I select the knowledge base to evaluate. I previously created a knowledge base containing only the <a href=\"https://docs.aws.amazon.com/lambda/\">AWS Lambda Developer Guide PDF file</a>. In this way, for the evaluation, I can ask questions about the <a href=\"https://aws.amazon.com/lambda/\">AWS Lambda</a> service.</p> \n<p>I can evaluate either the retrieval function alone or the complete retrieve-and-generate workflow. This choice affects the metrics that are available in the next step. I choose to evaluate both retrieval and response generation and select the model to use. In this case, I use Anthropic’s <strong>Claude 3 Haiku</strong>. I can also use <a href=\"https://aws.amazon.com/bedrock/guardrails/\">Amazon Bedrock Guardrails</a> and adjust runtime inference settings by choosing the <strong>configurations</strong> link after the response generator model.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-create-details-haiku.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-create-details-haiku.png\" alt=\"Console screenshot.\" width=\"838\" height=\"422\" /></a></p> \n<p>Now, I can choose which metrics to evaluate. I select <strong>Helpfulness</strong> and <strong>Correctness</strong> in the <strong>Quality</strong> section and <strong>Harmfulness</strong> in the <strong>Responsible AI metrics</strong> section.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/maaj-eval-create-metrics.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/maaj-eval-create-metrics.png\" alt=\"Console screenshot.\" width=\"834\" height=\"901\" /></a></p> \n<p>Now, I select the dataset that will be used for evaluation. This is the <a href=\"https://jsonlines.org/\">JSONL</a> file I prepared and uploaded to <a href=\"https://aws.amazon.com/s3/\">Amazon Simple Storage Service (Amazon S3)</a> for this evaluation. Each line provides a conversation, and for each message there is a reference response.</p> \n<div> \n <pre><code>{\"conversationTurns\":[{\"referenceResponses\":[{\"content\":[{\"text\":\"A trigger is a resource or configuration that invokes a Lambda function such as an AWS service.\"}]}],\"prompt\":{\"content\":[{\"text\":\"What is an AWS Lambda trigger?\"}]}}]}\n{\"conversationTurns\":[{\"referenceResponses\":[{\"content\":[{\"text\":\"An event is a JSON document defined by the AWS service or the application invoking a Lambda function that is provided in input to the Lambda function.\"}]}],\"prompt\":{\"content\":[{\"text\":\"What is an AWS Lambda event?\"}]}}]}</code></pre> \n</div> \n<p>I specify the S3 location in which to store the results of the evaluation. The evaluation job requires that the S3 bucket is <a href=\"https://docs.aws.amazon.com/bedrock/latest/userguide/model-evaluation-security-iam.html#model-evaluation-security-cors\">configured with the cross-origin resource sharing (CORS) permissions described in the Amazon Bedrock User Guide</a>.</p> \n<p>For service access, I need to create or provide an <a href=\"https://aws.amazon.com/iam/\">AWS Identity and Access Management (IAM)</a> service role that Amazon Bedrock can assume and that allows access to the Amazon Bedrock and Amazon S3 resources used by the evaluation.</p> \n<p>After a few minutes, the evaluation has completed, and I browse the results. The actual duration of an evaluation depends on the size of the prompt dataset and on the generator and the evaluator models used.</p> \n<p>At the top, the <strong>Metric summary</strong> evaluates the overall performance using the average score across all conversations.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-result-summary.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-result-summary.png\" alt=\"Console screenshot.\" width=\"1337\" height=\"526\" /></a></p> \n<p>After that, the <strong>Generation metrics breakdown</strong> gives me details about each of the selected evaluation metrics. My evaluation dataset was small (two lines), so there isn’t a large distribution to look at.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-result-metrics.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/kb-eval-result-metrics.png\" width=\"1337\" height=\"1847\" /></a></p> \n<p>From here, I can also see example conversations and how they were rated. To view all conversations, I can visit the full output in the S3 bucket.</p> \n<p>I’m curious why <strong>Helpfulness</strong> is slightly below one. I expand and zoom <strong>Example conversations</strong> for <strong>Helpfulness</strong>. There, I see the generated output, the ground truth that I provided with the evaluation dataset, and the score. I choose the score to see the model reasoning. According to the model, it would have helped to have more in-depth information. Models really are strict judges.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/21/kb-eval-result-example-conversations.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/21/kb-eval-result-example-conversations.png\" alt=\"Console screenshot.\" width=\"1831\" height=\"1230\" /></a></p> \n<p><span><strong>Comparing RAG evaluations<br /> </strong></span>The result of a knowledge base evaluation can be difficult to interpret by itself. For this reason, the console allows comparing results from multiple evaluations to understand the differences. In this way, you can understand if you’re improving or not for the metrics you care about.</p> \n<p>For example, I previously ran two other knowledge base evaluations. They’re related to knowledge bases with the same data sources but different chunking and parsing configurations and different embedding models.</p> \n<p>I select the two evaluations and choose <strong>Compare</strong>. To be comparable in the console, the evaluations need to cover the same metrics.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/22/kb-eval-compare.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/22/kb-eval-compare.png\" alt=\"Console screenshot.\" width=\"1101\" height=\"326\" /></a></p> \n<p>In the <strong>At a glance</strong> tab, I see a visual comparison of the metrics using a spider chart. In this case, the results are not much different. The main difference is the <strong>Faithfulness</strong> score.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/22/kb-eval-compare-visual.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/22/kb-eval-compare-visual.png\" alt=\"Console screenshot.\" width=\"1078\" height=\"1139\" /></a></p> \n<p>In the <strong>Evaluation details</strong> tab, I find a detailed comparison of the results for each metric, including the difference in scores.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/22/kb-eval-compare-details.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/22/kb-eval-compare-details.png\" alt=\"Console screenshot.\" width=\"1083\" height=\"1382\" /></a></p> \n<p><span><strong>Using LLM-as-a-judge in Amazon Bedrock Model Evaluation (preview)<br /> </strong></span>In the Amazon Bedrock console, I choose <strong>Evaluations</strong> in the <strong>Inference and Assessment</strong> section of the navigation pane. After I choose <strong>Create</strong>, I select the new <strong>Automatic: Model as a judge</strong> option.</p> \n<p>I enter a name and a description for the evaluation and select the <strong>Evaluator model</strong> that is used to generate evaluation metrics. I use Anthropic’s <strong>Claude 3.5 Sonnet</strong>.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/maaj-eval-create.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/maaj-eval-create.png\" alt=\"Console screenshot.\" width=\"836\" height=\"592\" /></a></p> \n<p>Then, I select the <strong>Generator model</strong>, which is the model I want to evaluate. Model evaluation can help me understand if a smaller and more cost-effective model meets the needs of my use case. I use Anthropic’s <strong>Claude 3 Haiku</strong>.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/maaj-eval-create-generator-model.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/maaj-eval-create-generator-model.png\" alt=\"Console screenshot.\" width=\"834\" height=\"225\" /></a></p> \n<p>In the next section I select the <strong>Metrics</strong> to evaluate. I select <strong>Helpfulness</strong> and <strong>Correctness</strong> in the <strong>Quality</strong> section and <strong>Harmfulness</strong> in the <strong>Responsible AI metrics</strong> section.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/maaj-eval-create-metrics-1.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/19/maaj-eval-create-metrics-1.png\" alt=\"Console screenshot.\" width=\"834\" height=\"901\" /></a></p> \n<p>In the <strong>Datasets</strong> section I specify the Amazon S3 location where my evaluation dataset is stored and the folder in an S3 bucket where the results of the model evaluation job are stored.</p> \n<p>For the evaluation dataset, I prepared another JSONL file. Each line provides a prompt and a reference answer. Note that the format is different compared to knowledge base evaluations.</p> \n<div> \n <pre><code>{\"prompt\":\"Write a 15 words summary of this text:\\n\\nAWS Fargate is a technology that you can use to run containers without having to manage servers or clusters. With AWS Fargate, you no longer have to provision, configure, or scale clusters of virtual machines to run containers. This removes the need to choose server types, decide when to scale your clusters, or optimize cluster packing.\",\"referenceResponse\":\"AWS Fargate allows running containers without managing servers or clusters, simplifying container deployment and scaling.\"}\n{\"prompt\":\"Give me a list of the top 3 benefits from this text:\\n\\nAWS Fargate is a technology that you can use to run containers without having to manage servers or clusters. With AWS Fargate, you no longer have to provision, configure, or scale clusters of virtual machines to run containers. This removes the need to choose server types, decide when to scale your clusters, or optimize cluster packing.\",\"referenceResponse\":\"- No need to manage servers or clusters.\\n- Simplified infrastructure management.\\n- Improved focus on application development.\"}</code></pre> \n</div> \n<p>Finally, I can choose an IAM service role that gives Amazon Bedrock access to the resources used by this evaluation job.</p> \n<p>I complete the creation of the evaluation. After a few minutes, the evaluation is complete. Similar to the knowledge base evaluation, the result starts with a <strong>Metrics Summary</strong>.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/21/maaj-eval-result-summary.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/21/maaj-eval-result-summary.png\" width=\"1600\" height=\"498\" /></a></p> \n<p>The <strong>Generation metrics breakdown</strong> details each metric, and I can look at details for a few sample prompts. I look at <strong>Helpfulness</strong> to better understand the evaluation score.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/21/maaj-eval-result-metrics.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/21/maaj-eval-result-metrics.png\" alt=\"Console screenshot.\" width=\"1619\" height=\"878\" /></a></p> \n<p>The prompts in the evaluation have been correctly processed by the model, and I can apply the results for my use case. If my application needs to manage prompts similar to the ones used in this evaluation, the evaluated model is a good choice.</p> \n<p><span><strong>Things to know<br /> </strong></span>These new evaluation capabilities are available in preview in the following <a href=\"https://aws.amazon.com/about-aws/global-infrastructure/regions_az/\">AWS Regions</a>:</p> \n<ul> \n <li>RAG evaluation in US East (N. Virginia), US West (Oregon), Asia Pacific (Mumbai, Sydney, Tokyo), Canada (Central), Europe (Frankfurt, Ireland, London, Paris), and South America (São Paulo)</li> \n <li>LLM-as-a-judge in US East (N. Virginia), US West (Oregon), Asia Pacific (Mumbai, Seoul, Sydney, Tokyo), Canada (Central), Europe (Frankfurt, Ireland, London, Paris, Zurich), and South America (São Paulo)</li> \n</ul> \n<p>Note that the available evaluator models depend on the Region.</p> \n<p>Pricing is based on the standard <a href=\"https://aws.amazon.com/bedrock/pricing/\">Amazon Bedrock pricing</a> for model inference. There are no additional charges for evaluation jobs themselves. The evaluator models and models being evaluated are billed according to their normal on-demand or provisioned pricing. The judge prompt templates are part of the input tokens, and those judge prompts can be found in the AWS documentation for transparency.</p> \n<p>The evaluation service is optimized for English language content at launch, though the underlying models can work with content in other languages they support.</p> \n<p>To get started, visit the <a href=\"https://console.aws.amazon.com/bedrock\">Amazon Bedrock console</a>. To learn more, you can access the <a href=\"https://docs.aws.amazon.com/bedrock/latest/userguide/what-is-bedrock.html\">Amazon Bedrock documentation</a> and send feedback to <a href=\"https://repost.aws/tags/TAQeKlaPaNRQ2tWB6P7KrMag/amazon-bedrock\">AWS re:Post for Amazon Bedrock</a>. You can find deep-dive technical content and discover how our Builder communities are using Amazon Bedrock at <a href=\"https://community.aws/\">community.aws</a>. Let us know what you build with these new capabilities!</p> \n<p>— <a href=\"https://twitter.com/danilop\">Danilo</a></p>","author":"Danilo Poccia","siteTitle":"AWS News Blog","siteHash":"6093e072e4117ec22616e844cb857d03ca62c57a411a8affc77cb5e8b6b15bf6","entryHash":"cb221de9cb7f81c2aa10f9e2649440b261ee618937a0d9a7d317974ed46684fd","category":"Tech"}