{"title":"Amazon Managed Service for Prometheus Is Now Generally Available with Alert Manager and Ruler","link":"https://aws.amazon.com/blogs/aws/amazon-managed-service-for-prometheus-is-now-generally-available-with-alert-manager-and-ruler/","date":1632949037000,"content":"<p>At AWS re:Invent 2020, we <a href=\"https://aws.amazon.com/blogs/aws/join-the-preview-amazon-managed-service-for-prometheus-amp/\">introduced the preview</a> of <a href=\"https://aws.amazon.com/prometheus/\">Amazon Managed Service for Prometheus</a>, an open source Prometheus-compatible monitoring service that makes it easy to monitor containerized applications at scale. With Amazon Managed Service for Prometheus, you can use the <a href=\"https://prometheus.io/docs/prometheus/latest/querying/basics/\">Prometheus query language (PromQL)</a> to monitor the performance of containerized workloads without having to manage the underlying infrastructure required to scale and secure the ingestion, storage, alert, and querying of operational metrics.</p> \n<p>Amazon Managed Service for Prometheus automatically scales as your monitoring needs grow. It is a highly available service deployed across multiple Availability Zones (AZs) that integrates AWS security and compliance capabilities. The service offers native support for PromQL as well as the ability to ingest Prometheus metrics from over 150 Prometheus exporters maintained by the open source community.</p> \n<p>With Amazon Managed Service for Prometheus, you can collect Prometheus metrics from <a href=\"https://aws.amazon.com/blogs/opensource/using-amazon-managed-service-for-prometheus-to-monitor-ec2-environments/\">Amazon Elastic Compute Cloud (Amazon EC2)</a>, <a href=\"https://aws.amazon.com/blogs/opensource/metrics-collection-from-amazon-ecs-using-amazon-managed-service-for-prometheus/\">Amazon Elastic Container Service (Amazon ECS)</a>, and <a href=\"https://aws.amazon.com/blogs/opensource/best-practices-for-migrating-self-hosted-prometheus-on-amazon-eks-to-amazon-managed-service-for-prometheus/\">Amazon Elastic Kubernetes Service (Amazon EKS)</a> environments using <a href=\"https://aws.amazon.com/otel/\">AWS Distro for OpenTelemetry (ADOT)</a> or Prometheus servers as collection agents.</p> \n<p>During the preview, we contributed the <a href=\"https://github.com/cortexproject/cortex/pull/4204\">high-availability alert manager</a> to the open source <a href=\"https://cortexmetrics.io/\">Cortex project</a>, a project providing horizontally scalable, highly available, multi-tenant, long-term store for <a href=\"https://prometheus.io/\">Prometheus</a>. Also, we reduced the price of metric samples ingested by <a href=\"https://aws.amazon.com/about-aws/whats-new/2021/05/aws-announces-a-price-reduction-for-amazon-managed-service-for-prometheus-amp/\">up to 84 percent</a>, and supported <a href=\"https://aws.amazon.com/blogs/opensource/aws-lambda-metrics-support-for-amazon-managed-service-for-prometheus-now-available-in-aws-distro-for-opentelemetry/\">collection of metrics for AWS Lambda</a> applications by ADOT.</p> \n<p>Today, I am happy to announce the general availability of Amazon Managed Service for Prometheus with new features such as alert manager and ruler that support <a href=\"https://aws.amazon.com/sns\">Amazon Simple Notification Service (Amazon SNS)</a> as a receiver destination for notifications from Alert Manager. You can integrate Amazon SNS with destinations such as email, webhook, Slack, PagerDuty, OpsGenie, or VictorOps with Amazon SNS.</p> \n<p><strong><u>Getting Started with Alert Manager and Ruler</u></strong><br /> To get started in the <a href=\"https://console.aws.amazon.com/prometheus/home\">AWS Management Console</a>, you can simply create a workspace, a logical space dedicated to the storage, alerting, and querying of metrics from one or more Prometheus servers. You can set up the ingestion of Prometheus metrics to this workspace using Helm and query those metrics. To learn more, see <a href=\"https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-getting-started.html\">Getting started</a> in the Amazon Managed Service for Prometheus User Guide.</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/09/24/2021-amp-1-workspace.png\" /></p> \n<p>At general availability, we added new alert manager and rules management features. The service supports two types of rules: <a href=\"https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/\">recording rules</a> and <a href=\"https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/\">alerting rules</a>. These rules files are the same YAML format as standalone Prometheus, which may be configured and then evaluated at regular intervals.</p> \n<p>To configure your workspace with a set of rules, choose <strong>Add namespace</strong> in <strong>Rules management</strong> and select a YAML format rules file.</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/09/24/2021-amp-2-add-rules.png\" /></p> \n<p>An example rules file would record CPU usage metrics in container workloads and triggers an alert if CPU usage is high for five minutes.</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/09/24/2021-amp-2-rule-group.png\" /></p> \n<p>Next, you can create a new Amazon SNS topic or reuse an existing SNS topic where it will route the alerts. The alertmanager routes the alerts to SNS and SNS routes to downstream locations. Configured alerting rules will fire alerts to the Alert Manager, which deduplicate, group, and route alerts to Amazon SNS via the SNS receiver. If you’d like to receive email notifications for your alerts, configure an email subscription for the SNS topic you had.</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/09/24/2021-amp-2-add-SNS-topic.png\" /></p> \n<p>To give Amazon Managed Service for Prometheus permission to send messages to your SNS topic, select the topic you plan to send to, and add the access policy block:</p> \n<pre><code>{\n    \"Sid\": \"Allow_Publish_Alarms\",\n    \"Effect\": \"Allow\",\n    \"Principal\": {\n        \"Service\": \"aps.amazonaws.com\"\n    },\n    \"Action\": [\n        \"sns:Publish\",\n        \"sns:GetTopicAttributes\"\n    ],\n    \"Resource\": \"arn:aws:sns:us-east-1:123456789012:Notifyme\"\n}</code></pre> \n<p>If you have a topic to get alerts, you can configure this SNS receiver in the alert manager configuration. An example config file is the same format as Prometheus, but you have to provide the config underneath an <code>alertmanager_config:</code> block in for the service’s Alert Manager. For more information about the Alert Manager config, visit <a href=\"https://prometheus.io/docs/alerting/latest/configuration/\">Alerting Configuration</a> in Prometheus guide.</p> \n<pre><code>alertmanager_config:\n  route:\n    receiver: default\n    repeat_interval: 5m\n  receivers:\n    name: default\n    sns_configs:\n      topic_arn: \"arn:aws:sns:us-east-1:123456789012:Notifyme\"\n      sigv4:\n        region: us-west-2\n      attributes:\n        key: severity\n        value: \"warning\"</code></pre> \n<p>You can replace the<code> topic_arn</code> for the topic that you create while setting up the SNS connection. To learn more about the SNS receiver in the alert manager config, visit <a href=\"https://github.com/prometheus/alertmanager/issues/2559\">Prometheus SNS receiver</a> on the Prometheus Github page.</p> \n<p>To configure the Alert Manager, open the <strong>Alert Manager</strong> and choose <strong>Add definition</strong>, then select a YAML format alert config file.</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/09/24/2021-amp-3-alert-manager.png\" /></p> \n<p>When an alert is created by Prometheus and sent to the Alert Manager, it can be queried by hitting the <code>ListAlerts</code> endpoint to see all the active alerts in the system. After hitting the endpoint, you can see alerts in the list of actively firing alerts.</p> \n<pre><code>$ curl https://aps-workspaces.us-east-1.amazonaws.com/workspaces/ws-0123456/alertmanager/api/v2/alerts\nGET /workspaces/ws-0123456/alertmanager/api/v2/alerts HTTP/1.1\nHost: aps-workspaces.us-east-1.amazonaws.com\nX-Amz-Date: 20210628T171924Z\n...\n[\n    \"receivers\": [\n      {\n        \"name\": \"default\"\n      }\n    ],\n    \"startsAt\": \"2021-09-24T01:37:42.393Z\",\n    \"updatedAt\": \"2021-09-24T01:37:42.393Z\",\n    \"endsAt\": \"2021-09-24T01:37:42.393Z\",\n    \"status\": {\n      \"state\": \"unprocessed\",\n    },\n    \"labels\": {\n      \"severity\": \"warning\"\n    }\n  }\n]</code></pre> \n<p>A successful notification will result in an email received from your SNS topic with the alert details. Also, you can output messages in JSON format to be easily processed downstream of SNS by AWS Lambda or other APIs and webhook receiving endpoints. For example, you can connect SNS with a Lambda function for message transformation or triggering automation. To learn more, visit <a href=\"https://docs.aws.amazon.com/prometheus/latest/userguide/\">Configuring Alertmanager to output JSON to SNS</a> in the Amazon Managed Service for Prometheus User Guide.</p> \n<p><strong><u>Sending from Amazon SNS to Other Notification Destinations</u></strong><br /> You can connect Amazon SNS to a variety of outbound destinations such as email, webhook (HTTP), Slack, PageDuty, and OpsGenie.</p> \n<ul> \n <li><strong>Webhook</strong> – To configure a preexisting SNS topic to output messages to a webhook endpoint, first create a subscription to an existing topic. Once active, your HTTP endpoint should receive SNS notifications.</li> \n <li><strong>Slack</strong> – You can either integrate with Slack’s email-to-channel integration where Slack has the ability to accept an email and forward it to a Slack channel, or you can utilize a Lambda function to rewrite the SNS notification to Slack. To learn more, see <a href=\"https://aws.amazon.com/blogs/mt/how-to-integrate-amazon-managed-service-for-prometheus-with-slack/\">How to integrate Amazon Managed Service for Prometheus with Slack</a>.</li> \n <li><strong>PagerDuty</strong> – To customize the payload sent to PagerDuty, customize the template that is used in generating the message sent to SNS by adjusting or updating <code>template_files</code> block in your alertmanager definition. To learn more, see <a href=\"https://aws.amazon.com/blogs/mt/using-amazon-managed-service-for-prometheus-alert-manager-to-receive-alerts-with-pagerduty/\">Using Amazon Managed Service for Prometheus Alert Manager to receive alerts with PagerDuty</a>.</li> \n</ul> \n<p><strong><u>Available Now</u></strong><br /> <a href=\"https://aws.amazon.com/prometheus/\">Amazon Managed Service for Prometheus</a> is available today in nine AWS Regions: US East (N. Virginia), US East (Ohio), US West (Oregon), Europe (Frankfurt), Europe (Ireland), Europe (Stockholm), Asia Pacific (Singapore), Asia Pacific (Sydney), and Asia Pacific (Tokyo).</p> \n<p>You pay only for what you use, based on metrics ingested, queried, and stored. As part of the AWS Free Tier, you can get started with Amazon Managed Service for Prometheus for 40 million metric samples ingested and 10 GB metrics stored per month. To learn more, visit the <a href=\"https://aws.amazon.com/prometheus/pricing/\">pricing page</a>.</p> \n<p>If you want to learn about AWS observability on AWS, visit <a href=\"https://observability.workshop.aws/\">One Observability Workshop</a> which provides a hands-on experience for you on the wide variety of toolsets AWS offers to set up monitoring and observability on your applications.</p> \n<p>Please send feedback to the <a href=\"https://forums.aws.amazon.com/forum.jspa?forumID=392\">AWS forum for Amazon Managed Service for Prometheus</a> or through your usual AWS support contacts.</p> \n<p><strong><u>Learn More</u></strong><br /> To learn more and see Amazon Managed Service for Prometheus in action, <a href=\"https://amazon.webex.com/amazon/j.php?RGID=r56b66e55565b36d90d8c33c84a2a85bc\">register for our webinar</a> and join us on October 6, 2021 at 9:30am PST.</p> \n<p>– <a href=\"https://twitter.com/channyun\">Channy</a></p>","author":"Channy Yun","siteTitle":"AWS News Blog","siteHash":"6093e072e4117ec22616e844cb857d03ca62c57a411a8affc77cb5e8b6b15bf6","entryHash":"101cbdc8c27189131ff3211195bd1d61a566da38b0f3527623756599678dde0f","category":"Tech"}