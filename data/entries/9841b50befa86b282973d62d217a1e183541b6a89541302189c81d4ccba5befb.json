{"title":"Amazon Managed Service for Prometheus collector provides agentless metric collection for Amazon EKS","link":"https://aws.amazon.com/blogs/aws/amazon-managed-service-for-prometheus-collector-provides-agentless-metric-collection-for-amazon-eks/","date":1701027558000,"content":"<p>Today, I’m happy to announce a new capability, <a href=\"https://aws.amazon.com/prometheus/\">Amazon Managed Service for Prometheus</a> collector, to automatically and agentlessly discover and collect Prometheus metrics from <a href=\"https://aws.amazon.com/eks/\">Amazon Elastic Kubernetes Service (Amazon EKS)</a>. Amazon Managed Service for Prometheus collector consists of a scraper that discovers and collects metrics from Amazon EKS applications and infrastructure without needing to run any collectors in-cluster.</p> \n<p>This new capability provides fully managed Prometheus-compatible monitoring and alerting with Amazon Managed Service for Prometheus. One of the significant benefits is that the collector is fully managed, automatically right-sized, and scaled for your use case. This means you don’t have to run any compute for collectors to collect the available metrics. This helps you optimize metric collection costs to monitor your applications and infrastructure running on EKS.</p> \n<p>With this launch, Amazon Managed Service for Prometheus now supports two major modes of Prometheus metrics collection: AWS managed collection, a fully managed and agentless collector, and customer managed collection.</p> \n<p><strong>Getting started with Amazon Managed Service for Prometheus Collector</strong><br /> Let’s take a look at how to use AWS managed collectors to ingest metrics using this new capability into a workspace in Amazon Managed Service for Prometheus. Then, we will evaluate the collected metrics in <a href=\"http://aws.amazon.com/grafana\">Amazon Managed Service for Grafana</a>.</p> \n<p>When you create a new EKS cluster using the Amazon EKS console, you now have the option to enable AWS managed collector by selecting <strong>Send Prometheus metrics to Amazon Managed Service for Prometheus</strong>. In the <strong>Destination</strong> section, you can also create a new workspace or select your existing Amazon Managed Service for Prometheus workspace. You can learn more about how to create a workspace by following the <a href=\"https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-getting-started.html\">getting started guide</a>.</p> \n<p><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2023/11/21/2023-prometheuscollector-rev-4-edit-1024x709.png\" width=\"1024\" height=\"709\" /></p> \n<p>Then, you have the flexibility to define your scraper configuration using the editor or upload your existing configuration. The scraper configuration controls how you would like the scraper to discover and collect metrics. To see possible values you can configure, please visit the <a href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/\">Prometheus Configuration</a> page.</p> \n<p><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2023/11/21/2023-prometheuscollector-rev-5-edit-985x1024.png\" width=\"985\" height=\"1024\" /></p> \n<p>Once you’ve finished the EKS cluster creation, you can go to the <strong>Observability</strong> tab on your cluster page to see the list of scrapers running in your EKS cluster.</p> \n<p><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2023/11/21/2023-prometheuscollector-rev-6-edit-1024x589.png\" width=\"1024\" height=\"589\" /></p> \n<p>The next step is to configure your EKS cluster to allow the scraper to access metrics. You can find the steps and information on <a href=\"https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-collector-how-to.html#AMP-collector-eks-setup\">Configuring your Amazon EKS cluster</a>.</p> \n<p>Once your EKS cluster is properly configured, the collector will automatically discover metrics from your EKS cluster and nodes. To visualize the metrics, you can use Amazon Managed Grafana integrated with your Prometheus workspace. Visit the <a href=\"https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-onboard-amg.html\">Set up Amazon Managed Grafana for use with Amazon Managed Service for Prometheus</a> page to learn more.</p> \n<p>The following is a screenshot of metrics ingested by the collectors and visualized in an Amazon Managed Grafana workspace. From here, you can run a simple query to get the metrics that you need.</p> \n<p><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2023/11/23/2023-prometheuscollector-rev-3-2-1024x516.png\" width=\"1024\" height=\"516\" /></p> \n<p><span><strong>Using AWS CLI and APIs<br /> </strong></span>Besides using the Amazon EKS console, you can also use the APIs or AWS Command Line Interface (AWS CLI) to add an AWS managed collector. This approach is useful if you want to add an AWS managed collector into an existing EKS cluster or make some modifications to the existing collector configuration.</p> \n<p>To create a scraper, you can run the following command:</p> \n<pre><code>aws amp create-scraper \\ \n       --source eksConfiguration=\"{clusterArn=&lt;EKS-CLUSTER-ARN&gt;,securityGroupIds=[&lt;SG-SECURITY-GROUP-ID&gt;],subnetIds=[&lt;SUBNET-ID&gt;]}\" \\ \n       --scrape-configuration configurationBlob=&lt;BASE64-CONFIGURATION-BLOB&gt; \\ \n       --destination=ampConfiguration={workspaceArn=\"&lt;WORKSPACE_ARN&gt;\"}\n</code></pre> \n<p>You can get most of the parameter values from the respective AWS console, such as your EKS cluster ARN and your Amazon Managed Service for Prometheus workspace ARN. Other than that, you also need to define the scraper configuration defined as <code>configurationBlob</code>.</p> \n<p>Once you’ve defined the scraper configuration, you need to encode the configuration file into base64 encoding before passing the API call. The following is the command that I use in my Linux development machine to encode <code>sample-configuration.yml</code> into base64 and copy it onto the clipboard.</p> \n<pre><code>$ base64 sample-configuration.yml | pbcopy</code></pre> \n<p><span><strong>Now Available<br /> </strong></span>The Amazon Managed Service for Prometheus collector capability is now available to all AWS customers in all AWS Regions where Amazon Managed Service for Prometheus is supported.</p> \n<p><span><strong>Learn more:</strong></span></p> \n<ul> \n <li><a href=\"https://aws.amazon.com/prometheus/\">Amazon Managed Service for Prometheus</a> product page</li> \n <li><a href=\"https://docs.aws.amazon.com/prometheus/latest/userguide/AMP-collector.html\">AWS managed collectors</a> documentation page</li> \n</ul> \n<p>Happy building!<br /> — <a href=\"https://www.linkedin.com/in/donnieprakoso\">Donnie</a></p>","author":"Donnie Prakoso","siteTitle":"AWS News Blog","siteHash":"6093e072e4117ec22616e844cb857d03ca62c57a411a8affc77cb5e8b6b15bf6","entryHash":"9841b50befa86b282973d62d217a1e183541b6a89541302189c81d4ccba5befb","category":"Tech"}