{"title":"New – Use Amazon S3 Event Notifications with Amazon EventBridge","link":"https://aws.amazon.com/blogs/aws/new-use-amazon-s3-event-notifications-with-amazon-eventbridge/","date":1638233397000,"content":"<p><a href=\"https://aws.amazon.com/eventbridge/\"><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/11/11/eb_how_1.png\" /></a>We launched <a href=\"https://aws.amazon.com/eventbridge\">Amazon EventBridge</a> in mid-2019 to make it easy for you to build powerful, event-driven applications at any scale. Since that launch, we have added several important features including a <a href=\"https://aws.amazon.com/blogs/aws/new-amazon-eventbridge-schema-registry-is-now-generally-available/\">Schema Registry</a>, the power to <a href=\"https://aws.amazon.com/blogs/aws/new-archive-and-replay-events-with-amazon-eventbridge/\">Archive and Replay Events</a>, support for<a href=\"https://aws.amazon.com/about-aws/whats-new/2021/04/amazon-eventbridge-introduces-support-cross-region-event-bus-targets/\"> Cross-Region Event Bus Targets</a>, and <a href=\"https://aws.amazon.com/about-aws/whats-new/2021/03/amazon-eventbridge-introduces-support-for-api-destinations/\">API Destinations</a> to allow you to send events to any HTTP API. With support for a very long list of destinations and the ability to do pattern matching, filtering, and routing of events, EventBridge is an incredibly powerful and flexible architectural component.</p> \n<p><span><strong>S3 Event Notifications</strong></span><br /> Today we are making it even easier for you to use EventBridge to build applications that react quickly and efficiently to changes in your S3 objects. This is a new, “directly wired” model that is faster, more reliable, and more developer-friendly than ever. You no longer need to make additional copies of your objects or write specialized, single-purpose code to process events.</p> \n<p>At this point you might be thinking that you already had the ability to react to changes in your S3 objects, and wondering what’s going on here. Back in 2014 we <a href=\"https://aws.amazon.com/blogs/aws/s3-event-notification/\">launched S3 Event Notifications</a> to SNS Topics, SQS Queues, and Lambda functions. This was (and still is) a very powerful feature, but using it at enterprise-scale can require coordination between otherwise-independent teams and applications that share an interest in the same objects and events. Also, EventBridge can already extract S3 API calls from CloudTrail logs and use them to do pattern matching &amp; filtering. Again, very powerful and great for many kinds of apps (with a focus on auditing &amp; logging), but we always want to do even better.</p> \n<p>Net-net, you can now configure S3 Event Notifications to directly deliver to EventBridge! This new model gives you several benefits including:</p> \n<p><strong>Advanced Filtering</strong> – You can filter on many additional metadata fields, including object size, key name, and time range. This is more efficient than using Lambda functions that need to make calls back to S3 to get additional metadata in order to make decisions on the proper course of action. S3 only publishes events that match a rule, so you save money by only paying for events that are of interest to you.</p> \n<p><strong>Multiple Destinations</strong> – You can route the same event notification to your choice of 18 AWS services including Step Functions, Kinesis Firehose, Kinesis Data Streams, and HTTP targets via API Destinations. This is a lot easier than creating your own fan-out mechanism, and will also help you to deal with those enterprise-scale situations where independent teams want to do their own event processing.</p> \n<p><strong>Fast, Reliable Invocation</strong> – Patterns are matched (and targets are invoked) quickly and directly. Because S3 provides at-least-once delivery of events to EventBridge, your applications will be more reliable.</p> \n<p>You can also take advantage of other EventBridge features, including the ability to <a href=\"https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-archive-event.html\">archive</a> and then <a href=\"https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-replay-archived-event.html\">replay</a> events. This allows you to reprocess events in case of an error or if you add a new target to an event bus.</p> \n<p><span><strong>Getting Started</strong></span><br /> I can get started in minutes. I start by enabling EventBridge notifications on one of my S3 buckets (<strong>jbarr-public</strong> in this case). I open the S3 Console, find my bucket, open the <strong>Properties</strong> tab, scroll down to <strong>Event notifications</strong>, and click <strong>Edit</strong>:</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/11/16/eb_s3_events_1.png\" /></p> \n<p>I select <strong>On</strong>, click <strong>Save changes</strong>, and I’m ready to roll:</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/11/16/eb_s3_enable_1.png\" /></p> \n<p>Now I use the EventBridge Console to create a rule. I start, as usual, by entering a name and a description:</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/11/12/eb_create_rule_top_2.png\" />Then I define a pattern that matches the bucket and the events of interest:</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/11/12/eb_create_rule_mid_1.png\" />One pattern can match one or more buckets and one or more events; the following events are supported:</p> \n<ul> \n <li><code>Object Created</code></li> \n <li><code>Object Deleted</code></li> \n <li><code>Object Restore Initiated</code></li> \n <li><code>Object Restore Completed</code></li> \n <li><code>Object Restore Expired</code></li> \n <li><code>Object Tags Added</code></li> \n <li><code>Object Tags Deleted</code></li> \n <li><code>Object ACL Updated</code></li> \n <li><code>Object Storage Class Changed</code></li> \n <li><code>Object Access Tier Changed</code></li> \n</ul> \n<p>Then I choose the default event bus, and set the target to an SNS topic (<strong>BucketAction</strong>) which publishes the messages to my Amazon email address:<img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/11/12/eb_create_rule_bottom_1-1.png\" /></p> \n<p>I click <strong>Create</strong>, and I am all set. To test it out, I simply upload some files to my bucket and await the messages:</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/11/13/eb_s3_upload_1.png\" /></p> \n<p>The message contains all of the interesting and relevant information about the event, and (after some unquoting and formatting), looks like this:</p> \n<div> \n <pre><code>{\n    \"version\": \"0\",\n    \"id\": \"2d4eba74-fd51-3966-4bfa-b013c9da8ff1\",\n    \"detail-type\": \"Object Created\",\n    \"source\": \"aws.s3\",\n    \"account\": \"348414629041\",\n    \"time\": \"2021-11-13T00:00:59Z\",\n    \"region\": \"us-east-1\",\n    \"resources\": [\n        \"arn:aws:s3:::jbarr-public\"\n    ],\n    \"detail\": {\n        \"version\": \"0\",\n        \"bucket\": {\n            \"name\": \"jbarr-public\"\n        },\n        \"object\": {\n            \"key\": \"eb_create_rule_mid_1.png\",\n            \"size\": 99797,\n            \"etag\": \"7a72374e1238761aca7778318b363232\",\n            \"version-id\": \"a7diKodKIlW3mHIvhGvVphz5N_ZcL3RG\",\n            \"sequencer\": \"00618F003B7286F496\"\n        },\n        \"request-id\": \"4Z2S00BKW2P1AQK8\",\n        \"requester\": \"348414629041\",\n        \"source-ip-address\": \"72.21.198.68\",\n        \"reason\": \"PutObject\"\n    }</code></pre> \n</div> \n<p>My initial event pattern was very simple, and matched only the bucket name. I can use <a href=\"https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-event-patterns-content-based-filtering.html\">content-based filtering</a> to write more complex and more interesting patterns. For example, I could use<a href=\"https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-event-patterns-content-based-filtering.html#filtering-numeric-matching\"> numeric matching</a> to set up a pattern that matches events for objects that are smaller than 1 megabyte:</p> \n<div> \n <pre><code>{\n    \"source\": [\n        \"aws.s3\"\n    ],\n    \"detail-type\": [\n        \"Object Created\",\n        \"Object Deleted\",\n        \"Object Tags Added\",\n        \"Object Tags Deleted\"\n    ],\n\n    \"detail\": {\n        \"bucket\": {\n            \"name\": [\n                \"jbarr-public\"\n            ]\n        },\n        \"object\" : {\n            \"size\": [{\"numeric\" :[\"&lt;=\", 1048576 ] }]\n        }\n    }\n}</code></pre> \n</div> \n<p>Or, I could use prefix matching to set up a pattern that looks for objects uploaded to a “subfolder” (which doesn’t really exist) of a bucket:</p> \n<pre><code>\"object\": {\n  \"key\" : [{\"prefix\" : \"uploads/\"}]\n  }]\n}</code></pre> \n<p>You can use all of this in conjunction with all of the existing EventBridge features, including Archive/Replay. You can also access the CloudWatch metrics for each of your rules:</p> \n<p><img src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2021/11/13/eb_cw_metrics_1.png\" /></p> \n<p><span><strong>Available Now</strong></span><br /> This feature is available now and you can start using it today in all commercial AWS Regions. You pay $1 for every 1 million events that match a rule; check out the <a href=\"https://aws.amazon.com/eventbridge/pricing/\">EventBridge Pricing</a> page for more information.</p> \n<p>— <a href=\"https://twitter.com/jeffbarr\">Jeff</a>;</p>","author":"Jeff Barr","siteTitle":"AWS News Blog","siteHash":"6093e072e4117ec22616e844cb857d03ca62c57a411a8affc77cb5e8b6b15bf6","entryHash":"88f5ca4e857ab891eef75e1c3c7518f1d7052c61d52989b9954cd4bf5fe209ce","category":"Tech"}