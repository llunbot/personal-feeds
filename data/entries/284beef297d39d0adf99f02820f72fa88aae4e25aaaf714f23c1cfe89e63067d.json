{"title":"[AWS EKS] ลองใช้ Cluster autoscaler สำหรับ Scale K8s","link":"https://thanapon.info/aws-eks-cluster-autoscaler/?utm_source=rss&utm_medium=rss&utm_campaign=aws-eks-cluster-autoscaler","date":1699783754000,"content":"<p>ก่อนอื่นต้องเกริ่นก่อนครับ พอดีตอนนี้ในทีมได้มีโอกาสใช้ K8s ในการ deploy service ขึ้นไปใช้งานภายในบริษัท ซึ่งปกติตอนที่เรา Provision cluster ขึ้นมานั้น K8s Cluster พวกนี้ก็ไม่ได้เพิ่ม tools สำหรับการทำ Auto scaling เข้ามาให้ด้วย จากเดิมปกติถ้าเราทำการ config EKS นั้นมันก็จะมีให้สร้าง Node group อะไรต่างๆบลาๆๆ โดยที่ภายใน Node group ที่สร้างนั้นมันก็มีให้ระบุ Desired, Minimum และ Maximum เพื่อให้ Node group แต่ละตัวมันสามารถ Scale ได้ แต่วิธีการ Scale เราจะต้องไปปรับเองแบบ Manual นะสิ! แบบนี้ก็เกิดปัญหาเลยสิถ้าจะต้องมีคนมาเฝ้าดูการทำงานของ Container ทั้งวันทั้งคืน <strong><em>“ทีนี้ก็ลำบาก ก็ว้าวุ่นกันทีเดียว”</em></strong></p>\n\n\n<div>\n<figure><img width=\"1024\" height=\"552\" src=\"https://thanapon.info/wp-content/uploads/2023/10/image-2-1024x552.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/10/image-2-1024x552.png 1024w, https://thanapon.info/wp-content/uploads/2023/10/image-2-300x162.png 300w, https://thanapon.info/wp-content/uploads/2023/10/image-2-768x414.png 768w, https://thanapon.info/wp-content/uploads/2023/10/image-2-1536x828.png 1536w, https://thanapon.info/wp-content/uploads/2023/10/image-2-600x323.png 600w, https://thanapon.info/wp-content/uploads/2023/10/image-2.png 1644w\" /></figure></div>\n\n\n<blockquote>\n<p>ซึ่งวิธีการ Scale แบบนี้ในฝั่งของ Kubernetes จะเรียกว่าการ Scale แบบ Vertical scaling ซึ่งก็คือการเพิ่ม CPU/Memory เข้าไปใน K8s Cluster เพื่อให้ Cluster นั้นสามารถรัน pod ได้เยอะๆ</p>\n</blockquote>\n\n\n\n<p>จากปัญหาข้างต้น AWS เขาก็ได้แนะนำวิธีการ Auto scaling node ที่รันอยู่ใน EKS Cluster ด้วยกัน 2 วิธี</p>\n\n\n\n<ul>\n<li><strong>Karpenter</strong> คือ Opensource tools ตัวหนึ่งที่เราจะต้องทำการ setup ลงไปใน cluster ของเราเพื่อให้มัน <strong>Watching</strong>, <strong>Evaluating</strong>, <strong>Provisioning</strong> และ <strong>Removing</strong> ตัว worker node โดยที่มันก็ถูกสร้างเพื่อให้ใช้งานกับ AWS เท่านั้น</li>\n</ul>\n\n\n<div>\n<figure><img width=\"1024\" height=\"457\" src=\"https://thanapon.info/wp-content/uploads/2023/10/image.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/10/image.png 1024w, https://thanapon.info/wp-content/uploads/2023/10/image-300x134.png 300w, https://thanapon.info/wp-content/uploads/2023/10/image-768x343.png 768w, https://thanapon.info/wp-content/uploads/2023/10/image-600x268.png 600w\" /></figure></div>\n\n\n<ul>\n<li><strong>Cluster Autoscaler</strong> เป็น Tools สำหรับ scaling node เหมือนกับ Karpenter หล่ะแต่ข้อแตกต่างคือมัน Support กับ Cloud provider เกือบทุกเจ้าเลยมั้ง ส่วนวิธีการ setup อาจจะต้องไปดูในแต่ละเจ้าเองว่าเหมือนกันไหม แต่หลักๆเราจะต้องไปเพิ่ม Permission อะไรต่างๆให้ service ตัวนี้ก่อน ซึ่งในบทความนี้เราจะมา setup kubernetes cluster autoscaler กันผ่าน Helm กับ Terraform บน AWS EKS</li>\n</ul>\n\n\n<div>\n<figure><img width=\"741\" height=\"387\" src=\"https://thanapon.info/wp-content/uploads/2023/10/image-1.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/10/image-1.png 741w, https://thanapon.info/wp-content/uploads/2023/10/image-1-300x157.png 300w, https://thanapon.info/wp-content/uploads/2023/10/image-1-600x313.png 600w\" /></figure></div>\n\n\n<h3>ก่อนเริ่มกันมาเช็ค Tools ที่ต้องใช้กันก่อน</h3>\n\n\n\n<ul>\n<li>Terraform ซึ่งผมจะใช้เป็น version 1.5.7</li>\n</ul>\n\n\n<div>\n<figure><img loading=\"lazy\" width=\"1024\" height=\"271\" src=\"https://thanapon.info/wp-content/uploads/2023/10/image-3-1024x271.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/10/image-3-1024x271.png 1024w, https://thanapon.info/wp-content/uploads/2023/10/image-3-300x79.png 300w, https://thanapon.info/wp-content/uploads/2023/10/image-3-768x203.png 768w, https://thanapon.info/wp-content/uploads/2023/10/image-3-600x159.png 600w, https://thanapon.info/wp-content/uploads/2023/10/image-3.png 1112w\" /></figure></div>\n\n\n<h3>มาเริ่มกันดีกว่า</h3>\n\n\n\n<p>เริ่มจากมา Clone project ของผมที่อยู่ใน Github ก่อน ซึ่งจะอยู่ในนี้ </p>\n\n\n\n<blockquote>\n<p><a href=\"https://github.com/toygame/terraform-cluster-autoscaler/tree/main\" target=\"_blank\">terraform-cluster-autoscaler</a></p>\n\n\n\n<p>Terraform deploy K8s Cluster-autoscaler with Helm</p>\n<cite>https://github.com/toygame/terraform-cluster-autoscaler.git</cite></blockquote>\n\n\n\n<h3>อธิบาย Terraform คร่าวๆก่อน</h3>\n\n\n\n<p>จาก Repo ข้างบนนี้หลักๆเลยเราจะทำการ Provision 3 module ใหญ่ด้วยกันคือ</p>\n\n\n\n<ul>\n<li>VPC</li>\n\n\n\n<li>AWS EKS</li>\n\n\n\n<li>Cluster autoscaler with Helm</li>\n</ul>\n\n\n\n<p>ส่วน module/resource อื่นๆจะเป็นแค่ส่วน Support การทำ Autoscaling เฉยๆ</p>\n\n\n\n<h4>Module VPC</h4>\n\n\n<div>\n<figure><img loading=\"lazy\" width=\"1024\" height=\"932\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-1024x932.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-1024x932.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-300x273.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-768x699.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-1536x1399.png 1536w, https://thanapon.info/wp-content/uploads/2023/11/image-600x546.png 600w, https://thanapon.info/wp-content/uploads/2023/11/image.png 1744w\" /></figure></div>\n\n\n<p>จาก code block ด้านบนจะเป็นการ provision VPC ที่เราต้องการจะให้ EKS cluster เราไป provision ในนั้นซึ่งจะมีการสร้าง Public/Private subnet ต่างๆและพวก Nat gateway กับ Internet gateway ต่างๆด้วยกัน อ่ออีกเรื่องจะเป็น Available zone[az] เพื่อทำ HA โดยที่ EKS กำหนดไว้ว่า az จะต้องมีตั้งแต่ 2 az ขึ้นไป</p>\n\n\n\n<h4>Module EKS</h4>\n\n\n\n<p>หลังจากนั้นเมื่อมายัง Module EKS เบื้องต้นผมจะกำหนดให้มันสร้าง Node group ขึ้นมา 2 Node group ซึ่ง Group แรกจะเพิ่ม Label เป็น “asg-group”: “group1” และเพิ่ม Tag เพื่อบอกให้ cluster-autoscaler มา Scale node group นี้</p>\n\n\n\n<ul>\n<li>Node group 1</li>\n</ul>\n\n\n<div>\n<figure><img loading=\"lazy\" width=\"1024\" height=\"607\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-1-1024x607.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-1-1024x607.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-1-300x178.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-1-768x455.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-1-1536x910.png 1536w, https://thanapon.info/wp-content/uploads/2023/11/image-1-600x356.png 600w, https://thanapon.info/wp-content/uploads/2023/11/image-1.png 2032w\" /></figure></div>\n\n\n<ul>\n<li>Node group 2</li>\n</ul>\n\n\n\n<p>ส่วน Node group ที่ 2 นั้นจะเพิ่มส่วน taints/tolerance ขึ้นมาเผื่อในกรณีที่เราอยากจะให้ Node ที่รันใน Node group นี้รัน Hardware ชนิดพิเศษเช่น ต้องการใช้ GPU เพื่อรัน Model อะไรบลาๆซึ่ง cost ของ Node ประเภทนี้จะมีราคาสูงกว่าปกติมาก</p>\n\n\n<div>\n<figure><img loading=\"lazy\" width=\"1024\" height=\"703\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-2-1024x703.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-2-1024x703.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-2-300x206.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-2-768x527.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-2-1536x1054.png 1536w, https://thanapon.info/wp-content/uploads/2023/11/image-2-2048x1405.png 2048w, https://thanapon.info/wp-content/uploads/2023/11/image-2-600x412.png 600w\" /></figure></div>\n\n\n<p></p>\n\n\n\n<h4>Helm Cluster autoscaler</h4>\n\n\n\n<p>ทำการ Release helm chart โดยที่เราจะต้องกำหนด </p>\n\n\n\n<blockquote>\n<ul>\n<li>awsRegion: กำหนด Region ที่ใช้งานอยู่</li>\n\n\n\n<li>rbac.serviceAccount.name:  ชื่อ Service account</li>\n\n\n\n<li>rbac.serviceAccount.annotations.eks.amazonaws.com/role-arn: Service account Role-Arn</li>\n\n\n\n<li>autoDiscovery.clusterName: กำหนดชื่อ EKS cluster</li>\n\n\n\n<li>autoDiscovery.enabled: Enable auto-discovory</li>\n\n\n\n<li>rbac.create: เพื่อสร้าง RBAC resources</li>\n</ul>\n</blockquote>\n\n\n<div>\n<figure><img loading=\"lazy\" width=\"948\" height=\"1024\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-3-948x1024.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-3-948x1024.png 948w, https://thanapon.info/wp-content/uploads/2023/11/image-3-278x300.png 278w, https://thanapon.info/wp-content/uploads/2023/11/image-3-768x829.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-3-1423x1536.png 1423w, https://thanapon.info/wp-content/uploads/2023/11/image-3-600x648.png 600w, https://thanapon.info/wp-content/uploads/2023/11/image-3.png 1782w\" /></figure></div>\n\n\n<p></p>\n\n\n\n<h3>Running Terraform</h3>\n\n\n\n<p>เริ่มทำการ Init terraform เพื่อให้ Terraform package ของเราทำการ list dependencies ต่างๆโดยใช้คำสั่ง</p>\n\n\n\n<p><em><mark>ในกรณีที่เราต้องการ parse variable ลงไปด้วยเราจะต้องใช้คำสั่ง “-var-file=ชื่อไฟล์.tfvars”</mark></em></p>\n\n\n\n<div><pre><code>terraform init</code></pre></div>\n\n\n<div>\n<figure><img loading=\"lazy\" width=\"1024\" height=\"468\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-4-1024x468.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-4-1024x468.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-4-300x137.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-4-768x351.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-4-600x274.png 600w, https://thanapon.info/wp-content/uploads/2023/11/image-4.png 1482w\" /></figure></div>\n\n\n<p>เช็คความถูกต้องของ Terraform รวมทั้ง preview resource ที่จะทำการ deploy</p>\n\n\n\n<div><pre><code>terraform plan</code></pre></div>\n\n\n<div>\n<figure><img loading=\"lazy\" width=\"1024\" height=\"543\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-7-1024x543.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-7-1024x543.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-7-300x159.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-7-768x407.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-7-1536x815.png 1536w, https://thanapon.info/wp-content/uploads/2023/11/image-7-600x318.png 600w, https://thanapon.info/wp-content/uploads/2023/11/image-7.png 1832w\" /></figure></div>\n\n\n<p>เมื่อเช็คดู Resource ที่จะ deploy ผ่าน terraform plan แล้วไม่มีปัญหาอะไรก็ทำการ Deploy จริงๆโลด</p>\n\n\n\n<div><pre><code>terraform apply</code></pre></div>\n\n\n\n<p>รอจนกว่าจะ deploy เสร็จสิ้นอาจจะใช้เวลานานนิดนึงนะครับ</p>\n\n\n\n<h3>ทดสอบ Deploy Pod ลงไปใน Cluster ดูสิ่</h3>\n\n\n<div>\n<figure><img loading=\"lazy\" width=\"835\" height=\"1024\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-16-835x1024.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-16-835x1024.png 835w, https://thanapon.info/wp-content/uploads/2023/11/image-16-245x300.png 245w, https://thanapon.info/wp-content/uploads/2023/11/image-16-768x942.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-16-1253x1536.png 1253w, https://thanapon.info/wp-content/uploads/2023/11/image-16-600x736.png 600w, https://thanapon.info/wp-content/uploads/2023/11/image-16.png 1530w\" /></figure></div>\n\n\n<p>ลอง Deploy deployment ดูสิ่ โดยที่ผมจะกำหนด replicas=0 ก่อน ส่วน Resource ที่ Pod แต่ละตัวใช้จะเป็น CPU: 1CPU/Memory: 1Gi</p>\n\n\n\n<div><pre><code>kubectl apply -f k8s/deployment.yaml</code></pre></div>\n\n\n\n<p>เสร็จแล้วก็ลอง Scale Pod ขึ้นมาเป็น 5 Pod </p>\n\n\n\n<div><pre><code>kubectl scale deployment inflate --replicas 5</code></pre></div>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"331\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-9-1024x331.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-9-1024x331.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-9-300x97.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-9-768x248.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-9-1536x497.png 1536w, https://thanapon.info/wp-content/uploads/2023/11/image-9-2048x662.png 2048w, https://thanapon.info/wp-content/uploads/2023/11/image-9-600x194.png 600w\" /></figure>\n\n\n\n<p>หลังจากที่เราทำการ scale pod ขึ้นมา 5 pod นั้น จากรูป cluster มันจะงอแงว่า ไม่มี Node ตัวไหนที่ว่างจะ schdule pod ตัวนี้แล้วนะ จากนั้น cluster-autoscaler จะทำการ trigger node ขึ้นมาใหม่เพื่อให้มันสร้าง Node เพื่อให้รองรับกับจำนวน Pod ที่เพิ่มเข้ามาใหม่นั้นเอง โดยที่การ scale จะอ้างอิงกับ Autoscaling group ที่เราสร้างไว้ใน Nodegroup ตอนที่ deploy EKS ขึ้นมา</p>\n\n\n\n<p>ผลลัพธ์ก็จะได้ Pod ขึ้นมาใหม่ 5 Pod พร้อมกับ Node ขึ้นมาใหม่อีก 2 Node (ip-10.0.1.176, ip-10.0.2.151) เช่นกัน</p>\n\n\n\n<blockquote></blockquote>\n\n\n\n<p><em><strong>Node</strong></em></p>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"131\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-11-1024x131.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-11-1024x131.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-11-300x38.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-11-768x98.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-11-1536x197.png 1536w, https://thanapon.info/wp-content/uploads/2023/11/image-11-2048x263.png 2048w, https://thanapon.info/wp-content/uploads/2023/11/image-11-600x77.png 600w\" /></figure>\n\n\n\n<p><em><strong>Pod</strong></em></p>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"190\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-13-1024x190.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-13-1024x190.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-13-300x56.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-13-768x143.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-13-1536x286.png 1536w, https://thanapon.info/wp-content/uploads/2023/11/image-13-2048x381.png 2048w, https://thanapon.info/wp-content/uploads/2023/11/image-13-600x112.png 600w\" /></figure>\n\n\n\n<blockquote><div>\n<figure><img loading=\"lazy\" width=\"1024\" height=\"456\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-15-1024x456.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-15-1024x456.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-15-300x134.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-15-768x342.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-15-600x267.png 600w, https://thanapon.info/wp-content/uploads/2023/11/image-15.png 1418w\" /></figure></div><cite>ทำไมต้องเป็น 2 Node เพราะว่า Resource ของ EC2 instance type ที่เราใช้แต่ละตัวจะถูกกำหนดไว้ที่ CPU=3.9 CPU, Memory=6.6GB ซึ่งตัว Pod ของเรามันทำการจอง resource ไว้ที่ 1 CPU/Memory 1 Gi ก็ถ้าหารกันตรงๆเลยก็จะใช้ Node ประมาณ 2 Node นั้นเอง</cite></blockquote>\n\n\n\n<p>จากนั้นลองทำการ Scale down Pod ลงมาเป็น 0 replica ซึ่งในขั้นตอนนี้เราจะทำให้ Node ที่มันเพิ่ง Scale up มาเมื่อกี้ unregister ออกจาก Cluster ของเรา</p>\n\n\n\n<div><pre><code>kubectl scale deployment inflate --replicas 0</code></pre></div>\n\n\n\n<p>จากนั้นรอประมาณ 10 นาที (Default value) เพื่อให้ Cluster เรา unregister worker node ออกไปตามรูปข้างล่างนี้</p>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"218\" src=\"https://thanapon.info/wp-content/uploads/2023/11/image-14-1024x218.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/11/image-14-1024x218.png 1024w, https://thanapon.info/wp-content/uploads/2023/11/image-14-300x64.png 300w, https://thanapon.info/wp-content/uploads/2023/11/image-14-768x163.png 768w, https://thanapon.info/wp-content/uploads/2023/11/image-14-1536x327.png 1536w, https://thanapon.info/wp-content/uploads/2023/11/image-14-2048x436.png 2048w, https://thanapon.info/wp-content/uploads/2023/11/image-14-600x128.png 600w\" /></figure>\n\n\n\n<p>เย้ เสร็จสิ้นการทำ Cluster autoscaler แล้วเป็นยังไงบ้างครับ หวังว่าท่านผู้อ่านน่าจะได้ประโยชน์จากบทความนี้นะครับ หากมีข้อสงสัยเพิ่มเติมหรือต้องการแนะนำการใช้งานสามารถติดต่อมาได้เลยนะครับ สำหรับวันนี้ขอบคุณและสวัสดีครับ <img src=\"https://s.w.org/images/core/emoji/14.0.0/72x72/1f601.png\" alt=\"😁\" /></p><p>The post <a href=\"https://thanapon.info/aws-eks-cluster-autoscaler/\">[AWS EKS] ลองใช้ Cluster autoscaler สำหรับ Scale K8s</a> first appeared on <a href=\"https://thanapon.info\">Thanapon</a>.</p>","author":"thanapon.tap","siteTitle":"Thanapon","siteHash":"6a039c2f54d76e4c49227d80968f2a30de5427cc57525c047c383ea3563cde5f","entryHash":"284beef297d39d0adf99f02820f72fa88aae4e25aaaf714f23c1cfe89e63067d","category":"Thai"}