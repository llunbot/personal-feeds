{"title":"ระบบเก็บล็อกของ Cloudflare เกิดบั๊ก ล่มไป 3.5 ชั่วโมง ทำล็อกของลูกค้าหายไป 55%","link":"https://www.blognone.com/node/143373","date":1732774610000,"content":"<div><div><div><p>Cloudflare เปิดเผยว่าบริการเก็บล็อกไฟล์ Cloudflare Logs ล่มไปราว 3.5 ชั่วโมงในวันที่ 14 พฤศจิกายน 2024 ส่งผลให้ไฟล์ล็อกสูญหายไป 55% ของไฟล์ล็อกทั้งหมดที่ควรเก็บในช่วงเวลานั้น</p>\n<p>บริการ Cloudflare Logs เป็นการเก็บล็อกไฟล์ของเหตุการณ์ต่างๆ ที่เกิดขึ้นในเครือข่าย เนื่องจากเครือข่ายของ Cloudflare ใหญ่มาก ในหนึ่งวันต้องเก็บล็อก 4.5 ล้านล้านครั้ง (นับตามอีเวนต์หรือเหตุการณ์ที่เกิดขึ้นและต้องบันทึกล็อก) และส่งข้อมูลล็อกเหล่านี้ให้กับลูกค้า</p>\n<p><img alt=\"No Description\" src=\"https://www.blognone.com/sites/default/files/externals/aa68ff2df0cca443e145a54d73f04706.png\" /></p>\n<p>กระบวนการจัดการล็อกของ Cloudflare ประกอบด้วยซอฟต์แวร์ 4 ตัว (ทั้งหมดเขียนด้วย Go) ทำงานต่อเนื่องกัน เริ่มจาก Logfwdr รับล็อกจากระบบของ Cloudflare มาส่งต่อเป็นแบตช์, Logreceiver รับข้อมูลแบตช์แล้วนำมาคัดแยกประเภท, Buftee ตัวจัดการบัฟเฟอร์เพื่อแยกงานเป็นส่วนๆ, Logpush นำล็อกในบัฟเฟอร์ไปส่งต่อให้ลูกค้า</p>\n<p><img alt=\"No Description\" src=\"https://www.blognone.com/sites/default/files/externals/210b73ab8b014c47b0f1e2debf209c5d.png\" /></p>\n<p>สาเหตุของปัญหาครั้งนี้เกิดจากทีม Cloudflare ไปเพิ่มประเภทของข้อมูลให้ Logpush ทำให้ต้องเพิ่มคอนฟิกเข้าไปใน Logfwdr ทราบด้วยว่าเป็นล็อกประเภทไหน แต่เกิดบั๊กในระบบทำให้ค่าคอนฟิกนี้กลายเป็นว่างเปล่า (blank) ทำให้ Logfwdr เข้าใจว่าไม่ต้องเก็บล็อกส่งให้เลย</p>\n<p>ทีมงาน Cloudflare ค้นพบปัญหานี้ และแก้ปัญหาได้ตั้งแต่ 5 นาทีแรก แต่ไม่ทันการณ์ เพราะบั๊กคอนฟิกว่างเปล่ากลับสร้างปัญหาที่สอง ไปเรียกโหมด failsafe ของ Logfwdr ให้ทำงาน ส่งอีเวนต์ล็อกของลูกค้าทุกคน แทนที่จะส่งเฉพาะลูกค้าตามค่าคอนฟิกไว้ ฟีเจอร์นี้ถูกสร้างขึ้นมานานตั้งแต่ Cloudflare คนใช้ไม่เยอะ เลยไม่ได้คิดถึงกรณีว่าการเก็บล็อกส่งให้ลูกค้าทุกคนจะสร้างทราฟฟิกมหาศาล ส่งผลสะเทือนต่อไปยังซอฟต์แวร์อื่นๆ ในคิว เช่น Buftee ต้องสร้างบัฟเฟอร์เพิ่ม 40 เท่าจากปกติ ระบบเกิดโอเวอร์โหลด และสุดท้ายทีมงานต้องรีเซ็ตระบบใหม่ทั้งหมด</p>\n<p><img alt=\"No Description\" src=\"https://www.blognone.com/sites/default/files/externals/8c7dd1d80abd3f878745df53947f91ba.png\" /></p>\n<p>Cloudflare ยอมรับว่าบั๊กในระบบ failsafe ของ Logfwdr เกิดจากการทดสอบที่ไม่บ่อยพอ เพื่อลองดูว่าระบบใหญ่ของ Cloudflare มีขีดความสามารถในการรองรับเหตุการณ์ผิดพลาดแบบนี้ได้หรือไม่ โดยจุดตายสำคัญอยู่ที่ Buftee ซึ่งควรทำหน้าที่เป็น \"บัฟเฟอร์\" กันชนความผิดพลาด แต่ตัวมันเองกับพังไปเองเมื่อเจอโหลดจำนวนมากๆ</p>\n<p>แนวทางแก้ไขของ Cloudflare คือการทำ overload test ทดสอบปัญหาระบบมีโหลดเพิ่มเยอะๆ เป็นประจำ เพื่อป้องกันไม่ให้ปัญหาแบบนี้เกิดขึ้นได้อีก</p>\n<p>ที่มา - <a href=\"https://blog.cloudflare.com/cloudflare-incident-on-november-14-2024-resulting-in-lost-logs/\">Cloudflare</a></p>\n</div></div></div><div><div>Topics: </div><div><div><a href=\"/topics/cloudflare\">Cloudflare</a></div><div><a href=\"/topics/service-outage\">Service Outage</a></div><div><a href=\"/topics/bug\">Bug</a></div></div></div>","author":"mk","siteTitle":"Blognone","siteHash":"ededadcf18490b3937e7dd89ebe8c00dc129addbdf1ebe4aff1f458146693da0","entryHash":"8dbbfb124d1cc429125c8c2db699ecb30172867cf906fa3a875d401ea374e836","category":"Thai"}