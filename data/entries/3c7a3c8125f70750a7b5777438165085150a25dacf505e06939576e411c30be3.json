{"title":"Amazon FSx for Lustre increases throughput to GPU instances by up to 12x","link":"https://aws.amazon.com/blogs/aws/amazon-fsx-for-lustre-unlocks-full-network-bandwidth-and-gpu-performance/","date":1732745617000,"content":"<p>Today, we are announcing support for <a href=\"https://aws.amazon.com/hpc/efa/\">Elastic Fabric Adapter (EFA)</a> and <a href=\"https://developer.nvidia.com/gpudirect-storage\">NVIDIA GPUDirect Storage (GDS)</a> on <a href=\"https://aws.amazon.com/fsx/lustre/\">Amazon FSx for Lustre</a>. EFA is a network interface for Amazon EC2 instances that makes it possible to run applications requiring high levels of inter-node communications at scale. GDS is a technology that creates a direct data path between local or remote storage and GPU memory. With these enhancements, Amazon FSx for Lustre with EFA/GDS support provides up to 12 times higher (up to 1200 Gbps) per-client throughput compared to the previous FSx for Lustre version.</p> \n<p>You can use FSx for Lustre to build and run the most performance demanding applications, such as deep learning training, drug discovery, financial modeling, and autonomous vehicle development. As datasets grow and new technologies emerge, you can adopt increasingly powerful GPU and HPC instances such as Amazon EC2 <a href=\"https://aws.amazon.com/ec2/instance-types/p5/\">P5</a>, <a href=\"https://aws.amazon.com/ec2/instance-types/trn1/\">Trn1</a>, and <a href=\"https://aws.amazon.com/ec2/instance-types/hpc7a/\">Hpc7a</a>. Until now, when accessing FSx for Lustre file systems, the use of traditional TCP networking limited throughput to 100 Gbps for individual client instances. This adoption is driving the need for FSx for Lustre file systems to provide the performance necessary to optimally utilize the increasing network bandwidth of these cutting-edge EC2 instances when accessing large datasets.</p> \n<p>With EFA and GDS support in FSx for Lustre, you can now achieve up to 1,200 Gbps throughput per client instance (twelve times more throughput than previously) when using P5 GPU instances and <a href=\"https://developer.nvidia.com/cuda-toolkit\">NVIDIA CUDA</a> in your applications.</p> \n<p>With this new capability, you can fully utilize the network bandwidth of the most powerful compute instances and accelerate your <a href=\"https://aws.amazon.com/ai/machine-learning/\">machine learning (ML)</a> and <a href=\"https://aws.amazon.com/hpc/\">HPC</a> workloads. EFA enhances performance by bypassing the operating system and using the <a href=\"https://ieeexplore.ieee.org/document/9167399\">AWS Scalable Reliable Datagram (SRD) protocol</a> to optimize data transfer. GDS further improves performance by enabling direct data transfer between the file system and GPU memory, bypassing the CPU and eliminating redundant memory copies.</p> \n<p>Let’s see how this works in practice.</p> \n<p><span><strong>Creating an Amazon FSx for Lustre file system with EFA enabled<br /> </strong></span>To get started, in the <a href=\"https://us-east-2.console.aws.amazon.com/fsx/home#landing\">Amazon FSx console</a>, I choose <strong>Create file system</strong> and then <strong>Amazon FSx for Lustre</strong>.</p> \n<p>I enter a name for the file system. In the <strong>Deployment and storage type</strong> section, I select <strong>Persistent, SSD</strong> and the new <strong>with EFA enabled</strong> option. I select <strong>1000 MB/s/TiB</strong> in the <strong>Throughput per unit of storage</strong> section. With these settings, I enter 4.8 TiB for <strong>Storage capacity</strong>, which is the minimum supported with these settings.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/fsx-lustre-efa.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/fsx-lustre-efa.png\" alt=\"Console screenshot.\" width=\"1195\" height=\"1039\" /></a></p> \n<p>For networking, I use the <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/default-vpc.html\">default virtual private cloud (VPC)</a> and an <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/efa-start.html#efa-start-security\">EFA-enabled security group</a>. I leave all other options to their default values.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/fsx-lustre-efa-security-group.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/fsx-lustre-efa-security-group.png\" alt=\"Console screenshot.\" width=\"1195\" height=\"423\" /></a></p> \n<p>I review all the options and proceed to create the file system. After a few minutes, the file system is ready to be used.</p> \n<p><span><strong>Mounting an Amazon FSx for Lustre file system with EFA enabled from an Amazon EC2 instance<br /> </strong></span>In the <a href=\"https://console.aws.amazon.com/ec2\">Amazon EC2 console</a>, I choose <strong>Launch instance</strong>, enter a name for the instance, and select the Ubuntu Amazon Machine Image (AMI). For <strong>Instance type</strong>, I select <strong>trn1.32xlarge</strong>.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/ec2-launch-instance-type.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/ec2-launch-instance-type.png\" alt=\"Console screenshot.\" width=\"967\" height=\"275\" /></a></p> \n<p>In <strong>Network settings</strong>, I edit the default settings and select the same subnet used by the FSx Lustre file system. In <strong>Firewall (security groups)</strong>, I select three existing security groups: the EFA-enabled security group used by the FSx for Lustre file system, the default security group, and a security group that provides Secure Shell (SSH) access.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/ec2-launch-networking.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/ec2-launch-networking.png\" alt=\"Console screenshot.\" width=\"967\" height=\"689\" /></a></p> \n<p>In <strong>Advanced network configuration</strong>, I select <strong>ENA and EFA</strong> as <strong>Interface type</strong>. Without this setting, the instance would use traditional TCP networking and the connection with the FSx for Lustre file system would still be limited to 100 Gbps in throughput.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/ec2-launch-networking-advanced.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/11/07/ec2-launch-networking-advanced.png\" alt=\"Console screenshot.\" width=\"967\" height=\"777\" /></a></p> \n<p>To have more throughput, I can add more EFA network interfaces, depending on the instance type.</p> \n<p>I launch the instance and, when the instance is ready, I connect using <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/connect-linux-inst-eic.html\">EC2 Instance Connect</a> and follow the instructions for <a href=\"https://docs.aws.amazon.com/fsx/latest/LustreGuide/install-lustre-client.html\">installing the Lustre client in the FSx for Lustre User Guide</a> and <a href=\"https://docs.aws.amazon.com/fsx/latest/LustreGuide/configure-efa-clients.html\">configuring EFA clients</a>.</p> \n<p>Then, I follow the instructions for <a href=\"https://docs.aws.amazon.com/fsx/latest/LustreGuide/mounting-ec2-instance.html\">mounting an FSx for Lustre file system from an EC2 instance</a>.</p> \n<p>I create a folder to use as mount point:</p> \n<div> \n <pre><code>sudo mkdir -p /fsx</code></pre> \n</div> \n<p>I select the file system in the FSx console and lookup the <strong>DNS name</strong> and <strong>Mount name</strong>. Using these values, I mount the file system:</p> \n<div> \n <pre><code>sudo mount -t lustre -o relatime,flock file_system_dns_name@tcp:/mountname /fsx</code></pre> \n</div> \n<p>EFA is automatically used when you access an EFA-enabled file system from client instances that support EFA and are using Lustre version 2.15 or higher.</p> \n<p><span><strong>Things to know<br /> </strong></span>EFA and GDS support is available today with no additional cost on new <a href=\"https://aws.amazon.com/fsx/lustre/\">Amazon FSx for Lustre</a> file systems in all <a href=\"https://aws.amazon.com/about-aws/global-infrastructure/regions_az/\">AWS Regions</a> where persistent 2 is offered. FSx for Lustre automatically uses EFA when customers access an EFA-enabled file system from client instances that support EFA, without requiring any additional configuration. For a list of EC2 client instances that support EFA, see <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/efa.html#efa-instance-types\">supported instance types</a> in the Amazon EC2 User Guide. This <a href=\"https://docs.aws.amazon.com/ec2/latest/instancetypes/ac.html#ac_network\">network specifications table</a> describes network bandwidths and EFA support for instance types in the accelerated computing category.</p> \n<p>To use EFA-enabled instances with FSx for Lustre file systems, you must use Lustre 2.15 clients on Ubuntu 22.04 with kernel 6.8 or higher.</p> \n<p>Note that your client instances and your file systems must be located in the same subnet within your <a href=\"https://aws.amazon.com/vpc/\">Amazon Virtual Private Cloud (Amazon VPC) connection</a>.</p> \n<p>GDS is automatically supported on EFA-enabled file systems. To use GDS with your FSx for Lustre file systems, you need the <a href=\"https://developer.nvidia.com/cuda-toolkit\">NVIDIA Compute Unified Device Architecture (CUDA) package</a>, the <a href=\"https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#nvidia-open-gpu-kernel-modules\">open source NVIDIA driver</a>, and the <a href=\"https://github.com/NVIDIA/gds-nvidia-fs\">NVIDIA GPUDirect Storage Driver</a> installed on your client instance. These packages come preinstalled on the <a href=\"https://aws.amazon.com/ai/machine-learning/amis/\">AWS Deep Learning AMI</a>. You can then use your CUDA-enabled application to use GPUDirect storage for data transfer between your file system and GPUs.</p> \n<p>When planning your deployment, note that EFA-enabled file systems have larger minimum storage capacity increments than file systems that are not EFA-enabled. For instance, if you choose the 1,000 MB/s/TiB throughput tier, the minimum storage capacity for EFA-enabled file systems starts at 4.8 TiB as compared to 1.2TB for FSx for Lustre file systems not enabling EFA. If you’re looking to migrate your existing workloads, you can use <a href=\"https://aws.amazon.com/datasync/\">AWS DataSync</a> to move your data from an existing file system to a new one that supports EFA and GDS.</p> \n<p>For maximum flexibility, FSx for Lustre maintains compatibility with both EFA and non-EFA workloads. When accessing an EFA-enabled file system, traffic from non-EFA client instances automatically flows over traditional TCP/IP networking using <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking-ena.html\">Elastic Network Adapter (ENA)</a>, allowing seamless access for all workloads without any additional configuration.</p> \n<p>To learn more about EFA and GDS support on FSx for Lustre, including detailed setup instructions and best practices, visit the <a href=\"https://docs.aws.amazon.com/fsx/latest/LustreGuide/what-is.html\">Amazon FSx for Lustre documentation</a>. Get started today and experience the fastest storage performance available for your GPU instances in the cloud.</p> \n<p>— <a href=\"https://twitter.com/danilop\">Danilo</a></p> \n<p><em>Update 11/27: post updated to reflect 12x throughput</em></p>","author":"Danilo Poccia","siteTitle":"AWS News Blog","siteHash":"6093e072e4117ec22616e844cb857d03ca62c57a411a8affc77cb5e8b6b15bf6","entryHash":"3c7a3c8125f70750a7b5777438165085150a25dacf505e06939576e411c30be3","category":"Tech"}