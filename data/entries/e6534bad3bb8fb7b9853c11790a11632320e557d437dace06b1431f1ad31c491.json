{"title":"Solving CLS Issues In A Next.js-Powered E-Commerce Website (Case Study)","link":"https://smashingmagazine.com/2021/10/nextjs-ecommerce-cls-case-study/","date":1634565600000,"content":"<p>Fairprice is one of the largest online grocery stores in Singapore. We are continuously looking out for areas of opportunities to improve the user’s online shopping experience. Performance is one of the core aspects to ensure our users are having a delightful user experience irrespective of their devices or network connection. </p>\n<p>There are many key performance indicators (KPI) that measure different points during the lifecycle of the web page (such as TTFB, <code>domInteractive</code>and <code>onload</code>), but these metrics don’t reflect how the end-user experiences the page.</p>\n<p>We wanted to use a few KPIs which correspond closely to the actual experience of the end-users so we know that if any of those KPIs are not performing well, then it will be directly impacting the end-user experience. We found out <a href=\"https://web.dev/user-centric-performance-metrics/\">user-centric performance metrics</a> to be the perfect fit for this purpose.</p>\n<p>There are many user-centric performance metrics to measure different points in a page’s life cycle such as FCP, LCP, FID, CLS, and so on. For this case study, we are mainly going to focus on CLS.</p>\n<p>CLS measures the total score of all unexpected layout shifts happening between when the page starts loading and till it is unloaded.</p>\n<p>Therefore having a low CLS value for a page ensures there are no random layout shifts causing user frustration. <a href=\"https://twitter.com/tunetheweb\">Barry Pollard</a> has written an <a href=\"https://www.smashingmagazine.com/2021/06/how-to-fix-cumulative-layout-shift-issues/\">excellent in-depth article</a> about CLS.</p>\nHow We Discovered CLS Issue In Our Product Page\n<p>We use Lighthouse and WebPagetest as our synthetic testing tools for performance to measure CLS. We also use the <a href=\"https://github.com/GoogleChrome/web-vitals\">web-vitals library</a> to measure CLS for real users. Apart from that, we check the Google Search Console Core Web Vitals Report section to get an idea of any potential CLS issues in any of our pages. While exploring the report section, we found many URLs from the product detail page had more than <strong>0.1</strong> CLS value hinting there is some major layout shift event happening there.</p>\nDebugging CLS Issue Using Different Tools\n<p>Now that we know that there is a CLS issue on the product detail page, the next step was to identify which element was causing it. At first, we decided to run some tests using synthetic testing tools.</p>\n<p>So we ran the lighthouse to check if it could find any element which could be triggering a major layout shift, it <a href=\"https://www.webpagetest.org/lighthouse.php?test=210107_DiRV_60b8ba6d013639239b13e1de189dd0b8&amp;run=2\">reported</a> CLS to .004 which is quite low.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4f8ecbff-1e39-4089-8017-a43ac59a25bf/1-cls-case-study.png\" /></p>\n<p>The Lighthouse report page has a diagnostic section. That also did not show any element causing a high CLS value.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a0ea0aed-4442-4840-bcf3-e205bd3ad70e/3-cls-case-study.png\" /></p>\n<p>Then we ran WebpageTest and decided to check the filmstrip view:</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/58045ece-9507-4da3-9532-fbd6b738665f/2-cls-case-study.png\" /></p>\n<p>We find this feature very helpful since we can find out which element at which point in time caused the layout to shift. But when we run the <a href=\"https://www.webpagetest.org/video/compare.php?tests=210107_DiRV_60b8ba6d013639239b13e1de189dd0b8-r%3A1-c%3A0&amp;highlightCLS=1&amp;thumbSize=600&amp;ival=100&amp;end=visual\">test</a> to see if any layout shifts are highlighted, there wasn’t anything contributing to the huge LCS:</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a1bae325-a97a-4977-8213-514b04ddbf83/7-cls-case-study.png\" /></p>\n<p>The quirk with CLS is that it records individual layout shift scores during the entire lifespan of the page and adds them.</p>\n<p><strong>Note</strong>: <em>How CLS is measured has been <a href=\"https://web.dev/evolving-cls/\">changed</a> since June 2021.</em></p>\n<p>Since Lighthouse and WebpageTest couldn’t detect any element that triggered a major layout shift which means it was happening after the initial page load possibly due to some user action. So we decided to use <a href=\"https://chrome.google.com/webstore/detail/web-vitals/ahfhijdlegdabablpippeagghigmibma?hl=en\">Web Vitals Google Chrome extension</a> since it can record CLS on a page while the user is interacting with it. After performing different actions we found the layout shift score is getting increased when the user uses the image magnify feature.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/fa02dea2-1413-4b73-be38-2a1fe9fa5ff4/4-cls-case-study.png\" /></p>\n<p>I have also created a <a href=\"https://github.com/malaman/js-image-zoom/pull/31\">PR</a> to the original repo so that other developers using this library can get rid of the CLS issue.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/8582f573-1036-40de-8505-cce9c022dff7/6-cls-case-study.png\" /></p>\nThe Impact Of The Change\n<p>After the code was deployed to production, the CLS was fixed on the product details page and the number of pages impacted with CLS was reduced by 98%:</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/6491824c-8f20-402a-acd1-c394c8cf58f5/5-cls-case-study.jpg\" /></p>\n<p>Since we used <code>transform</code>, it also helped to make the image magnify a smoother experience to the users.</p>\n<p><strong>Note</strong>: <em>Paul Irish has written an excellent <a href=\"https://www.paulirish.com/2012/why-moving-elements-with-translate-is-better-than-posabs-topleft/\">article</a> on this topic.</em></p>\nOther Key Changes We Made For CLS\n<p>There are also some other issues we faced through many pages in our website which contribute to CLS. Let’s go through those elements and components and see how we tried to mitigate layout shifts arising from them.</p>\n<ul>\n<li><p><strong>Web-fonts:</strong><br />We have noticed that late loading of fonts causes user frustrations since the content flashes and it also causes some amount of layout shifts. To minimize this we have done few changes:</p>\n<ul>\n<li>We have self-hosted the fonts instead of loading from 3rd party CDN.</li>\n<li>We preload the fonts.</li>\n<li>We use font-display optional.</li>\n</ul>\n</li>\n<li><p><strong>Images:</strong><br />Missing height or width value in the image causes the element after the image to shift once the image is loaded. This ends up becoming a major contributor to CLS. Since we are using Next.js, we took advantage of the built-in image component called <a href=\"https://nextjs.org/docs/api-reference/next/image\"><code>next/images</code></a>. This component incorporates several image-related best practices. It is built on top of <code>&lt;img&gt;</code> HTML tag and can help to improve LCP and CLS. I highly recommend reading this <a href=\"https://github.com/vercel/next.js/discussions/16832\">RFC</a> to find out the key features and advantages of using it.</p>\n</li>\n<li><p><strong>Infinite Scroll:</strong><br />On our website, product listing pages have infinite scrolling. So initially, when users scroll to the bottom of the page they see a footer for a fraction of seconds before the next set of data is loaded, this causes layout shifts. To solve this we took few steps:</p>\n<ul>\n<li>We call the API to load data even before the user reaches the absolute bottom of the list.</li>\n<li>We have reserved enough space for the loading state and we show product skeletons during the loading status. So now when the user scrolls, they don’t see the footer for a fraction of seconds while the products are getting loaded.  </li>\n</ul>\n</li>\n</ul>\n<p>Addy Osmani has written a detailed <a href=\"https://addyosmani.com/blog/infinite-scroll-without-layout-shifts/\">article</a> on this approach which I highly recommend checking.</p>\nKey Takeaways\n<ul>\n<li>While Lighthouse and WebpageTest help to discover performance issues happening till page load, they can’t detect performance issues after page load.</li>\n<li>Web Vitals extensions can detect CLS changes triggered by user interactions so if a page has a high CLS value but Lighthouse or WebpageTest reports low CLS then the Web Vitals extension can help to pinpoint the issue.</li>\n<li>Google Search Console data is based on real users' data so that also can point to potential perf issues happening at any point in the life cycle of a page. Once an issue is detected and fixed, checking the report section again can help verify the effectiveness of the performance fix. The changes are reflected within days in the web vitals report section.</li>\n</ul>\nFinal Thoughts\n<p>While CLS issues are comparatively harder to debug, using a combination of different tools till page load (Lighthouse, WebPageTest) and Web Vitals extension (after page load) can help us pinpoint the issue. It is also one of the metrics which is going through lots of active development to cover a wide range of scenarios and this means that how it is measured is going to be changed in the future. We are following <a href=\"https://web.dev/evolving-cls/\">https://web.dev/evolving-cls/</a> to know about any upcoming changes.</p>\n<p>As for us, we are continuously working to improve other Core Web Vitals too. Recently, we have implemented responsive image preload and started serving images in WebP format which helped us to reduce 75% of image payload, reduce LCP by 62%, and Speed Index by 24%. You can read more details of <a href=\"https://medium.com/ne-digital/how-to-improve-lcp-and-speed-index-for-next-js-websites-f129ae776835\">optimization for improving LCP and Speed Index</a> or follow our <a href=\"https://medium.com/ne-digital\">engineering blog</a> to know about other exciting work we are doing.</p>\n<p><em>We would like to thank <a href=\"https://twitter.com/atcastle\">Alex Castle</a> for helping us debug the CLS issue on the product page and solve the quirks in the <code>next/images</code> implementation.</em></p>","author":"","siteTitle":"Articles on Smashing Magazine — For Web Designers And Developers","siteHash":"ab069ca35bf300e9db0da36f49701f66485a5b0d2db0471dfeee07cef6204939","entryHash":"e6534bad3bb8fb7b9853c11790a11632320e557d437dace06b1431f1ad31c491","category":"Tech"}