{"title":"Billing Management For Your Next SaaS Idea Using Stripe And Azure Functions","link":"https://smashingmagazine.com/2021/12/billing-management-saas-stripe-azure-functions/","date":1639747800000,"content":"<p>To follow the steps in this tutorial, you should have the following:</p>\n<ul>\n<li>a Stripe account (you can <a href=\"https://dashboard.stripe.com/register\">create</a> one for free and use the test mode to avoid incurring any charges while following the steps in this article);</li>\n<li>a basic understanding of JavaScript and React;</li>\n<li>an Auth0 account (you can <a href=\"https://auth0.com/signup?place=header&amp;type=button&amp;text=sign%20up\">sign up</a> for a free one).</li>\n</ul>\nIntroduction\n<p>Delivering a solution to users through <a href=\"https://www.salesforce.com/in/saas/\">software as a service</a> (Saas) often entails making use of cloud providers to host and deliver your entire infrastructure, usually comprising a back end and a front-end client. To offset the charges incurred from your cloud providers, a proper billing model for your users is needed in certain cases. In other scenarios, you might have products or services that you want to sell.</p>\n<p>The two applications in the aforementioned scenarios share a functional requirement, which is the <strong>ability to process the user’s payment</strong>. To achieve this, the developer could leverage an external payment infrastructure, such as <a href=\"https://stripe.com/\">Stripe</a>, <a href=\"https://squareup.com/us/en\">Square</a>, or <a href=\"https://pay.amazon.com/\">Amazon Pay</a>, among many others.</p>\n<p>In this article, we’ll look at Stripe and use its <a href=\"https://stripe.com/docs/api\">REST API</a> through Stripe’s <a href=\"https://www.npmjs.com/package/stripe\">Node.js package</a> to build an API layer comprising Azure Functions apps that can be executed by an HTTP trigger from a web, mobile, or desktop client. The API layer and the endpoints accessible through each of the functions are depicted in the diagram below.</p>\n<p><strong>Note</strong>: An Azure Functions app is an individual serverless function deployed and managed using the Azure Functions service. As depicted in the diagram below, a single project can comprise several Azure Functions apps.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f767369a-7560-4333-a849-5b035e151c0a/azure-functions-api-architecture.png\" /></p>\n<p>After building the API, we will clone an existing web application, built using React to display art paintings for sale. The APIs above will be used to retrieve the paintings as individual products, and the other endpoints will be used to handle payments.</p>\n<p><strong>Note</strong>: While this article makes use of <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/\">Azure Functions</a> as a provider of serverless functions, you can reuse the logic in your preferred provider, such as AWS’ <a href=\"https://aws.amazon.com/lambda/\">Lambda</a> or Google’s <a href=\"https://cloud.google.com/functions\">Cloud Functions</a>.</p>\nStripe Objects\n<p>Before going further, we should understand the Stripe objects that we’ll be creating in this article and what they represent. Below is a list of the five objects we will be working with:</p>\n<ol>\n<li><p><a href=\"https://stripe.com/docs/api/subscriptions\">subscription</a><br />A <code>subscription</code> object is created to charge users at intervals specified by the <code>billing_period</code> in the <code>price</code> object attached to the product. In this tutorial, we will have a product with a recurring price type, and we will subscribe users to it using the <code>subscription</code> object.</p>\n</li>\n<li><p><a href=\"https://stripe.com/docs/api/products\">product</a><br />A <code>product</code> object is used to represent a single item or service being sold, and the price of the product is stored in the <code>price</code> object. In this article, we will create a product using Stripe’s admin dashboard, then retrieve it through the Stripe API.</p>\n</li>\n<li><p><a href=\"https://stripe.com/docs/api/prices\">price</a><br />The <code>price</code> object is used to hold the price-related details of a product, such as currency, price, and billing cycle. In this article, we will again create the <code>price</code> object using Stripe’s admin dashboard, then retrieve it through the Stripe API.</p>\n</li>\n<li><p><a href=\"https://stripe.com/docs/api/payment_methods\">payment method</a><br />A <code>payment_method</code> object on Stripe is used to hold a customer’s payment details. In this tutorial, we will create a payment method on each transaction and use it together with a <code>payment_intent</code> object.</p>\n</li>\n<li><p><a href=\"https://stripe.com/docs/api/payment_intents/object\">payment intent</a><br />A <code>payment_intent</code> object is created to track the payment for a product from when it was created to when the payment is finally received. Each <code>payment_intent</code> object contains a <code>status</code> field to record the stage at which the payment is. In this article, we will use a <code>payment_intent</code> when a user purchases a product with a one-time pricing type.</p>\n</li>\n</ol>\nCreating a Stripe Profile for Your Business Idea\n<p>The first step to using Stripe is to create an account with your email address and a password, using Stripe’s online dashboard.</p>\n<p>Creating a Stripe account will launch the new business in test mode. We can liken test mode to your local development mode, because it allows you to create Stripe objects and test them using test credit cards provided by Stripe, without incurring charges.</p>\n<p>As shown in the Stripe dashboard for the sample application below, you can fill in an account name and other details to customize your service.  </p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/60334aa4-eec9-4348-a2fe-7be921b3b687/stripe-business-dashboard.png\" /></p>\n<p>The image above shows the dashboard for our newly created account. Note the highlighted box in the image above, because the section contains the keys that you would use when programmatically working with the Stripe account either through the API or a supported client library.</p>\n<p><strong>Note</strong>: Store the secret key in a secure notepad, because we will be using them when working with Stripe through a Node.js package from an Azure function in the next section.</p>\nCreating Sample Products on Stripe\n<p>To create a <code>product</code> object in Stripe, we can either use the REST API or Stripe’s web admin dashboard. In our case, the application’s owner is the sole manager of the products being sold; hence, we will use Stripe’s admin dashboard to create some sample products to be displayed in the demo application.</p>\n<p><strong>Note:</strong> When using <a href=\"https://stripe.com/docs/api\">Stripe’s Node.js package</a>, the <a href=\"https://stripe.com/docs/api/products/object\"><code>product</code> method</a> is used to perform CRUD operations on a <code>product</code> object.</p>\n<p>Using the top navigation bar in the Stripe dashboard’s home page, click the “Products” tab to navigate to the “Products” page. On the “Products” page, click the “Create Product” button at the top to create your first product in this Stripe business account.</p>\n<p>On the page for creating a product, write “Gallery Subscription” in the “Name” input field. Write some brief text in the “Description” input field, to be used as the product information. And put “150” in the “Price” input field, to be used as the price of the new product, as shown below.</p>\n<p><strong>Note:</strong> You can also click the “Image” box on the “Create Product” page to pick an image from your device to use as the image of the product.</p>\n<p>The image below shows the input fields on the “Create Product” page for the sample product we’re creating.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/6936f070-35c8-4753-968c-3a5318aa478c/stripe-create-recurring-product.png\" /></p>\n<p>From the image above, we can see that the “Recurring” option in the “Pricing details” is selected. This means that when a user is subscribed to this product, Stripe will automatically attempt to renew the subscription for the product at the end of the “billing period” specified in the “Pricing details” secton shown above. Click the “<a href=\"https://stripe.com/docs/issuing/testing\">Save Product</a>” button to save and continue.</p>\n<p>After saving the product, you will be redirected back to the “Products” page. Click the “Create Product” button again to create a product, specifying different information for the “Name”, “Description”, and “Pricing details”. This time, select the “One time” box in the “Pricing details” to enable a user to purchase this item once without being charged again for it.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/7b75d37f-f6c3-41de-9773-823a2a20d7ba/stripe-create-onetime-product.png\" /></p>\n<p>The image above shows a new product being created with a “one-time” price type. Notice that the “Billing period” dropdown menu is removed when the “One time” option is selected, unlike the first product that we created with a “Recurring” pricing type.</p>\n<p><strong>Note</strong>: You can continue to create more products with different names, descriptions, and pricing details, to populate the products in your Stripe business account.</p>\nCreating Azure Functions\n<p><a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/\">Azure Functions</a> are functions provided by <a href=\"https://azure.microsoft.com/en-us/\">Azure</a> for managing serverless event-driven code that can be executed through a defined <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-triggers-bindings?tabs=csharp\">event trigger</a>. All Azure functions that we’ll create in this article will use the <a href=\"https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook\">HTTP trigger</a>, which enables a function to be triggered by making an HTTP request to the function’s URL endpoint.</p>\n<p>All programmatic operations with Stripe in this article will be done using Stripe’s <a href=\"https://www.npmjs.com/package/stripe\">npm library</a> for a Node.js environment. Serverless functions are used in this article to cover use cases for small applications, using a <a href=\"https://jamstack.org/\">JAMstack</a> architecture without a back-end service.</p>\n<p>Azure functions can be developed either through the <a href=\"https://azure.microsoft.com/en-us/features/azure-portal/\">Azure portal</a> or locally on your computer. All Azure functions in this article will be developed and executed locally using Azure’s <a href=\"https://github.com/Azure/azure-functions-core-tools#linux\">Core Tools</a> command-line interface (CLI). Execute the command below to install Azure’s Core Tools globally on your computer using npm.</p>\n<pre><code>npm i -g azure-functions-core-tools@3 --unsafe-perm true</code></pre>\n\n<p>Next, run the commands below to create a new project directory to store the Azure Functions files and to bootstrap the Azure Functions project using the Core Tools CLI.</p>\n<pre><code>\n# Create a new directory\nmkdir stripe-serverless-api\n\n# Change into new directory\ncd stripe-serverless-api\n\n# Bootstrap Azure Functions project\nfunc new --language='javascript' --worker-runtime='node' --template=\"HTTP trigger\"\n--name=\"products\"\n</code></pre>\n\n<p>The commands above will create a <code>stripe-serverless-api</code> project directory on your computer. Also, using the parameters passed to the Core Tools CLI, we created an Azure Functions app with an HTTP trigger template using a Node.js runtime with JavaScript.</p>\n<p>We can start our new Azure function from the CLI to listen to HTTP requests through localhost on port <code>5050</code>.</p>\n<p><strong>Note</strong>: When using the HTTP trigger for an Azure Functions app, the function can be invoked via the function app’s name appended to the endpoint. An example of the products function app created above is <code>&lt;FUNCTIONS_ENDPOINT&gt;/products</code>.</p>\n<pre><code>func start -p 5050</code></pre>\n\n<p>Before we begin implementing the Azure functions, let’s install the two dependencies below, to be used within the Azure functions.</p>\n<pre><code>yarn add stripe dotenv</code></pre>\n\n<p>Stripe’s Node.js package, installed above, will be used to interact with the Stripe API. And <a href=\"https://www.npmjs.com/package/dotenv\">dotenv</a> will be used to load Stripe’s secret credentials, used in the Azure functions that will be created next.</p>\n<p>Create a <code>.env</code> file to store the Stripe credentials copied from the Stripe dashboard in the format below, replacing the placeholder in angled brackets with the appropriate value.</p>\n<pre><code>// .env\n\nSTRIPE_SECRET_KEY=&lt;STRIPE_SECRET_KEY&gt;\n</code></pre>\n\n<p>The Stripe credentials stored above will be used to authenticate the Stripe package with the Stripe API. These credentials are sensitive and should be privately stored. To prevent them from getting pushed when the entire project is pushed to a GitHub repository, create a <code>.gitignore</code> file and add the <code>.env</code> file name.</p>\n<pre><code>// .gitignore\n.env</code></pre>\n\n<p>At this point, the Azure Functions project is fully set up, and we can now proceed to build the individual apps within the project. We will proceed with implementing the logic in the Azure Functions apps, starting with the products function app.</p>\n<h3>Products Function</h3>\n<p>The purpose of this Azure function is to accept a <code>GET</code> HTTP request, and then respond with JSON data containing all products in the Stripe account.</p>\n<p>Using your code editor, open the <code>index.js</code> file in the <code>products</code> directory that was made when you created the Azure Functions project. Add the code block below to the <code>index.js</code> file to retrieve all products created in Stripe.</p>\n<pre><code>require(\"dotenv\").config();\n\nconst stripe = require(\"stripe\")(process.env.STRIPE_SECRET_KEY);\nconst headers = {\n  \"Access-Control-Allow-Methods\": \"*\",\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Headers\": \"Content-Type\",\n  \"Content-Type\": \"application/json\",\n};\n\nmodule.exports = async function (context, req) {\n  try {\n    const { data } = await stripe.products.list({});\n    context.res = {\n      headers,\n      body: {\n        data,\n      },\n    };\n  } catch (e) {\n    context.res = {\n      headers,\n      body: e,\n    };\n  }\n};\n</code></pre>\n\n<p>The exported function in the code block above uses the <a href=\"https://stripe.com/docs/api/products/list\"><code>list</code></a> method to list all products created in the account belonging to the <code>STRIPE_SECRET_KEY</code> variable being used.</p>\n<p>Once the promise from the asynchronous <code>list</code> method is resolved, the data array is destructured and sent back (alongside some request headers) as the response to the request, by setting the body within the <a href=\"https://stripe.com/docs/api/products/list\"><code>context</code></a> object.</p>\n<p>To test the function implemented above, open a new CLI and execute the command below, which makes a <code>GET</code> HTTP request, using <a href=\"https://curl.se\">cURL</a>, to the Azure functions running in a separate terminal.</p>\n<pre><code>curl http://localhost:4040/api/customer</code></pre>\n\n<p>After executing the command above, a JSON response will be returned to your console containing the previously created products.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9684cd28-874a-4905-b9e7-058c35dd73dd/1-product-function-response.png\" /></p>\n<h3>Price Function</h3>\n<p>As shown in the fields returned from the products function above, the price details of a product are not included in the <code>product</code> object. To get the price details of a product, we need to fetch the <code>price</code> object associated with the product. This will be the job of the price function, because each time it is executed, it will return the <code>price</code> object associated with a product.</p>\n<p>To create a new Azure Functions app, copy the the existing <code>products</code> folder, and paste it in the same directory as a duplicate. Then, rename the duplicated folder to <code>price</code>.</p>\n<p>Using your code editor, open the <code>index.js</code> file in the new <code>price</code> directory, and replace the existing function with the contents of the code block below, which implements the price function:</p>\n<pre><code>require(\"dotenv\").config();\n\nconst stripe = require(\"stripe\")(process.env.STRIPE_SECRET_KEY);\nconst headers = {\n  \"Access-Control-Allow-Methods\": \"*\",\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Headers\": \"Content-Type\",\n  \"Content-Type\": \"application/json\",\n};\n\nmodule.exports = async function (context, req) {\n  const { product } = req.query;\n\n  try {\n    const { data } = await stripe.prices.list({\n      product,\n    });\n    context.res = {\n      headers,\n      body: {\n        data : data[0],\n      },\n    };\n  } catch (e) {\n    context.res = {\n      headers,\n      body: e,\n    };\n  }\n};\n</code></pre>\n\n<p>The <code>price</code> function app above accepts a <code>GET</code> HTTP request that contains a product in the <code>query</code> parameter with the value of a product’s ID. The <a href=\"https://stripe.com/docs/api/prices/list\"><code>list</code></a> method on the <code>price</code> object is used to retrieve prices within a Stripe account. The <code>product</code> parameter passed to the <code>list</code> method restricts the prices retrieved to the ones associated with the <code>product</code> object whose ID has been passed to the <code>list</code> method.</p>\n<p>Once the promise from the <code>list</code> method is resolved, the data array from the <code>list</code> method is destructured, and only the first object within the data array is sent back as the request response.</p>\n<p><strong>Note:</strong> Only the first object from the data array is sent back because we want to display only one price entity. A product may have several <code>price</code> objects attached it, but for this application, we will use only one.</p>\n<p>To test the function implemented above, execute the command below, which sends a <code>GET</code> HTTP request containing a product ID in a <code>request</code> parameter to the Azure functions running in a separate terminal.</p>\n<p><strong>Note:</strong> You can find the ID of a product in the Stripe dashboard. Navigate to the “Products” page, and click a product to view its details. In the details displayed, you will find the ID of the product.</p>\n<pre><code>curl http://localhost:4040/api/price?product=\"prod_JudY3VFuma4zj7\"</code></pre>  \n\n<p>Once you execute the command above, a JSON response will be returned to your console with an object containing the <code>price</code> object of a product.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/6ca10bc6-dc5c-401b-b757-a8867150f162/price-function-response.png\" /></p>\n<p>From the response shown in the sample above, we can see the price details of the product, including the currency, type, and recurring data.</p>\n<h3>Purchase Function</h3>\n<p>The purchase function app will be used either to make a one-time purchase of a product or to subscribe a user to a product. Either of these two operations involves charging a user via their bank card.</p>\n<p>To create a new function app within the Azure Functions project, copy either the existing products or the <code>price</code> folder, and paste it in the same directory as a duplicate. Then, rename the duplicated folder to <code>purchase</code>.</p>\n<p>In your code editor, add the contents of the code block below in the <code>index.js</code> file, which will handle a <code>POST</code> request to create either a subscription or a one-time purchase for a user.</p>\n<pre><code>// ./purchase/index.js\nrequire(\"dotenv\").config();\n\nconst stripe = require(\"stripe\")(process.env.STRIPE_SECRET_KEY);\nconst headers = {\n  \"Access-Control-Allow-Methods\": \"*\",\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Headers\": \"Content-Type\",\n  \"Content-Type\": \"application/json\",\n};\n\nmodule.exports = async function (context, req) {\n  const {\n    number,\n    purchaseCurrency,\n    cvc,\n    exp_month,\n    exp_year,\n    purchaseAmount,\n    email,\n    purchaseType,\n    priceEntityId,\n  } = req.body;\n\n  try {\n    // Create a payment method for user using the card details\n    const { id: paymentID } = await stripe.paymentMethods.create({\n      type: \"card\",\n      card: {\n        number,\n        cvc,\n        exp_year,\n        exp_month,\n      },\n    });\n\n    const { id: customerID } = await stripe.customers.create({\n      email,\n      description: \"Artwork gallery customer\",\n      payment_method: paymentID,\n    });\n\n    await stripe.paymentMethods.attach(paymentID, { customer: customerID });\n    if (purchaseType === \"recurring\") {\n      const subscriptionData = await stripe.subscriptions.create({\n        customer: customerID,\n        default_payment_method: paymentID,\n        items: [\n          {\n            price: priceEntityId,\n          },\n        ],\n      });\n      context.res = {\n        headers,\n        body: {\n          message: \"SUBSCRIPTION CREATED\",\n          userStripeId: customerID,\n          userSubscriptionId: subscriptionData.id,\n        },\n      };\n    } else {\n      const { id: paymentIntentId } = await stripe.paymentIntents.create({\n        amount: purchaseAmount,\n        currency: purchaseCurrency || \"usd\",\n        customer: customerID,\n        payment_method: paymentID,\n      });\n      const { amount_received } = await stripe.paymentIntents.confirm(\n        paymentIntentId,\n        {\n          payment_method: paymentID,\n        }\n      );\n      context.res = {\n        headers,\n        body: {\n          message: `PAYMENT OF ${amount_received} RECIEVED`,\n        },\n      };\n    }\n  } catch (e) {\n    context.res = {\n      status: 500,\n      body: e,\n    };\n  }\n};\n</code></pre>\n\n<p>The function app in the code block above uses the Stripe package to create either a one-time payment or a subscription for a user based on the <code>purchaseType</code> value gotten from the request body. Here is a run down of what happened above:</p>\n<ul>\n<li>First, a <code>payment_method</code> entity is created using the credit card number, name, CVC, and expiration details, destructured from the data sent in the function’s request body.</li>\n<li>Next, a customer is created in Stripe using the <code>email</code> value sent in the request body, a description, and the payment method previously created. The <code>customer</code> object is also attached to the <code>payment_method</code> entity by using the <code>attach</code> method and specifying the <code>payment_method</code> ID string that was returned when the payment method was created, and specifying a <code>customer</code> option with the customer ID that was returned when the <code>customer</code> entity was created.</li>\n<li>The last part of the function handler has an <code>if</code> condition that evaluates the <code>purchaseType</code> value sent in the request body. If the <code>purchaseType</code> value is recurring, then the <code>subscription</code> entity would contain the customer ID returned from the <code>customer</code> entity, a <code>default_payment_method</code> with the value of the <code>payment_method</code> ID returned from the <code>payment</code> entity, and an <code>items</code> array with a single <code>item</code> object containing the ID of a <code>price</code> entity.</li>\n</ul>\nExpanding the Demo Web Application\n<p>A web application built using <a href=\"https://reactjs.org/\">React</a> will serve as the web client that directly accesses the Azure Functions apps that we’ve built up to now. As explained earlier, the interface has already been built, and the data has been retrieved from a mock JSON file. We will only make some minimal changes and add the HTTP requests to use the Azure Functions endpoint.</p>\n<p>Clone the web application from the <a href=\"https://github.com/vickywane/stripe-art-app.git\">GitHub repository</a> by executing the Git command below from your local CLI:</p>\n<pre><code>git clone https://github.com/vickywane/stripe-art-app.git</code></pre>\n\n<p>Next, move into the cloned application’s directory and install the dependencies listed in the <code>package.json</code> file.</p>\n<pre><code># change directory\ncd stripe-art-app\n\n# install dependencies\nyarn install</code></pre>\n\n<p>Once the dependencies have been installed, run the <code>yarn start</code> command from your CLI to view the home page of the web application from your web browser at <code>http://localhost:3000</code>.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9469cf13-1a2d-413f-9a79-1f6fa17399cf/gallery-application-home-page.png\" /></p>\n<p>Before diving into the code base of the web application, let’s note a few things about the existing structure of the application.</p>\n<p>First, user management, including authentication and the storing of a user’s personal data from the application, was implemented using <a href=\"https://auth0.com/\">Auth0</a> through the use of the <a href=\"https://www.npmjs.com/package/@auth0/auth0-react\">auth0-react</a> SDK for React applications.</p>\n<p>To use Auth0 in the cloned application, we need to supply the credentials from an Auth0 <a href=\"https://auth0.com/docs/quickstart/spa\">single-page application</a> type in the <code>.env</code> file within the web application folder in the format shown below.</p>\n<p><strong>Note</strong>: See the <a href=\"https://auth0.com/docs/quickstart/spa/react\">Auth0 quickstart guide</a> for more details on how to get started with a single-page application.</p>\n<pre><code># ./env\n\nREACT_APP_AUTHO_DOMAIN=&lt;AUTH0_DOMAIN&gt;\nREACT_APP_AUTHO_SECRET_KEY=&lt;AUTH0_SECRET&gt;\nREACT_APP_FUNCTION_ENDPOINT=\"http://localhost:5050/api\"</code></pre>\n\n<p>The <code>REACT_APP_FUNCTION_ENDPOINT</code> defined in the <code>.env</code> file above will be accessed with the application components to make HTTP requests to the running function apps. Currently, the Azure Functions apps are being served locally on your computer’s localhost, but this will change to a live URL when the function apps are deployed to Azure Functions.</p>\n<p>The second thing to note is that the data of art products displayed on the home page are static, retrieved from a JSON file in the <code>data</code> directory.</p>\n<p>In this part of this article, we will extend the functionalities above as follows:</p>\n<ul>\n<li><strong>Home page</strong><br />We will refactor the home page to fetch and display products created in Stripe using the <code>GET</code> products Azure function created previously, and we will discard the <code>mock.json</code> file containing the prototype art products.</li>\n<li><strong>Checkout page</strong><br />We will build a new checkout page for users who want to purchase either an art print or a subscription with their credit card.</li>\n</ul>\nHome Page\n<p>The home page is displayed for all users, whether authenticated or unauthenticated, and it displays a list of all available artwork products, using a child <code>artworkCard</code> component exported from the <code>artworkCard.js</code> file.</p>\n<p>We need to make a few changes to this component, because we want the button in the <code>artworkCard</code> component to prompt the user to purchase an artwork. Modify the existing <code>artworkCard.js</code> file in the <code>components</code> directory with the highlighted portions of the code block below.</p>\n<div>\n <pre><code>// ./src/components/artworkCard.js\n\nimport { navigate } from \"@reach/router\";\nimport React, { useState, useEffect } from \"react\";\n\nconst ArtworkCard = ({ name, description, img_uri, productId }) =&gt; {\n  const [priceData, setPriceData] = useState({});\n\n  useEffect(() =&gt; {\n    (async () =&gt; await fetchPrice())();\n  }, []);\n\n  const fetchPrice = async () =&gt; {\n    const res = await fetch(\n      '${process.env.REACT_APP_FUNCTION_ENDPOINT}/price?product=${productId}'\n    );\n    const { data } = await res.json();\n    setPriceData(data);\n  };\n\n  return (\n    &lt;div className=\"artwork-card\"&gt;\n      &lt;div\n        className=\"card-top\"\n        style={{\n          backgroundImage: 'url(${img_uri})',\n        }}\n      &gt;&lt;/div&gt;\n      &lt;div className=\"artwork-details\"&gt;\n        &lt;div className={\"align-center\"}&gt;\n          &lt;h5&gt; {name} &lt;/h5&gt;\n        &lt;/div&gt;\n        &lt;hr /&gt;\n        &lt;div style={{ justifyContent: \"space-between\" }} className=\"flex\"&gt;\n          &lt;div className=\"align-center\"&gt;\n          &lt;p&gt; {'$${priceData.unit_amount}'} &lt;/p&gt;\n          &lt;/div&gt;\n          &lt;div&gt;\n            &lt;button\n              className=\"btn\"\n              onClick={() =&gt;\n                navigate('/checkout/${productId}', {\n                  state: {\n                    name,\n                    productId,\n                    priceEntityId: priceData.id,\n                    price: priceData.unit_amount,\n                    purchaseType: priceData.type,\n                  },\n                })\n              }\n            &gt;\n              Purchase\n            &lt;/button&gt;\n            &lt;/div&gt;\n        &lt;/div&gt;\n        &lt;br /&gt;\n        &lt;p&gt; {description} &lt;/p&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  );\n};\n\nexport default ArtworkCard;</code></pre>\n</div>\n\n<p>In the highlighted parts of the file above, we introduced a <a href=\"https://reactjs.org/docs/hooks-effect.html\"><code>useEffect</code></a> hook to make an HTTP request to the price function app to retrieve the <code>price</code> object attached to the product being displayed in the card. Once the promise from the <code>fetch</code> method is resolved, the data stream is further converted to JSON and stored in the component’s local state.</p>\n<p>A button labelled <code>Purchase</code> was also added to the <code>artworkCard</code> component. When clicked, it navigates the user to the checkout page, where the user can input their bank card details to purchase the product.</p>\n<p>In your code editor, open the <code>Home.js</code> file in the <code>pages</code> directory, and modify it with the highlighted portions of the code block below, which will fetch all available products in Stripe through the products function app and then display them.</p>\n<div>\n <pre><code># ./src/pages/home.js\n\nimport React, { useState, useEffect } from \"react\";\nimport Header from \"../components/header\";\nimport \"../App.css\";\nimport Banner from \"../components/banner\";\nimport ArtworkCard from \"../components/artworkCard\";\n\nconst Home = () =&gt; {\n\n  const [artworks, setArtworks] = useState([]);\n  useEffect(() =&gt; {\n    (async () =&gt; await fetchArtworks())();\n  }, []);\n\n  const fetchArtworks = async () =&gt; {\n    const res = await fetch(<code>${process.env.REACT_APP_FUNCTION_ENDPOINT}/products</code>);\n    const { data } = await res.json();\n    setArtworks(data);\n  };\n\n  return (\n    &lt;div style={{ backgroundColor: \"#F3F6FC\", height: \"100vh\" }}&gt;\n      &lt;Header /&gt;\n      &lt;Banner /&gt;\n      &lt;br /&gt;\n      &lt;br /&gt;\n      &lt;div className=\"page-padding\"&gt;\n        &lt;div style={{}}&gt;\n          &lt;div className=\"flex\"&gt;\n            &lt;div className=\"align-center\"&gt;\n              &lt;h4&gt; My Rated Art Paints &lt;/h4&gt;\n            &lt;/div&gt;\n          &lt;/div&gt;\n          &lt;p&gt;\n            Every artist dips his brush in his own soul, &lt;br /&gt;\n            and paints his own nature into his pictures.\n          &lt;/p&gt;\n        &lt;/div&gt;\n        &lt;br /&gt;\n        &lt;div&gt;\n          &lt;ul className=\"artwork-list\"&gt;\n            {artworks.map(({ id, name, img_uri, images, description }) =&gt; (\n              &lt;li key={id}&gt;\n                &lt;ArtworkCard\n                  productId={id}\n                  description={description}\n                  img_uri={images[0]}\n                  name={name}\n                /&gt;\n              &lt;/li&gt;\n            ))}\n          &lt;/ul&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  );\n};\n\nexport default Home;\n</code></pre>\n</div>\n\n<p>In the code block above, a <code>GET</code> request is made as soon as the component is loaded in a <code>useEffect</code> hook using the browser’s fetch API. The stream response from the request made is further converted into JSON format, and the data is stored in the local component state for further use.</p>\n<p>With this change, the <code>data.json</code> file is no longer being used. Also, when you view the web application in your browser, you will find the products created in Stripe displayed in a grid, as shown below:</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/09d59b9f-4892-41f4-9900-3d244e442456/store-app-home-page.png\" /></p>\n<p>From the details shown in the image above, you will notice that the products displayed on the home page were the ones created at the beginning of this article.</p>\nCheckout Page\n<p>Create a <code>checkout.js</code> file in the <code>pages</code> directory. This new file will contain the component that will be displayed to collect the user’s credit card details, after they are routed to <code>/checkout</code> upon clicking the “Purchase” button to purchase an art print.</p>\n<p>Add the contents of the code block below to create the checkout component that contains the form elements to collect the credit card details:</p>\n<pre><code># ./src/pages/checkout.js\n\nimport React, { useState } from \"react\";\nimport { useAuth0 } from \"@auth0/auth0-react\";\nimport Header from \"../components/header\";\nimport \"../App.css\";\n\nconst Checkout = (props) =&gt; {\n  const { purchaseType, productId, priceEntityId, name, price } =\n    props.location.state;\n\n  const [cardNumber, setCardNumber] = useState(\"\");\n  const [cardName, setCardName] = useState(\"\");\n  const [cvc, setcvc] = useState(\"\");\n  const [cardExpiryMonth, setCardExpiryMonth] = useState(\"\");\n  const [cardExpiryYear, setCardExpiryYear] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [paymentSuccess, setPaymentSuccess] = useState(false);\n  const { user } = useAuth0();\n\n  const makePayment = async () =&gt; {\n    setLoading(true);\n    try {\n      const res = await fetch(\n        `${process.env.REACT_APP_FUNCTION_ENDPOINT}/purchase`,\n        {\n          method: \"POST\",\n          body: JSON.stringify({\n            number: cardNumber,\n            exp_month: cardExpiryMonth,\n            exp_year: cardExpiryYear,\n            purchaseAmount: price,\n            purchaseType,\n            priceEntityId,\n            cvc,\n            email: user.email,\n          }),\n        }\n      );\n\n      if (res.status === 200) {\n        const { paymentId } = await res.json();\n        await fetch(`${process.env.REACT_APP_FUNCTION_ENDPOINT}/billing-data`, {\n          method: \"POST\",\n          body: JSON.stringify({\n            productId,\n            userId: user.sub,\n            paymentId,\n          }),\n        });\n        setPaymentSuccess(true);\n      }\n    } catch (e) {\n      console.log(e);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    &lt;div\n      style={{\n        height: \"100vh\",\n        background: \"#F3F6FC\",\n      }}\n    &gt;\n      &lt;Header /&gt;\n      &lt;div\n        className=\"product-page-padding\"\n        style={{\n          height: window.innerHeight,\n          display: \"flex\",\n          justifyContent: \"center\",\n          alignItems: \"center\",\n        }}\n      &gt;\n        &lt;div className=\"align-center\"&gt;\n          &lt;div className=\"payment-card\"&gt;\n            &lt;h5 className=\"align-center\"&gt;\n              &lt;b&gt;{name} Checkout &lt;/b&gt;\n            &lt;/h5&gt;\n            &lt;p&gt;\n              &lt;b&gt;Total Price:&lt;/b&gt; {`$${price}`}\n            &lt;/p&gt;\n            &lt;p&gt;\n              &lt;b&gt; Payment Type: &lt;/b&gt; {purchaseType.toUpperCase()}\n            &lt;/p&gt;\n            &lt;hr /&gt;\n            {!paymentSuccess ? (\n              &lt;form\n                onSubmit={(e) =&gt; {\n                  e.preventDefault();\n                  makePayment();\n                }}\n              &gt;\n                &lt;h5&gt; Payment Details &lt;/h5&gt;\n                &lt;br /&gt;\n                &lt;div className=\"input-container\"&gt;\n                  &lt;label id=\"name\"&gt; Cardholder Name &lt;/label&gt;\n                  &lt;input\n                    value={cardName}\n                    onChange={(e) =&gt; setCardName(e.target.value)}\n                    className=\"payment-input\"\n                    placeholder=\"Bank Cardholder Name\"\n                    type=\"text\"\n                  /&gt;\n                &lt;/div&gt;\n                &lt;br /&gt;\n                &lt;div className=\"input-container\"&gt;\n                  &lt;label id=\"name\"&gt; Card Number &lt;/label&gt;\n                  &lt;input\n                    value={cardNumber}\n                    onChange={(e) =&gt; setCardNumber(e.target.value)}\n                    className=\"payment-input\"\n                    placeholder=\"Bank Card Numbers\"\n                    type=\"number\"\n                  /&gt;\n                &lt;/div&gt;\n                &lt;br /&gt;\n                &lt;div className=\"input-container\"&gt;\n                  &lt;label id=\"name\"&gt; Card CVC &lt;/label&gt;\n                  &lt;input\n                    value={cvc}\n                    onChange={(e) =&gt; setcvc(e.target.value)}\n                    className=\"payment-input\"\n                    placeholder=\"Bank Card CVC\"\n                    type=\"text\"\n                  /&gt;\n                &lt;/div&gt;\n                &lt;br /&gt;\n                &lt;div className=\"input-container\"&gt;\n                  &lt;label id=\"name\"&gt; Card Expiry Month &lt;/label&gt;\n                  &lt;input\n                    value={cardExpiryMonth}\n                    onChange={(e) =&gt; setCardExpiryMonth(e.target.value)}\n                    className=\"payment-input\"\n                    placeholder=\"Bank Card Expiry Month\"\n                    type=\"text\"\n                  /&gt;\n                &lt;/div&gt;\n                &lt;br /&gt;\n                &lt;div className=\"input-container\"&gt;\n                  &lt;label id=\"name\"&gt; Card Expiry Year &lt;/label&gt;\n                  &lt;input\n                    value={cardExpiryYear}\n                    onChange={(e) =&gt; setCardExpiryYear(e.target.value)}\n                    className=\"payment-input\"\n                    placeholder=\"Bank Card Expiry Year\"\n                    type=\"text\"\n                  /&gt;\n                &lt;/div&gt;\n                &lt;br /&gt;\n                &lt;button\n                  disabled={loading}\n                  style={{ width: \"100%\" }}\n                  onClick={(e) =&gt; {\n                    e.preventDefault();\n                    makePayment();\n                  }}\n                  className=\"btn\"\n                &gt;\n                  {!loading ? \"Confirm\" : \"Confirming\"} My Payment\n                &lt;/button&gt;\n              &lt;/form&gt;\n            ) : (\n              &lt;div&gt;\n                &lt;br /&gt;\n                &lt;h5 className=\"align-center\"&gt;\n                  Your {`$${price}`} purchase of {name} was successfull{\" \"}\n                &lt;/h5&gt;\n                &lt;br /&gt;\n              &lt;/div&gt;\n            )}\n          &lt;/div&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  );\n};\n\nexport default Checkout;\n</code></pre>\n\n<p>As described earlier, the form component above contains four input fields for the user to type in their name, number, expiration and CVC details. These details are further stored in the component’s local state, and, upon a click of the “Confirm my payment” button, the stored credit card details are used to purchase the product.</p>\n<p>Of particular interest in the checkout component above is the <code>makePayment</code> function, because it handles the functionality of the checkout page. When executed, the <code>makePayment</code> function sends a <code>POST</code> request containing the credit card details in its request body using fetch to the <code>/purchase</code> cloud function. Once the first <code>POST</code> request is resolved successfully, with a <code>200</code> status code indicating a successful payment, a new <code>POST</code> request is made to the <code>/billing-data</code> cloud function to store the details of the purchased product.</p>\n<p><strong>Note:</strong> As explained when we were designing the <code>productCard</code> component, the purchased product details stored in Auth0 will be used to identify products purchased by the user from the home page.</p>\n<p>To test this component, we will fill the input fields with the details of one of the <a href=\"https://stripe.com/docs/testing#cards\">basic test cards</a> provided by Stripe for applications still in test mode, and then click the “Confirm payment” button, as shown below:</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/9db6345e-71ac-4f14-a04b-5c3982f940a1/checkout-page.png\" /></p>\n<p><strong>Note:</strong> The credit card used in the image above is one of the <a href=\"https://stripe.com/docs/testing#cards\">basic test cards</a> provided by Stripe and not a real credit card. Stripe accounts in test mode must use one of the basic test cards.</p>\n<p>Once the “Confirm my payment” button in the checkout card is clicked, a payment for the product is made from the credit card provided, and the checkout card interface is changed to reflect the successful response.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/fbb7ad85-7bc1-4b43-85e7-679e1fe13322/payment-successful-response.png\" /></p>\n<p>Going to the “Reports” section of your Stripe admin dashboard, you will see a reflection of the last payment made when the gallery subscription was created on the checkout page above.</p>\n<p><img src=\"https://cloud.netlifyusercontent.com/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/069f5c27-d12b-40a2-80b2-886249640ac4/stripe-dashboard-statistics.png\" /></p>\n<p>From the charts shown in the image above, taken from the test Stripe card used in this tutorial, you will see that a gross volume of $150.00 was attained once the gallery subscription was created.  </p>\n<p><strong>Note</strong>: The image also shows statistics from test operations that were made on the Stripe account while this article was being developed.</p>\n<p>At this point, we have fully set up the entire payment flow. You can repeat the process of creating a product through the Stripe dashboard and purchasing it using the React application or any other client that consumes Azure Functions.</p>\nSummary\n<p>Congratulations on completing this hands-on tutorial.</p>\n<p>By going through the steps in this tutorial, we have worked with Stripe, Azure Functions, and React. We started by building an API layer that uses the Stripe API through a Node.js package. Then, we moved on to consuming the Azure Functions app endpoints from a web application, using the function app to retrieve products and make payments for the products.</p>\n<h3>References</h3>\n<ul>\n<li><a href=\"https://stripe.com/docs\">Documentation</a>, Stripe</li>\n<li><a href=\"https://www.npmjs.com/package/@auth0/auth0-react\">auth0-react</a> (SDK for React single-page applications)</li>\n<li><a href=\"https://auth0.com\">Auth0</a></li>\n</ul>","author":"","siteTitle":"Articles on Smashing Magazine — For Web Designers And Developers","siteHash":"ab069ca35bf300e9db0da36f49701f66485a5b0d2db0471dfeee07cef6204939","entryHash":"8dac26cc7bf825e92ec2496c19003c82bbacd9f935e244eaa79717826eb83d33","category":"Tech"}