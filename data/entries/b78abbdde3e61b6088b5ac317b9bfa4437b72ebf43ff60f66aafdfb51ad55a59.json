{"title":"การใช้งาน SKIP LOCKED ใน PostgreSQL database","link":"https://www.somkiat.cc/skip-locked-in-postgresql/","date":1768726989000,"content":"<p><img width=\"150\" height=\"150\" src=\"https://www.somkiat.cc/wp-content/uploads/2026/01/postgresql-skip-locked-01-150x150.jpg\" alt=\"\" loading=\"lazy\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2026/01/postgresql-skip-locked-01-150x150.jpg 150w, https://www.somkiat.cc/wp-content/uploads/2026/01/postgresql-skip-locked-01-75x75.jpg 75w\" /></p>\n<p>จากการแบ่งปันความรู้ของ PostgreSQL database นั้น<br />มีคำถามเกี่ยวกับการใช้งาน <a href=\"https://www.postgresql.org/docs/current/sql-select.html\" target=\"_blank\">SKIP LOCKED ที่เพิ่มเข้ามาตั้งแต่ version 9.5</a> นั้น (2016)<br />ว่าทำงานอย่างไร และ มี use case อะไรบ้าง ?</p>\n\n\n\n<span></span>\n\n\n\n<p>โดยพื้นฐานในการแก้ไขข้อมูลใน table หนึ่ง ๆ นั้น<br />database จะทำการ lock row นั้น ๆ ไว้ก่อนเสมอ<br />เพื่อไม่ให้แก้ไขข้อมูลพร้อม ๆ กันนั่นเอง<br />ดังนั้น request ที่มาช้าก่อนก็ต้องรอใน queue ต่อไป <br />จนกว่าจะปลด lock หรือทำงานเสร็จ (begin-commit)</p>\n\n\n\n<p>ดังนั้นใน PostgreSQL จึงได้เพิ่ม SKIP LOCKED เข้ามา<br />เพื่อทำการข้ามไปยัง row ต่อไปที่ไม่ถูก lock เลยทันที<br />นั่นคือ ถ้ามีการใช้งานข้อมูลใน table นั้น ๆ พร้อม ๆ กับ (high-concurrency)<br />จะไม่ block กันเลย และอ่านไปเรื่อย ๆ สำหรับ row ที่ไม่ถูก lock</p>\n\n\n\n<p>ดังนั้นหนึ่งใน Use case คือ Queue หรือ Task นั่นเอง<br />เช่นถ้ามางานให้ทำงานจำนวนมาก ๆ <br />จากนั้นให้ worker จำนวนมากมาช่วยกันทำงานจาก task ต่าง ๆ<br />โดย worker ต้องไม่หยิบ task ซ้ำกัน<br />สามารถใช้งานได้ดังนี้</p>\n\n\n\n<p><strong>ใน <a href=\"https://medium.com/@the_atomic_architect/postgresql-replaced-my-message-queue-and-taught-me-skip-locked-along-the-way-87d59e5b9525\" target=\"_blank\">PostgreSQ</a>L จะใช้งานผ่าน SELECT for UPDATE with SKIP LOCKED + LIMIT 1 นั่นเอง</strong></p>\n\n\n\n<figure><a href=\"https://www.somkiat.cc/wp-content/uploads/2026/01/postgresql-skip-locked-01.jpg\"><img src=\"https://www.somkiat.cc/wp-content/uploads/2026/01/postgresql-skip-locked-01-1024x615.jpg\" alt=\"\" width=\"681\" height=\"409\" /></a></figure>\n\n\n\n<p><br />ตัวอย่างการใช้งาน</p>\n\n\n\n[gist id=\"4782f5471c938cec8ca1108d750d6156\" file=\"1.txt\"]\n\n\n\n<p>เป็นอีกหนึ่งแนวทางในการแก้ไขปัญหา<br />ลองศึกษาและใช้งานกันดู<br />เรื่องของ performance ก็อีกเรื่องนึงนะครับ</p>\n\n\n\n<p>และยังสามารถใช้งานผ่าน NOWAIT ก็ได้เช่นกัน<br />รวมทั้งถ้า table มีขนาดมหญ่ อย่าลืมใส่ index ด้วยเสมอ</p>\n","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"b78abbdde3e61b6088b5ac317b9bfa4437b72ebf43ff60f66aafdfb51ad55a59","category":"Thai"}