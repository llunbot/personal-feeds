{"title":"CDKTF 0.20 improves implementation of iterators and enables HCL output","link":"https://www.hashicorp.com/blog/cdktf-0-20-improves-implementation-of-iterators-and-enables-hcl-output","date":1704907800000,"content":"<p>The mission of CDK for Terraform (CDKTF) is to simplify Terraform adoption. We introduced the <a href=\"https://www.hashicorp.com/blog/cdk-for-terraform-now-generally-available\">generally available version of CDKTF</a> in August of 2022, enabling developers not familiar with HashiCorp Configuration Language (HCL) to write Terraform configurations in their choice of language, including TypeScript, Python, C#, Java, and Go. In CDKTF 0.12, we introduced a new API called <code>TerraformIterator</code> that supports dynamic list iterations on the block and resource level to enable workflows that users are familiar with in HCL.</p>\n\n<p>Today, we’re releasing CDKTF version 0.20, which improves the existing implementation of iterators. This new support allows developers to handle more complex cases, in which resources are created based on data that’s known only at run time. CDKTF version 0.20 also enables HCL output and improves error messages.</p>\n\n<p>The iterator improvements include:</p>\n\n<ul>\n<li>Chaining iterators </li>\n<li>Complex list iterators </li>\n<li>Support mapping to primitive values </li>\n</ul>\n\n<h2>Chaining iterators</h2>\n\n<p>CDKTF 0.20 supports accessing resources created by iterators. This was previously possible only with an <a href=\"https://developer.hashicorp.com/terraform/cdktf/concepts/resources#escape-hatch\">escape hatch</a>. To <a href=\"https://terraform-9uruiy3wt-hashicorp.vercel.app/terraform/cdktf/concepts/iterators#chaining-iterators\">chain iterators</a> you can use the <code>TerraformIterator.fromResources()</code> or <code>TerraformIterator.fromDataSources()</code> methods with the resource or data source you want to chain as an argument:</p>\n<pre><code>const s3BucketConfigurationIterator = TerraformIterator.fromMap({\n  website: {\n\tname: \"website-static-files\",\n\ttags: { app: \"website\" },\n  },\n  images: {\n\tname: \"images\",\n\ttags: { app: \"image-converter\" },\n  },\n});\n\nconst s3Buckets = new S3Bucket(this, \"complex-iterator-buckets\", {\n  forEach: s3BucketConfigurationIterator,\n  bucket: s3BucketConfigurationIterator.getString(\"name\"),\n  tags: s3BucketConfigurationIterator.getStringMap(\"tags\"),\n});\n\n// This would be TerraformIterator.fromDataSources for data_sources\nconst s3BucketsIterator = TerraformIterator.fromResources(s3Buckets);\nconst helpFile = new TerraformAsset(this, \"help\", {\n  path: \"./help\",\n});\n\nnew S3BucketObject(this, \"object\", {\n  forEach: s3BucketsIterator,\n  bucket: s3BucketsIterator.getString(\"id\"),\n  key: \"help\",\n  source: helpFile.path,\n});</code></pre><h2>Complex list iterators</h2>\n\n<p>We now support iterating on resource attributes containing values that are known only after <code>apply</code>. The most common example for this use case is validating an AWS Certificate Manager (ACM) certificate through DNS. In this case, the <code>domain_validation_options</code> attribute contains values that are known only after the AWS ACM certificate resource has been created:</p>\n<pre><code>// Creates a new AWS managed SSL Certificate\nconst cert = new AcmCertificate(this, \"cert\", {\n  domainName: \"example.com\",\n  validationMethod: \"DNS\",\n});\n\n// The existing domain that we control and want to create an SSL certificate for\nconst dataAwsRoute53ZoneExample = new DataAwsRoute53Zone(this, \"dns_zone\", {\n  name: \"example.com\",\n  privateZone: false,\n});\n\n// NEW: fromComplexList() allows iterating over the domain validation options\n//      while mapping it into a map with \"domain_name\" as the key\nconst exampleForEachIterator = TerraformIterator.fromComplexList(\n  cert.domainValidationOptions,\n  \"domain_name\"\n);\n\n// This will create the DNS records to validate the ACM certificate based\n// on the domain validation options from the ACM Certificate Resource\nconst records = new Route53Record(this, \"record\", {\n  forEach: exampleForEachIterator,\n  allowOverwrite: true,\n  name: exampleForEachIterator.getString(\"name\"),\n  records: [exampleForEachIterator.getString(\"record\")],\n  ttl: 60,\n  type: exampleForEachIterator.getString(\"type\"),\n  zoneId: dataAwsRoute53ZoneExample.zoneId,\n});\n\nconst recordsIterator = TerraformIterator.fromResources(records);\n\n// This causes Terraform to wait until the validation through DNS was successful\nnew AcmCertificateValidation(this, \"validation\", {\n  certificateArn: cert.arn,\n  validationRecordFqdns: Token.asList(recordsIterator.pluckProperty(\"fqdn\")),\n});</code></pre><h2>Support mapping to primitive values</h2>\n\n<p>Iterators now support <a href=\"https://developer.hashicorp.com/terraform/cdktf/concepts/iterators#using-for-expressions\">expressing more variations of <code>for</code> expressions</a> in HCL. For example, it is now possible to map a list of objects into a list of strings by “plucking” one of their properties</p>\n<pre><code>new TerraformLocal(this, \"list-of-names\", mapIterator.pluckProperty(\"name\"));</code></pre><p>The new functions are exposed on complex (i.e. non-primitive) computed (i.e. not configurable) lists. They include <code>values()</code>, <code>keys()</code>, <code>pluckProperty()</code>, <code>forExpressionForList()</code> and <code>forExpressionForMap()</code>. The latter two are very close to HCL, allowing you to leverage the full power of HCL for expressions without using an <a href=\"https://developer.hashicorp.com/terraform/cdktf/concepts/resources#escape-hatch\">override escape hatch</a>.</p>\n\n<h2>Output HCL instead of Terraform JSON</h2>\n\n<p>CDKTF synth now supports HCL as an output, in addition to the Terraform JSON which was previously supported. This makes it easier to debug the configuration that CDKTF creates, as HCL output is easier for people to read.</p>\n\n<p>Moreover, this means you can use CDKTF as a templating engine to generate a Terraform config that will then be used and edited by other teams. Finally, it means you can now use CDKTF with tooling that supports only Terraform HCL. Although Terraform Cloud’s native features, like policy evaluation and health assessments, work with JSON, other common tools, like code scanners and linters, support only HCL.</p>\n\n<h2>Improved error messages</h2>\n\n<p>Error messages in the <code>cdktf</code> package now give more context and propose solutions to the problem at hand. For example:</p>\n\n<p><strong>Old</strong>:</p>\n\n<pre><code>No app could be identified for the construct at path 'path/to/construct'\n</code></pre>\n\n<p><strong>New</strong>:</p>\n\n<pre><code>No app could be identified for the construct at path 'path/to/construct', likely a TerraformStack.\nThe scope of CDKTF's TerraformStack class is a single App instance created by 'const app = new App()'. The App is the root of your project that holds project configuration and validations.\nYou can learn more about the App here: https://developer.hashicorp.com/terraform/cdktf/concepts/cdktf-architecture#app-class:~:text=and%20Resource.-,App%20Class,-Each%20CDKTF%20project\n</code></pre>\n\n<h2>Try CDK for Terraform</h2>\n\n<p>If you’re new to the project, these <a href=\"https://developer.hashicorp.com/terraform/tutorials/cdktf\">tutorials for CDKTF</a> are the best way to get started. You can dive deeper into our documentation with this <a href=\"https://developer.hashicorp.com/terraform/cdktf\">overview of CDKTF</a>.</p>\n\n<p>Whether you’re still experimenting or actively using CDK for Terraform, we’d love to hear from you. Please <a href=\"https://cdk.tf/bug\">file any bugs you encounter</a>, let us know about your <a href=\"https://cdk.tf/feature\">feature requests</a>, and share your questions, thoughts, and experiences in the <a href=\"https://discuss.hashicorp.com/c/terraform-core/cdk-for-terraform/47\">CDK for Terraform discussion forum</a>.</p>\n","author":"Ansgar Mertens","siteTitle":"HashiCorp Blog","siteHash":"219aa6310b3388f2335eba49871f4df9581f2c58eaeb5e498363b54e835b7001","entryHash":"a2c66afe6da44370f3c7bf8188db77de8104bc0b35a195d07994c212510ae415","category":"Tech"}