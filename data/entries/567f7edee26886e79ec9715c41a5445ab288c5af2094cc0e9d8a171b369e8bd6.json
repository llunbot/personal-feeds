{"title":"Monitor data events in Amazon S3 Express One Zone with AWS CloudTrail","link":"https://aws.amazon.com/blogs/aws/monitor-data-events-in-amazon-s3-express-one-zone-with-aws-cloudtrail/","date":1720563557000,"content":"<p>In a <a href=\"https://aws.amazon.com/es/blogs/aws/new-amazon-s3-express-one-zone-high-performance-storage-class/\">News Blog post for re:Invent 2023</a>, we introduced you to <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-express-one-zone.html\">Amazon S3 Express One Zone,</a> a high-performance, single-Availability Zone (AZ) storage class purpose-built to deliver consistent single-digit millisecond data access for your most frequently accessed data and latency-sensitive applications. It is well-suited for demanding applications and is designed to deliver up to 10x better performance than S3 Standard. S3 Express One Zone uses S3 <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/directory-buckets-overview.html\">directory buckets</a> to store objects in a single AZ.</p> \n<p>Starting today, S3 Express One Zone supports <a href=\"https://aws.amazon.com/cloudtrail/\">AWS CloudTrail</a> data event logging, allowing you to monitor all object-level operations like<em> <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutObject.html\">PutObject,</a></em> <em><a href=\"https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetObject.html\">GetObject</a></em>, and <em><a href=\"https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucket.html\">DeleteObject</a>,</em> in addition to <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/cloudtrail-logging-s3-info.html#:~:text=of%20a%20bucket.-,S3%20Express%20One%20Zone%20bucket%2Dlevel%20(Regional%20API%20endpoint)%20actions%20tracked%20by%20CloudTrail%20logging,-By%20default%2C%20CloudTrail\">bucket-level</a> actions like <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/API/API_CreateBucket.html\"><em>CreateBucket</em></a> and <em><a href=\"https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucket.html\">DeleteBucket</a> </em>that were already supported. This enables auditing for governance and compliance, and can help you take advantage of S3 Express One Zone’s 50% lower requests costs compared to the S3 Standard storage class.</p> \n<p>Using this new capability, you can quickly determine which S3 Express One Zone objects were created, read, updated, or deleted, and identify the source of the API calls. If you detect unauthorized S3 Express One Zone object access, you can take immediate action to restrict access. Additionally, you can use the <a href=\"https://docs.aws.amazon.com/eventbridge/latest/userguide/logging-using-cloudtrail.html\">CloudTrail integration</a> with <a href=\"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html\">Amazon EventBridge</a> to create rule-based workflows that are triggered by data events.</p> \n<p><span><strong>Using CloudTrail data event logging for Amazon S3 Express One Zone</strong></span><br /> I start in the <a href=\"https://console.aws.amazon.com/s3/\">Amazon S3 console</a>. Following the steps to <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/directory-bucket-create.html\">create a directory bucket</a>, I create an S3 bucket and choose<strong> Directory </strong>as the bucket type and <code>apne1-az4</code> as the <strong>Availability Zone.</strong> In <strong>Base Name</strong>, I enter <code>s3express-one-zone-cloudtrail</code> and a suffix that includes Availability Zone ID of the Availability Zone is automatically added to create the final name. Finally, I select the checkbox to acknowledge that <strong>Data is stored in a single Availability Zone</strong> and choose <strong>Create bucket</strong>.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/Screenshot-2024-07-05-at-1.06.22 PM-1.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/Screenshot-2024-07-05-at-1.06.22 PM-1-1024x591.png\" width=\"1024\" height=\"591\" /></a></p> \n<p>To enable data event logging for S3 Express One Zone, I go to the <a href=\"https://console.aws.amazon.com/cloudtrail/\">CloudTrail console</a>. I enter the name and <a href=\"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/tutorial-trail.html\">create the CloudTrail trail </a>responsible for tracking the events of my S3 directory bucket.<br /> <a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/ct_0.jpg\"><br /> <img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/ct_0.jpg\" width=\"803\" height=\"325\" /></a></p> \n<p>In <strong>Step 2: Choose log events, </strong>I select <strong>Data events</strong> with <strong>Advanced event selectors are enabled </strong>selected.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/step_1_a.jpg\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/step_1_a-1024x329.jpg\" width=\"1024\" height=\"329\" /></a></p> \n<p>For <strong>Data event type</strong>, I choose <strong>S3 Express</strong>. I can choose <strong>Log all events</strong> as the <strong>Log selector template </strong>to manage data events for all S3 directory buckets.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/03/cuatro.jpg\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/03/cuatro.jpg\" width=\"1021\" height=\"243\" /></a></p> \n<p>However, I want the event data store to log events only for my S3 directory bucket <code>s3express-one-zone-cloudtrail--apne1-az4--x-s3</code>. In this case, I choose <strong>Custom</strong> as the <strong>Log selector template</strong> and indicate the ARN of my directory bucket. Learn more in the documentation on <a href=\"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/filtering-data-events.html\">filtering data events by using advanced event selectors</a>.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/uno.jpg\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/uno-1024x371.jpg\" width=\"1024\" height=\"371\" /></a></p> \n<p>Finish up with <strong>Step 3: review and create. </strong>Now, you have logging with CloudTrail enabled.</p> \n<p><strong><span>CloudTrail data event logging for S3 Express One Zone in action:</span></strong><br /> Using the <a href=\"https://console.aws.amazon.com/s3/\">S3 console</a>, I upload and download a file to my S3 directory bucket.</p> \n<p><a href=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/Screenshot-2024-07-05-at-1.44.23 PM.png\"><img loading=\"lazy\" src=\"https://d2908q01vomqb2.cloudfront.net/da4b9237bacccdf19c0760cab7aec4a8359010b0/2024/07/08/Screenshot-2024-07-05-at-1.44.23 PM-1024x480.png\" width=\"1024\" height=\"480\" /></a></p> \n<p>Using AWS CLI, I send <code>Put_Object</code> and <code>Get_Object</code>.</p> \n<div> \n <pre><code>$ aws s3api put-object --bucket s3express-one-zone-cloudtrail--apne1-az4--x-s3 \\\n  --key cloudtrail_test  \\ \n--body cloudtrail_test.txt</code></pre> \n</div> \n<div> \n <pre><code>$ aws s3api get-object --bucket s3express-one-zone-cloudtrail--apne1-az4--x-s3 \\ \n--key cloudtrail_test response.txt</code></pre> \n</div> \n<p>CloudTrail publishes log files to S3 bucket in a gzip archive and organizes them <a href=\"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/get-and-view-cloudtrail-log-files.html#cloudtrail-find-log-files\">hierarchically based</a> on the bucket name, account ID, Region, and date. Using the AWS CLI, I list the bucket associated with my Trail and retrieve the log files for the date when I did the test.</p> \n<div> \n <pre><code>$ aws s3 ls s3://aws-cloudtrail-logs-MY-ACCOUNT-ID-3b49f368/AWSLogs/MY-ACCOUNT-ID/CloudTrail/ap-northeast-1/2024/07/01/</code></pre> \n</div> \n<p>I get the following four files name, two from the console tests and two from the CLI tests:</p> \n<div> \n <pre><code>2024-07-05 20:44:16 317 MY-ACCOUNT-ID_CloudTrail_ap-northeast-1_20240705T2044Z_lzCPfDRSf9OdkdC1.json.gz\n2024-07-05 20:47:36 387 MY-ACCOUNT-ID_CloudTrail_ap-northeast-1_20240705T2047Z_95RwiqAHCIrM9rcl.json.gz\n2024-07-05 21:37:48 373 MY-ACCOUNT-ID_CloudTrail_ap-northeast-1_20240705T2137Z_Xk17zhf0cTY0N5bH.json.gz\n2024-07-05 21:42:44 314 MY-ACCOUNT-ID_CloudTrail_ap-northeast-1_20240705T21415Z_dhyTsSb3ZeAhU6hR.json.gz</code></pre> \n</div> \n<p>Let’s search for the PutObject event among these files. When I open the first file, I can see the <code>PutObject</code> event type. If you recall, I just made two uploads, once via the S3 console in a browser and once using the CLI. The <code>userAgent</code> attribute, the type of source that made the API call, refers to a browser, so this event refers to my upload using the S3 console. Learn more about CloudTrail events in the documentation on <a href=\"https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-events.html\">understanding CloudTrail events</a>.</p> \n<div> \n <pre><code>{...},\n\"eventTime\": \"2024-07-05T20:44:16Z\",\n\"eventSource\": \"s3express.amazonaws.com\",\n\"eventName\": \"PutObject\",\n\"awsRegion\": \"ap-northeast-1\",\n\"sourceIPAddress\": \"MY-IP\",\n\"userAgent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36\",\n\"requestParameters\": {\n...\n},\n\"responseElements\": {...},\n\"additionalEventData\": {...},\n...\n\"resources\": [\n{\n\"type\": \"AWS::S3Express::Object\",\n\"ARN\": \"arn:aws:s3express:ap-northeast-1:MY-ACCOUNT-ID:bucket/s3express-one-zone-cloudtrail--apne1-az4--x-s3/cloudtrail_example.png\"\n},\n{\n\"accountId\": \"MY-ACCOUNT-ID\",\n\"type\": \"AWS::S3Express::DirectoryBucket\",\n\"ARN\": \"arn:aws:s3express:ap-northeast-1:MY-ACCOUNT-ID:bucket/s3express-one-zone-cloudtrail--apne1-az4--x-s3\"\n}\n],\n{...}</code></pre> \n</div> \n<p>Now, when I review the third file for the event corresponding to the <code>PutObject</code> command sent using AWS CLI, I see that there is a small difference in the <code>userAgent</code> attribute. In this case, it refers to the AWS CLI.</p> \n<div> \n <pre><code>{...},\n\"eventTime\": \"2024-07-05T21:37:19Z\",\n\"eventSource\": \"s3express.amazonaws.com\",\n\"eventName\": \"PutObject\",\n\"awsRegion\": \"ap-northeast-1\",\n\"sourceIPAddress\": \"MY-IP\",\n\"userAgent\": \"aws-cli/2.17.9 md/awscrt#0.20.11 ua/2.0 os/linux#5.10.218-208.862.amzn2.x86_64 md/arch#x86_64 lang/python#3.11.8 md/pyimpl#CPython cfg/retry-mode#standard md/installer#exe md/distrib#amzn.2 md/prompt#off md/command#s3api.put-object\",\n\"requestParameters\": {\n...\n},\n\"responseElements\": {...},\n\"additionalEventData\": {...},\n...\n\"resources\": [\n{\n\"type\": \"AWS::S3Express::Object\",\n\"ARN\": \"arn:aws:s3express:ap-northeast-1:MY-ACCOUNT-ID:bucket/s3express-one-zone-cloudtrail--apne1-az4--x-s3/cloudtrail_example.png\"\n},\n{\n\"accountId\": \"MY-ACCOUNT-ID\",\n\"type\": \"AWS::S3Express::DirectoryBucket\",\n\"ARN\": \"arn:aws:s3express:ap-northeast-1:MY-ACCOUNT-ID:bucket/s3express-one-zone-cloudtrail--apne1-az4--x-s3\"\n}\n],\n{...}\n</code></pre> \n</div> \n<p>Now, let’s look at the GetObject event in the second file. I can see that the event type is <code>GetObject</code> and that the <code>userAgent</code> refers to a browser, so this event refers to my download using the S3 console.</p> \n<div> \n <pre><code>{...},\n\"eventTime\": \"2024-07-05T20:47:41Z\",\n\"eventSource\": \"s3express.amazonaws.com\",\n\"eventName\": \"GetObject\",\n\"awsRegion\": \"ap-northeast-1\",\n\"sourceIPAddress\": \"MY-IP\",\n\"userAgent\": \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36\",\n\"requestParameters\": {\n...\n},\n\"responseElements\": {...},\n\"additionalEventData\": {...},\n...\n\"resources\": [\n{\n\"type\": \"AWS::S3Express::Object\",\n\"ARN\": \"arn:aws:s3express:ap-northeast-1:MY-ACCOUNT-ID:bucket/s3express-one-zone-cloudtrail--apne1-az4--x-s3/cloudtrail_example.png\"\n},\n{\n\"accountId\": \"MY-ACCOUNT-ID\",\n\"type\": \"AWS::S3Express::DirectoryBucket\",\n\"ARN\": \"arn:aws:s3express:ap-northeast-1:MY-ACCOUNT-ID:bucket/s3express-one-zone-cloudtrail--apne1-az4--x-s3\"\n}\n],\n{...}</code></pre> \n</div> \n<p>And finally, let me show the event in the fourth file, with details of the <code>GetObject</code> command that I sent from the AWS CLI. I can see that the <code>eventName</code> and <code>userAgent</code> are as expected.</p> \n<div> \n <pre><code>{...},\n\"eventTime\": \"2024-07-05T21:42:04Z\",\n\"eventSource\": \"s3express.amazonaws.com\",\n\"eventName\": \"GetObject\",\n\"awsRegion\": \"ap-northeast-1\",\n\"sourceIPAddress\": \"MY-IP\",\n\"userAgent\": \"aws-cli/2.17.9 md/awscrt#0.20.11 ua/2.0 os/linux#5.10.218-208.862.amzn2.x86_64 md/arch#x86_64 lang/python#3.11.8 md/pyimpl#CPython cfg/retry-mode#standard md/installer#exe md/distrib#amzn.2 md/prompt#off md/command#s3api.put-object\",\n\"requestParameters\": {\n...\n},\n\"responseElements\": {...},\n\"additionalEventData\": {...},\n...\n\"resources\": [\n{\n\"type\": \"AWS::S3Express::Object\",\n\"ARN\": \"arn:aws:s3express:ap-northeast-1:MY-ACCOUNT-ID:bucket/s3express-one-zone-cloudtrail--apne1-az4--x-s3/cloudtrail_example.png\"\n},\n{\n\"accountId\": \"MY-ACCOUNT-ID\",\n\"type\": \"AWS::S3Express::DirectoryBucket\",\n\"ARN\": \"arn:aws:s3express:ap-northeast-1:MY-ACCOUNT-ID:bucket/s3express-one-zone-cloudtrail--apne1-az4--x-s3\"\n}\n],\n{...}</code></pre> \n</div> \n<p><span><strong>Things to know</strong></span></p> \n<p><strong>Getting started</strong> – You can enable CloudTrail data event logging for S3 Express One Zone using the CloudTrail console, CLI, or SDKs.</p> \n<p><strong>Regions</strong> – CloudTrail data event logging is available in all <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-express-Endpoints.html\">AWS Regions where S3 Express One Zone is currently available</a>.</p> \n<p><strong>Activity logging</strong> – With CloudTrail data event logging for S3 Express One Zone, you can object-level activity, such as <code>PutObject</code>, <code>GetObject</code> , and <code>DeleteObject</code>, as well as bucket-level activity, such as CreateBucket and DeleteBucket.</p> \n<p><strong>Pricing</strong> – As with S3 storage classes, you pay for logging S3 Express One Zone data events in CloudTrail based on the number of events logged and the period during which you retain the logs. For more information, see the <a href=\"https://aws.amazon.com/cloudtrail/pricing/\">AWS CloudTrail Pricing</a> page.</p> \n<p>You can enable CloudTrail data event logging for S3 Express One Zone to simplify governance and compliance for your high-performance storage. To learn more about this new capability, visit the <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/cloudtrail-logging.html\">S3 User Guide</a><a href=\"https://aws.amazon.com/s3/storage-classes/express-one-zone/\">.</a></p> \n<p>– <a href=\"https://www.linkedin.com/in/lizfue/\">Eli.</a></p>","author":"Elizabeth Fuentes","siteTitle":"AWS News Blog","siteHash":"6093e072e4117ec22616e844cb857d03ca62c57a411a8affc77cb5e8b6b15bf6","entryHash":"567f7edee26886e79ec9715c41a5445ab288c5af2094cc0e9d8a171b369e8bd6","category":"Tech"}