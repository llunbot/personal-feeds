{"title":"มาลองใช้งาน Queue ใน Apache Kafka 4.0","link":"https://www.somkiat.cc/working-queue-in-kafka/","date":1746002136000,"content":"<p><img width=\"150\" height=\"150\" src=\"https://www.somkiat.cc/wp-content/uploads/2025/04/kafka-queue-01-150x150.jpg\" alt=\"\" loading=\"lazy\" srcset=\"https://www.somkiat.cc/wp-content/uploads/2025/04/kafka-queue-01-150x150.jpg 150w, https://www.somkiat.cc/wp-content/uploads/2025/04/kafka-queue-01-75x75.jpg 75w\" /></p>\n<figure><a href=\"https://www.somkiat.cc/wp-content/uploads/2025/04/kafka-queue-01.jpg\"><img src=\"https://www.somkiat.cc/wp-content/uploads/2025/04/kafka-queue-01.jpg\" alt=\"\" width=\"529\" height=\"360\" /></a></figure>\n\n\n\n<p>ทาง <strong><a href=\"https://www.somkiat.cc/apache-kafka-4/\" target=\"_blank\">Apache Kafka 4.0</a></strong> เพิ่งปล่อยออกมา<br />ซึ่งเพิ่ม Queue เข้ามาให้ลองใช้ด้วย (early access เท่านั้น)<br />เคยเขียนอธิบายไว้แล้วที่ <strong><a href=\"https://www.somkiat.cc/kip-932-queues-for-kafka/\">น่าสนใจสำหรับ KIP-932: Queues for Kafka</a></strong><br />ดังนั้นเรามาลองใช้งานกันหน่อยว่าเป็นอย่างไร<br />มาเริ่มกันเลย</p>\n\n\n\n<span></span>\n\n\n\n<figure><a href=\"https://www.somkiat.cc/wp-content/uploads/2025/04/kafka-queue-share-group.jpg\"><img src=\"https://www.somkiat.cc/wp-content/uploads/2025/04/kafka-queue-share-group-1024x489.jpg\" alt=\"\" width=\"627\" height=\"299\" /></a></figure>\n\n\n\n<p>โดยจะใช้สิ่งที่เรียกว่า <strong>share group</strong><br />ไว้จัดการข้อมูลจาก topic อีกรอบ<br />มองดูแล้วอาจจะคล้ายกัย consumer group แต่ไม่เหมือนกัน<br />นั่นคือ<br />consumer ต่าง ๆ ใน share group นั้น<br />สามารถ process ข้อมูลจาก topic เดียวกัน และ partition เดียวกันได้<br />นั่นคือสามารถมี active consumer มากกว่าจำนวน partition ของ topic นั้น ๆ  ได้</p>\n\n\n\n<p>โดยที่ consumer ต่าง ๆ ที่อยู่ใน share group เดียวกัน<br />จะใช้ consumer rebalance protocol ใหม่จาก <a href=\"https://cwiki.apache.org/confluence/display/KAFKA/KIP-848%3A+The+Next+Generation+of+the+Consumer+Rebalance+Protocol\" target=\"_blank\">KIP-898</a><br />ซึ่งจะเรียก partition ที่ใช้งานของ share group ว่า <strong>share partition</strong></p>\n\n\n\n<p>มาลองเขียน code ใช้งานกันดีกว่า</p>\n\n\n\n<p>โดยที่ client library ภาษาต่าง ๆ ยังไม่ support<br />เลยใช้ภาษา Java ซึ่งเป็น official ที่สนับสนุนแล้ว (ใน <a href=\"https://github.com/spring-projects/spring-kafka/issues/3875\" target=\"_blank\">Spring for Kafka</a> ยังไม่สนับสนุน)</p>\n\n\n\n<p><strong>ขั้นตอนที่ 1 ทำการ Start Kafka Broker</strong></p>\n\n\n\n<p>ทำการเปิดการใช้งาน experiment feature และ share group ดังนี้</p>\n\n\n\n[gist id=\"88843666d99193ce90dbc9795af330e4\" file=\"1.txt\"]\n\n\n\n<p>ทำการ start server ขึ้นมา จะแจ้งว่าสิ่งที่ใช้งานคือ KIP-932 <br />อย่าใช้บน production !!</p>\n\n\n\n[gist id=\"88843666d99193ce90dbc9795af330e4\" file=\"2.txt\"]\n\n\n\n<p><strong>ขั้นตอนที่ 2 ทำการสร้าง Consumer เพื่อใช้งาน Queue หรือ share group</strong></p>\n\n\n\n<p>โดยใช้งาน Java Kafka client มีตัวอย่างของการใช้งานผ่าน Apache Maven</p>\n\n\n\n[gist id=\"88843666d99193ce90dbc9795af330e4\" file=\"pom.xml\"]\n\n\n\n<p>จากนั้นเขียน consumer ขึ้นมา ซึ่งกำหนดค่าต่าง ๆ  ดังนี้</p>\n\n\n\n<ul>\n<li><strong>group.id</strong> คือ share group นั่นเอง ซึ่ง message ใน topic ที่กำหนดไว้ จะเข้ามาเรียงคิวที่ group นี้ให้เอง</li>\n</ul>\n\n\n\n[gist id=\"88843666d99193ce90dbc9795af330e4\" file=\"Demo.java\"]\n\n\n\n<p>ผลการทำงานของ consumer เป็นดังนี้</p>\n\n\n\n[gist id=\"88843666d99193ce90dbc9795af330e4\" file=\"3.txt\"]\n\n\n\n<p>สามารถตรวจสอบได้ว่า ตอนนี้มี share group อะไรบ้าง<br />และมี offset ค่าเท่าไร <br />และ share group นั้นมากี่ partition<br />ส่วนฝั่งของ producer ไม่ได้เปลี่ยนอะไร ส่ง message ไปยัง topic ที่ต้องการปกติ</p>\n\n\n\n[gist id=\"88843666d99193ce90dbc9795af330e4\" file=\"4.txt\"]\n\n\n\n<p>เพียงเท่านี้ก็สามารถใช้งาน Queue ใน Kafka ได้แล้ว<br />ซึ่งแนวทางนี้ก็ต้องระวังเรื่องของท่อตันด้วย<br />ถ้ามีบาง message ทำงานใน consumer ช้า หรือ ใช้เวลานาน !!<br />ลองเล่นกันดู</p>\n\n\n\n<p><strong>Reference Websites</strong></p>\n\n\n\n<ul>\n<li><a href=\"https://cwiki.apache.org/confluence/display/KAFKA/KIP-932%3A+Queues+for+Kafka\" target=\"_blank\">KIP-932: Queues for Kafka</a></li>\n\n\n\n<li><a href=\"https://www.morling.dev/blog/kip-932-queues-for-kafka/\" target=\"_blank\">Let's Take a Look at... KIP-932: Queues for Kafka!</a></li>\n</ul>\n","author":"somkiat","siteTitle":"cc :: somkiat","siteHash":"3a23a5a4389e1e40c6fbb16520a8cc20df5b3591c25145ce72aaa18b19e48201","entryHash":"bbca70025ca85d9175ae2694f408019742160a96ed747c663cb0bc3f58281d11","category":"Thai"}