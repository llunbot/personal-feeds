{"title":"[AWS-IoT] เรียกใช้ AWS Services ผ่าน Device Certificate X.509 โดยใช้ Credential-Provider [1]","link":"https://thanapon.info/aws-iot-credential-provider/?utm_source=rss&utm_medium=rss&utm_campaign=aws-iot-credential-provider","date":1673136000000,"content":"<p>เป็นที่รู้กันอยู่แล้วนะครับว่าถ้าเราจะเชื่อมต่ออุปกรณ์เข้าไปที่ AWS IoT Core service นั้นเราจะใช้ X.509 certificates ผ่าน MQTT with TLS [MQTTs] ไปที่ AWS อีกที</p>\n\n\n\n<p>ปกติถ้าเราเชื่อมต่อเข้าไปที่ AWS IoT Core นั้นเราจะต้องมี 3 Component ด้วยกันคือ</p>\n\n\n\n<ul>\n<li>Root CA ของ AWS</li>\n\n\n\n<li>Private key</li>\n\n\n\n<li>Client device certificate</li>\n</ul>\n\n\n\n<p>ซึ่งผมก็เกิดคำถามที่ว่า อ่าว!! แล้วถ้าเราจะไปคุยกับ Service อื่นหล่ะต้องทำยังไง? หรือว่าเราสามารถ Generate AWS credentials ที่มี Access token กับ Secret token ออกมาแล้วเอาไปยัดใส่ใน Firmware ได้เลยน้าา ซึ่งมันก็ทำได้เหมือนกันหล่ะ แต่!!!!! ปัญหาต่อไปน่าจะอยู่ที่เรื่อง Security กับ Key-Rotate แล้วหล่ะ เพราะถ้าหากวันหนึ่ง Key นั้นเกิดหลุดออกไป เราต้องไล่เปลี่ยน Key ให้กับอุปกรณ์เราทั้งหมดเลยหรอ ดูเหมือนจะเป็นเรื่องยากเหมือนกันนะ ถึงแม้จะใช้ OTA [over-the-air update] แล้วก็เถอะ</p>\n\n\n\n<figure><img loading=\"lazy\" width=\"1007\" height=\"729\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image.png 1007w, https://thanapon.info/wp-content/uploads/2023/01/image-300x217.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-768x556.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-600x434.png 600w\" /></figure>\n\n\n\n<p>สุดท้ายหลังจากค้นหาก็เจอ Solution หนึ่งที่คิดว่าเป็น Best-practics ที่ดีเลยคือ AWS services นั้นสามารถเรียกได้โดยใช้ <a href=\"https://docs.aws.amazon.com/general/latest/gr/signature-version-4.html\" target=\"_blank\">AWS Signature Version 4 format</a> ซึ่งเป็นวิธีการ Authorization รูปแบบหนึ่งภายใน AWS services นั้นหล่ะ โดยมันจะใช้ Access token, Secret token ละก็ Session token ในการสร้าง AWS Request ชุดหนึ่งขึ้นมาเอาไว้แปะไปกับ Header ตอนเรียกใช้งาน AWS Service นั้นๆ</p>\n\n\n\n<p>โดยที่ Token ทั้ง 3 ตัวนั้นเราสามารถเรียกมาได้ยังไงหรอ??? คำตอบก็คือเราสามารถดึง Token พวกนี้ผ่าน <strong>Credential Provider</strong> ของ AWS IoT Core ได้เลยโดยที่เราใช้แค่ Device Certificate แบบ X.509 เหมือนเดิมทุกอย่างเลย</p>\n\n\n\n<blockquote>\n<p>การใช้ Credential Provider นั้นเราสามารถกำหนด Role ของ Token ด้วยโดยใช้ Assume role ใน AWS IoT Core กับ IAM ว่าจะให้มี Permission ในการ Access service อะไรได้บ้าง โดยที่ Token ที่เราได้รับมาก็จะมีอายุของมันด้วยนะ</p>\n</blockquote>\n\n\n\n<hr />\n\n\n\n<h2>สาธยายมาเยอะและเริ่มเลยละกันครับ</h2>\n\n\n\n<ul>\n<li>เริ่มต้นเราต้องมี Root CA, Private Key และ Device Certificate ก่อนซึ่งจะถูก Generate มาจาก AWS IoT Core ตอนที่เราสร้างแรกๆเลย</li>\n</ul>\n\n\n<div>\n<figure><img loading=\"lazy\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-1-821x1024.png\" alt=\"\" width=\"411\" height=\"512\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-1-821x1024.png 821w, https://thanapon.info/wp-content/uploads/2023/01/image-1-241x300.png 241w, https://thanapon.info/wp-content/uploads/2023/01/image-1-768x958.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-1-600x748.png 600w, https://thanapon.info/wp-content/uploads/2023/01/image-1.png 1198w\" /></figure></div>\n\n\n<ul>\n<li>หลังจากที่ได้ Device certiifcate แล้วเราก็ต้องไปหา Endpoint ของ Credential-provider ของ AWS IoT Core ของเราอีกทีโดยใช้ AWS CLI ในการเรียก Endpoint นั้นๆ</li>\n</ul>\n\n\n\n<div><pre><code>aws iot describe-endpoint --endpoint-type iot:CredentialProvider</code></pre></div>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"259\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-2-1024x259.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-2-1024x259.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-2-300x76.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-2-768x194.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-2-1536x388.png 1536w, https://thanapon.info/wp-content/uploads/2023/01/image-2-600x152.png 600w, https://thanapon.info/wp-content/uploads/2023/01/image-2.png 1726w\" /></figure>\n\n\n\n<ul>\n<li>สร้าง Policy ใน IAM ก่อนเพื่อกำหนดว่า Token นี้เราจะให้ Access service อะไรได้บ้าง</li>\n</ul>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"490\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-4-1024x490.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-4-1024x490.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-4-300x143.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-4-768x367.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-4-1536x734.png 1536w, https://thanapon.info/wp-content/uploads/2023/01/image-4-2048x979.png 2048w, https://thanapon.info/wp-content/uploads/2023/01/image-4-600x287.png 600w\" /></figure>\n\n\n\n<blockquote>\n<p>จากตัวอย่างผมจะให้อุปกรณ์ของผมสามารถ Access ไปที่ S3 ได้ดังนั้นต้องไปสร้าง Policy ก่อนแล้วค่อย Attach policy เข้ามาใน Role อีกที</p>\n</blockquote>\n\n\n\n<ul>\n<li>สร้าง Role ขึ้นมาใหม่ในหน้า IAM Console เสร็จแล้วก็ Attach policy เข้าไปได้เลย<strong><mark> อย่าลืมเพิ่ม Trust policy เข้าไปด้วยนะ</mark></strong></li>\n</ul>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"517\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-6-1024x517.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-6-1024x517.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-6-300x152.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-6-768x388.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-6-1536x776.png 1536w, https://thanapon.info/wp-content/uploads/2023/01/image-6-2048x1035.png 2048w, https://thanapon.info/wp-content/uploads/2023/01/image-6-600x303.png 600w\" /></figure>\n\n\n\n<div><pre><code>{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"Service\": \"credentials.iot.amazonaws.com\"\n            },\n            \"Action\": \"sts:AssumeRole\"\n        }\n    ]\n}</code></pre></div>\n\n\n\n<ul>\n<li>เสร็จแล้วเราจะได้ Role ที่มีสิทธิ์ในการ Access S3 มาแล้ว</li>\n</ul>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"503\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-3-1024x503.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-3-1024x503.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-3-300x147.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-3-768x377.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-3-1536x755.png 1536w, https://thanapon.info/wp-content/uploads/2023/01/image-3-2048x1006.png 2048w, https://thanapon.info/wp-content/uploads/2023/01/image-3-600x295.png 600w\" /></figure>\n\n\n\n<ul>\n<li>จากนั้นกลับไปที่ AWS IoT Core เพื่อทำการสร้าง Role aliases สำหรับ Authen S3</li>\n</ul>\n\n\n\n<blockquote>\n<p>Credential duration คือ token จะ expire กี่วินาทีหลังจากที่เราสร้างขึ้นมาผ่าน Credential provider</p>\n</blockquote>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"489\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-7-1024x489.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-7-1024x489.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-7-300x143.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-7-768x367.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-7-1536x733.png 1536w, https://thanapon.info/wp-content/uploads/2023/01/image-7-2048x978.png 2048w, https://thanapon.info/wp-content/uploads/2023/01/image-7-600x286.png 600w\" /></figure>\n\n\n\n<ul>\n<li>ไปที่ Security &gt; Policies เพื่อสร้าง Policy สำหรับเรียกใช้ Role Aliases ที่สร้างมาก่อนหน้านี้ให้กับ Device</li>\n</ul>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"450\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-8-1024x450.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-8-1024x450.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-8-300x132.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-8-768x337.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-8-1536x675.png 1536w, https://thanapon.info/wp-content/uploads/2023/01/image-8-2048x899.png 2048w, https://thanapon.info/wp-content/uploads/2023/01/image-8-600x264.png 600w\" /></figure>\n\n\n\n<ul>\n<li>กลับไปที่ Things ของเราก่อน เลือก Certificate tab แล้วเลือก CertificateID</li>\n</ul>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"458\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-9-1024x458.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-9-1024x458.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-9-300x134.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-9-768x343.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-9-1536x687.png 1536w, https://thanapon.info/wp-content/uploads/2023/01/image-9-2048x916.png 2048w, https://thanapon.info/wp-content/uploads/2023/01/image-9-600x268.png 600w\" /></figure>\n\n\n\n<ul>\n<li>Attact policies ชื่อ <strong>AssumeRoleWithCertificate</strong> เข้าไปเลย</li>\n</ul>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"233\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-10-1024x233.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-10-1024x233.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-10-300x68.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-10-768x175.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-10-1536x350.png 1536w, https://thanapon.info/wp-content/uploads/2023/01/image-10-2048x467.png 2048w, https://thanapon.info/wp-content/uploads/2023/01/image-10-600x137.png 600w\" /></figure>\n\n\n\n<h2>ทดสอบ Curl ผ่านสักหน่อยว่าสามารถเรียกได้ไหม</h2>\n\n\n\n<div><pre><code>curl --cert &lt;CERTIFICATE.crt&gt; --key &lt;PRIVATE-KEY.key&gt; -H \"x-amzn-iot-thingname: &lt;THINGS-NAME&gt;\" --cacert AmazonRootCA1.pem https://&lt;ENDPOINT&gt;/role-aliases/&lt;ROLE-ALIAS&gt;/credentials</code></pre></div>\n\n\n\n<blockquote>\n<p><strong>CERTIFICATE.crt</strong>: Device Certificate ที่ได้จากการสร้าง Things</p>\n\n\n\n<p><strong>PRIVATE-KEY.key</strong>: Private Key ที่ได้จากการสร้าง Things</p>\n\n\n\n<p><strong>THINGS-NAME</strong>: ชื่อ Thing</p>\n\n\n\n<p><strong>ENDPOINT</strong>: Endpoint ของ Credential provider</p>\n\n\n\n<p><strong>ROLE-ALIAS</strong>: Role alias ที่สร้างไว้ก่อนหน้านี้</p>\n</blockquote>\n\n\n\n<h2>Result:</h2>\n\n\n\n<figure><img loading=\"lazy\" width=\"1024\" height=\"481\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-12-1024x481.png\" alt=\"\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-12-1024x481.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-12-300x141.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-12-768x361.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-12-600x282.png 600w, https://thanapon.info/wp-content/uploads/2023/01/image-12.png 1438w\" /></figure>\n\n\n\n<p>จากนั้นเราก็สามารถนำ AccessKeyId, SecretAccessKey และ SessionToken ไปใช้ต่อสำหรับสร้าง AWS Signature V4 ซึ่งผมขอยกไปเป็นอีกหนึ่งบทความนะครับ หวังว่าบทความนี้จะมีประโยชน์สำหรับนักพัฒนาบน AWS IoT Core นะครับ ส่วนการใช้งานผ่าน Arduino เดี๋ยวจะพยายามเขียนเพิ่มในบทความหน้าให้นะครับ</p>\n\n\n\n<p>สำหรับวันนี้ขอบคุณและสวัสดีปีใหม่ 2566 ครับ <img src=\"https://s.w.org/images/core/emoji/15.0.3/72x72/1f386.png\" alt=\"🎆\" /><img src=\"https://s.w.org/images/core/emoji/15.0.3/72x72/1f386.png\" alt=\"🎆\" /><img src=\"https://s.w.org/images/core/emoji/15.0.3/72x72/1f386.png\" alt=\"🎆\" /><img src=\"https://s.w.org/images/core/emoji/15.0.3/72x72/1f386.png\" alt=\"🎆\" /><img src=\"https://s.w.org/images/core/emoji/15.0.3/72x72/1f387.png\" alt=\"🎇\" /><img src=\"https://s.w.org/images/core/emoji/15.0.3/72x72/1f387.png\" alt=\"🎇\" /></p>\n\n\n<div>\n<figure><img loading=\"lazy\" src=\"http://thanapon.info/wp-content/uploads/2023/01/image-13-1024x576.png\" alt=\"\" width=\"512\" height=\"288\" srcset=\"https://thanapon.info/wp-content/uploads/2023/01/image-13-1024x576.png 1024w, https://thanapon.info/wp-content/uploads/2023/01/image-13-300x169.png 300w, https://thanapon.info/wp-content/uploads/2023/01/image-13-768x432.png 768w, https://thanapon.info/wp-content/uploads/2023/01/image-13-600x338.png 600w, https://thanapon.info/wp-content/uploads/2023/01/image-13.png 1280w\" /></figure></div>\n\n\n<blockquote>\n<p><a href=\"https://docs.aws.amazon.com/iot/latest/developerguide/authorizing-direct-aws.html\" target=\"_blank\">https://docs.aws.amazon.com/iot/latest/developerguide/authorizing-direct-aws.html</a></p>\n<cite>Authorizing direct calls to AWS services using AWS IoT Core credential provider</cite></blockquote><p>The post <a href=\"https://thanapon.info/aws-iot-credential-provider/\">[AWS-IoT] เรียกใช้ AWS Services ผ่าน Device Certificate X.509 โดยใช้ Credential-Provider [1]</a> first appeared on <a href=\"https://thanapon.info\">Thanapon</a>.</p>","author":"thanapon.tap","siteTitle":"Thanapon","siteHash":"6a039c2f54d76e4c49227d80968f2a30de5427cc57525c047c383ea3563cde5f","entryHash":"7d8709b6d8458b68cf70743fb1d6d50feebd0d45fc103b1cdd14ab2bb9ffc252","category":"Thai"}