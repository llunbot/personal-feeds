{"title":"Creating a multi-cloud golden image pipeline with Terraform Cloud and HCP Packer","link":"https://www.hashicorp.com/blog/multicloud-golden-image-pipeline-terraform-cloud-hcp-packer","date":1695052800000,"content":"<p>In today’s multi-cloud world, images (such as <a href=\"https://en.wikipedia.org/wiki/Amazon_Machine_Image\">AMIs</a> for Amazon EC2, virtual machines, Docker containers, and more) lay the foundation for modern infrastructure, security, networking, and applications. Enterprises adopting multi-cloud typically start by using Terraform for centralized provisioning, but Terraform does not handle the details of image creation and management. </p>\n\n<p>In many organizations, the workflows in place to create and manage images are siloed, time-consuming, and complex, leading to slow spin-up times and human errors that pose security risks. Organizations need standard processes to ensure all images throughout their infrastructure estate are secure, compliant, and easily accessible.</p>\n\n<p><em>To learn more about building a golden image pipeline with Terraform Cloud and HCP Packer, check out the white paper: <a href=\"https://www.hashicorp.com/on-demand/unlocking-your-cloud-operating-model-image-management\">Unlocking your cloud operating model: image management</a></em></p>\n\n<h3>Image management challenges</h3>\n\n<p>As organizations deploy fleets of images to support services across cloud and private environments, the complexity and scope of these services often involve multiple different teams. Without consistent, central processes and tooling in place, organizations can experience variability in their image workflows creating several challenges:</p>\n\n<ul>\n<li><strong>Inconsistencies:</strong> With different image practices, teams are prone to achieve different outcomes with varying levels of infrastructure performance. </li>\n<li><strong>Risks:</strong> Manual, checklist-driven procedures to apply security standards lead to human error in the form of misconfigured and insecure images that can introduce security threats to the organization and result in outages.</li>\n<li><strong>Delays:</strong> Teams may duplicate efforts and spend excessive time manually building images for different environments, increasing time to deployment.</li>\n</ul>\n\n<p>To combat these issues, organizations and their platform teams need to establish a central shared service for their image creation and management workflows.</p>\n\n<h3>Solution: Creating a golden image pipeline</h3>\n\n<p>Implementing a <a href=\"https://developer.hashicorp.com/packer/tutorials/cloud-production/golden-image-with-hcp-packer\">golden image pipeline</a> with <a href=\"https://developer.hashicorp.com/terraform/cloud-docs\">Terraform Cloud </a>with <a href=\"https://developer.hashicorp.com/hcp/docs/packer\">HCP Packer</a> unifies provisioning and image workflows to shift security left and automate image management across downstream builds and provisioning pipelines. HCP Packer helps platform teams establish a unified workflow management system across groups within an organization. This provides policy and governance, organization-wide visibility, ease of integration with peripheral technologies, and overall reliability at scale. </p>\n\n<p>By integrating HCP Packer into their Terraform Cloud workflows, organizations can:</p>\n\n<ol>\n<li>Standardize image creation and ensure all builds deployed are secure and compliant </li>\n<li>Track all image builds and associated metadata in a central artifact registry </li>\n<li>Automate provisioning pipelines and continuously monitor infrastructure health</li>\n<li>Simplify image lifecycle management </li>\n</ol>\n<img src=\"https://www.datocms-assets.com/2885/1693935945-screenshot-2023-09-05-at-1-35-33-pm.png\" alt=\"Golden\" /><h3>Step 1. Standardize image creation with Packer</h3>\n\n<p>The first step in creating a golden image pipeline is to create a set of golden images with <a href=\"https://www.packer.io/\">HashiCorp Packer</a>. A “golden image” is an approved image that acts as a template on top of which developers can build applications. These images contain the most up-to-date common system packages, logging and monitoring tools, security patches, and configuration hardening. Packer simplifies golden image creation by enabling organizations to leverage the HashiCorp Configuration Language (HCL). HCL simplifies the process of embedding all organizational requirements —such as security and operational details — into golden images. Codification also enables collaboration; changes can be reviewed by the appropriate stakeholders using standard version-control workflows before being implemented.</p>\n\n<p>Packer configurations are defined using <a href=\"https://developer.hashicorp.com/packer/docs/templates\">templates</a> that enable users to leverage common configurations across multiple image builds. Templates consist of a series of declarations and commands for Packer to follow when generating a new image build. The template specifies what <a href=\"https://developer.hashicorp.com/packer/docs/plugins\">plugins</a> (builders, data sources, provisioners, post-processors) to use, how to configure each of those plugins, and in what order to run them.</p>\n<img src=\"https://www.datocms-assets.com/2885/1693932997-image-12.png\" alt=\"The\" /><h3>Step 2. Track images at scale in the HCP Packer artifact registry</h3>\n\n<p>When a new golden image is created, this new version is automatically published to <a href=\"https://developer.hashicorp.com/hcp/docs/packer\">HCP Packer</a> by including a simple <a href=\"https://developer.hashicorp.com/packer/docs/templates/hcl_templates/blocks/build/hcp_packer_registry\"><code>hcp_packer_registry</code> block</a> in the template. HCP Packer serves as a managed registry that stores image metadata, including when they were created, the associated cloud provider, and any custom labels specified in your image build. The HCP Packer artifact registry helps you track information about images, clearly designate which versions are approved for consumption, and query the right images to use in both Packer and Terraform configurations. Access to this centralized library helps align the workflows of image creation and deployment, allowing operations and development teams to work together to manage, track, and govern all artifacts across your infrastructure estate.</p>\n\n<h4>Manage images with channels</h4>\n\n<p>A core feature of HCP Packer that enables collaboration across teams is image channels. With channels, you can label image versions to describe the quality and stability of a build. By assigning human-readable names, downstream consumers can easily <a href=\"https://developer.hashicorp.com/hcp/docs/packer/reference-image-metadata\">reference the images in Packer templates and Terraform configurations</a>. For example, you can designate a specific channel for testing, allowing users to promote new versions and quickly spin up an instance to validate the image. Once the new version passes the required tests, it can be promoted to the stable channel, alerting downstream consumers that it is approved and ready for deployment. This workflow provides teams with vetted, ready-built artifacts that supply standard services in a plug-and-play fashion. Consumers can tailor versions of artifacts to streamline their efforts in the updating and release stages and ensure they are referencing the latest version without having to update their code directly. This image promotion workflow can also be automated in a declarative fashion using the <a href=\"https://registry.terraform.io/providers/hashicorp/hcp/latest\">HCP provider for Terraform</a>.</p>\n<img src=\"https://www.datocms-assets.com/2885/1693933113-image-13.png\" alt=\"Reference\" /><h3>Step 3. Automate provisioning and monitor health with Terraform Cloud</h3>\n\n<p>With a golden image built, published, validated, and promoted to your organization's stable channel, Terraform runs referencing the updated version can now be queued automatically for any workspace using the channel. The image updates across downstream provisioning pipelines can take place autonomously with auto-apply settings or be gated by manual approval processes. The <a href=\"https://developer.hashicorp.com/packer/tutorials/hcp/setup-tfc-run-task\">Terraform Cloud run task for HCP Packer</a> helps prevent the deployment of non-approved images with:</p>\n\n<ul>\n<li><strong>Data source image validation</strong> to scan your Terraform plan for references to the HCP Packer iteration and image data sources, warning you or blocking the run if any referenced data is associated with a revoked image version</li>\n<li><strong>Resource image validation</strong> to scan your Terraform configuration for resources that use hard-coded machine image IDs and check if the image is tracked by HCP Packer. It will also warn users if the image is associated with a revoked iteration and prompt them to reference the HCP Packer data source instead for better tracking and management capabilities</li>\n</ul>\n\n<p>With this automation, teams can integrate images easily onto a larger workflow framework to complement automated delivery pipelines. </p>\n<img src=\"https://www.datocms-assets.com/2885/1693933203-image-14.png\" alt=\"Reference\" /><h4>Drift detection and continuous validation</h4>\n\n<p>With the new image version successfully approved and provisioned, the next step is to perform <a href=\"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/health\">health assessments</a> to make sure this infrastructure doesn't change over time. Even with a standardized initial provisioning process, settings on infrastructure can still be modified or circumvented, opening up your infrastructure to the possibility of configuration drift. Drift is the term for when the real-world state of your infrastructure differs from the state defined in your configuration. Drift occurs when a user modifies resources outside of the Terraform workflow.  </p>\n\n<p>Terraform Cloud’s <a href=\"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/health#drift-detection\">drift detection</a> allows users to actively monitor their infrastructure for these changes and receive alerts when they take place. From the health assessments dashboard they can quickly uncover the root cause for the change, determine if it is necessary, and accept it or automatically remediate if not.</p>\n<img src=\"https://www.datocms-assets.com/2885/1693934100-drift-packer.png\" alt=\"View\" /><p>Terraform Cloud can also perform health checks for custom conditions and assertions with <a href=\"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/health#continuous-validation\">continuous validation</a>. Users can monitor whether the functional validations defined in Terraform code continue to pass over time and receive an alert when an assertion fails. For example, you can monitor whether your website returns an expected status code, whether an API gateway certificate is valid, or whether the image artifact referenced from an HCP Packer channel is too old or has a scheduled revocation.</p>\n<img src=\"https://www.datocms-assets.com/2885/1693933621-cv-checks-packer.png\" alt=\"Validate\" /><p>These two features provide users with flexible options to validate their infrastructure uptime, health, and security — all in one place without requiring additional tools. </p>\n\n<h3>Step 4. Manage image lifecycles</h3>\n\n<p>If one of your golden images is outdated or possesses a vulnerability, you may need to revoke it to prevent infrastructure deployments from using it. HCP Packer and Terraform Cloud help provide a unified and simple revocation workflow across downstream builds and provisioning pipelines. When a golden image version is updated in an HCP Packer channel, any deployments using that image are simply re-run to pick up the new association. HCP Packer offers this simplified revocation workflow through the following:</p>\n\n<ol>\n<li><strong>Scheduled revocation</strong>: Plan revocation for a future end-of-life date or revoke the image version immediately</li>\n<li><strong>Inherited revocation</strong>:  Builds on HCP Packer’s image ancestry tracking and established parent/child relationship to revoke just the base golden image or all associated downstream images</li>\n<li><strong>Channel rollback</strong>: Uses channel assignment history to provide quicker remediation of released artifacts by providing the option to roll back channels to their previously assigned iteration</li>\n</ol>\n<img src=\"https://www.datocms-assets.com/2885/1693935874-screenshot-2023-09-05-at-1-35-03-pm.png\" alt=\"Simplify\" /><h3>Business impact</h3>\n\n<p>Integrating HCP Packer’s image management capabilities into existing Terraform Cloud workflows brings a number of key benefits:</p>\n\n<h4>Lower risk</h4>\n\n<p><strong>Never deploy insecure images</strong>: Embed security and compliance requirements into all images across your cloud environments, set EOL dates, and automate revocation. </p>\n\n<h4>Faster speed</h4>\n\n<p><strong>Decrease time to deployment</strong>: Speed deployment by creating and reusing images from a single source configuration file, connecting to VCS, and collaborating across teams.</p>\n\n<h4>Increased efficiency</h4>\n\n<p><strong>Automate image management</strong>: Standardize image versions, change a golden image once, and automatically update across downstream builds.</p>\n\n<h3>Better together</h3>\n\n<p>Using Terraform Cloud and HCP Packer together can help users achieve a standardized and efficient approach to their provisioning workflows. By following the steps outlined in this post, organizations can simplify their multi-cloud imaging processes leading to faster spin-up times, reduced human errors, and secure management of their entire infrastructure estate.</p>\n\n<p>To learn more about building a golden image pipeline with Terraform Cloud and HCP Packer, check out the <a href=\"https://www.hashicorp.com/on-demand/unlocking-your-cloud-operating-model-image-management\">image management whitepaper</a>, <a href=\"https://developer.hashicorp.com/packer/tutorials/cloud-production/golden-image-with-hcp-packer\">tutorial</a>, and <a href=\"https://www.hashicorp.com/resources/hcp-packer-learn-lab-build-a-golden-image-pipeline\">learn lab</a>.</p>\n\n<p>Get started with <a href=\"https://cloud.hashicorp.com/products/terraform\">Terraform Cloud</a> and​​ <a href=\"https://www.hashicorp.com/products/packer\">HCP Packer</a> for free to begin provisioning and managing your infrastructure in any environment.</p>\n","author":"Mitchell Ross","siteTitle":"HashiCorp Blog","siteHash":"219aa6310b3388f2335eba49871f4df9581f2c58eaeb5e498363b54e835b7001","entryHash":"0543f2eb20ed42add94d430f302524920516044a916885fa07cea4c243616334","category":"Tech"}